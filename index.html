<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>王秦勇的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="王秦勇的博客">
<meta property="og:url" content="https://github.com/wangqinyong1994/blog/index.html">
<meta property="og:site_name" content="王秦勇的博客">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="王秦勇的博客">
  
    <link rel="alternate" href="/blog/atom.xml" title="王秦勇的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blog/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">王秦勇的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/blog/" id="subtitle">记录一下</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/wangqinyong1994/blog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-测试相关" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2021/03/26/测试相关/" class="article-date">
  <time datetime="2021-03-26T08:08:52.000Z" itemprop="datePublished">2021-03-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2021/03/26/测试相关/">测试相关</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2021/03/26/测试相关/" data-id="ckonxihv4000tttyz2798mesy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/测试/">测试</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-headless-chrome" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2021/03/24/headless-chrome/" class="article-date">
  <time datetime="2021-03-24T13:25:22.000Z" itemprop="datePublished">2021-03-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2021/03/24/headless-chrome/">headless chrome</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- TODO: -->

<p><a href="https://juejin.cn/post/6844903545355894797#heading-7" target="_blank" rel="noopener">https://juejin.cn/post/6844903545355894797#heading-7</a><br><a href="https://juejin.cn/post/6844903903000166407#heading-21" target="_blank" rel="noopener">https://juejin.cn/post/6844903903000166407#heading-21</a><br><a href="https://juejin.cn/post/6844903504276881422#heading-6" target="_blank" rel="noopener">https://juejin.cn/post/6844903504276881422#heading-6</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">"puppeteer"</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">//   1. 生成pdf</span></span><br><span class="line">  <span class="comment">//   const browser = await puppeteer.launch();</span></span><br><span class="line">  <span class="comment">//   const page = await browser.newPage();</span></span><br><span class="line">  <span class="comment">//   await page.goto("https://www.qq.com/");</span></span><br><span class="line">  <span class="comment">//   await page.pdf(&#123;</span></span><br><span class="line">  <span class="comment">//     displayHeaderFooter: true,</span></span><br><span class="line">  <span class="comment">//     path: "example.pdf",</span></span><br><span class="line">  <span class="comment">//     format: "A4",</span></span><br><span class="line">  <span class="comment">//     headerTemplate: '&lt;b style="font-size: 30px"&gt;Hello world&lt;b/&gt;',</span></span><br><span class="line">  <span class="comment">//     footerTemplate: '&lt;b style="font-size: 30px"&gt;Some text&lt;/b&gt;',</span></span><br><span class="line">  <span class="comment">//     margin: &#123;</span></span><br><span class="line">  <span class="comment">//       top: "100px",</span></span><br><span class="line">  <span class="comment">//       bottom: "200px",</span></span><br><span class="line">  <span class="comment">//       right: "30px",</span></span><br><span class="line">  <span class="comment">//       left: "30px",</span></span><br><span class="line">  <span class="comment">//     &#125;,</span></span><br><span class="line">  <span class="comment">//   &#125;);</span></span><br><span class="line">  <span class="comment">//   await browser.close();</span></span><br><span class="line">  <span class="comment">//   ----------------</span></span><br><span class="line">  <span class="comment">//   2. tarce分析</span></span><br><span class="line">  <span class="comment">//   const broswer = await puppeteer.launch();</span></span><br><span class="line">  <span class="comment">//   const page = await broswer.newPage();</span></span><br><span class="line">  <span class="comment">//   await page.tracing.start(&#123;</span></span><br><span class="line">  <span class="comment">//     path: "trace.json",</span></span><br><span class="line">  <span class="comment">//   &#125;);</span></span><br><span class="line">  <span class="comment">//   await page.goto("https://www.qq.com/");</span></span><br><span class="line">  <span class="comment">//   await page.tracing.stop();</span></span><br><span class="line">  <span class="comment">//   broswer.close();</span></span><br><span class="line">  <span class="comment">//   ----------------</span></span><br><span class="line">  <span class="comment">//   3. 爬虫SSR</span></span><br><span class="line">  <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">"https://preview.pro.ant.design/#"</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">await</span> page.content());</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2021/03/24/headless-chrome/" data-id="ckonxihuh0001ttyzyj5kk2py" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Chrome/">Chrome</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-java高级" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2021/03/24/java高级/" class="article-date">
  <time datetime="2021-03-24T12:44:13.000Z" itemprop="datePublished">2021-03-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2021/03/24/java高级/">Java高级</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="java-高级"><a href="#java-高级" class="headerlink" title="java 高级"></a>java 高级</h1><h2 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h2><h3 id="线程生命周期"><a href="#线程生命周期" class="headerlink" title="线程生命周期"></a>线程生命周期</h3><p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1go9z6jnszzj311s0ia7bn.jpg" alt="线程声明周期"></p>
<h3 id="创建方式"><a href="#创建方式" class="headerlink" title="创建方式"></a>创建方式</h3><ol>
<li>继承 Thread 方式</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high.com.company;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多线程创建：方法一，继承于Thread类</span></span><br><span class="line"><span class="comment"> * step</span></span><br><span class="line"><span class="comment"> * 1. 创建一个继承于Thread类的子类</span></span><br><span class="line"><span class="comment"> * 2。重写Thread类的run()</span></span><br><span class="line"><span class="comment"> * 3. 创建Thread类的子类</span></span><br><span class="line"><span class="comment"> * 4. 通过此对象调用start()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//   1. 创建一个继承于Thread类的子类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"><span class="comment">//    2。重写Thread类的run()</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        3. 创建Thread类的子类</span></span><br><span class="line">        MyThread t1 = <span class="keyword">new</span> MyThread();</span><br><span class="line"><span class="comment">//         4。通过此对象调用start(): 1)启动当前线程 2)调用当前线程run()</span></span><br><span class="line">        t1.start();</span><br><span class="line"><span class="comment">//        t1.run()  不能这样调用线程因为这只是单纯类方法调用，用的都是main</span></span><br><span class="line"><span class="comment">//        start方法只能调用一次</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>实现 Runnable 接口方式</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high.com.company;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建多线程的方式二：实现Runnable接口</span></span><br><span class="line"><span class="comment"> * 1. 创建一个实现了Runnable接口的类</span></span><br><span class="line"><span class="comment"> * 2. 实现类去实现Runnable中的抽象方法: run()</span></span><br><span class="line"><span class="comment"> * 3. 创建实现类的对象</span></span><br><span class="line"><span class="comment"> * 4. 将此对象作为参数传递到Thread类的构造器中，创建Thread类的对象</span></span><br><span class="line"><span class="comment"> * 5. 通过Thread类的对象调用start()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个实现了Runnable接口的类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现类去实现Runnable中的抽象方法: run()</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">":"</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTest1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        创建实现类的对象</span></span><br><span class="line">        MThread mThread = <span class="keyword">new</span> MThread();</span><br><span class="line"><span class="comment">// 将此对象作为参数传递到Thread类的构造器中，创建Thread类的对象</span></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(mThread);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(mThread);</span><br><span class="line"><span class="comment">// 通过Thread类的对象调用start()</span></span><br><span class="line"><span class="comment">//        启动线程</span></span><br><span class="line"><span class="comment">//        调用当前线程的额run() ---&gt; 调用了Runnable类型的target的run()</span></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>实现 Callable 接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high1.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.FutureTask;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建线程的方式3: 实现Callable接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 如何理解实现Callable接口比实现Runnable接口强大</span></span><br><span class="line"><span class="comment"> * 1. call可以有返回值</span></span><br><span class="line"><span class="comment"> * 2. call可以抛出异常，被外面操作捕获，获取异常信息</span></span><br><span class="line"><span class="comment"> * 3. Callable支持泛型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 创建一个实现Callable的实现类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NumThread</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">//    2. 实现call方法，将此线程需要执行的操作声明在call()中</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(i);</span><br><span class="line">                sum += i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallableTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        3. 创建Callable接口实现类的对象</span></span><br><span class="line">        NumThread numThread = <span class="keyword">new</span> NumThread();</span><br><span class="line"><span class="comment">//        4. 将此Callable接口实现类的对象作为参数传递到FutureTask构造器中，创建FutureTask对象</span></span><br><span class="line">        FutureTask&lt;Integer&gt; futureTask = <span class="keyword">new</span> FutureTask&lt;Integer&gt;(numThread);</span><br><span class="line"><span class="comment">//        5. 将FutureTask的对象作为参数传递到Thread的构造器中，创建Thread对象，并调用start</span></span><br><span class="line">        <span class="keyword">new</span> Thread(futureTask).start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//            6. 获取Callable中call方法的返回值</span></span><br><span class="line"><span class="comment">//            get返回值为构造器参数Callable实现类重写的call()返回值</span></span><br><span class="line">            Integer sum = futureTask.get();</span><br><span class="line">            System.out.println(<span class="string">"总和为:"</span> + sum);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>线程池</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high1.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建线程的方式4: 线程池</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 好处:</span></span><br><span class="line"><span class="comment"> * 1. 提高响应速度(减少了创建新线程的时间)</span></span><br><span class="line"><span class="comment"> * 2. 降低资源消耗(重复利用线程池中线程，不需要每次都创建)</span></span><br><span class="line"><span class="comment"> * 3. 便于线程管理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NumberThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">100</span> ; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">": "</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        1. 提供指定线程数量的线程池</span></span><br><span class="line">        ExecutorService service = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"><span class="comment">//        2. 执行指定线程的操作。需要提供实现Runnable接口或Callable接口实现类的对象</span></span><br><span class="line">        <span class="comment">//        适用于Runnable</span></span><br><span class="line">        service.execute(<span class="keyword">new</span> NumberThread());</span><br><span class="line"><span class="comment">//        关闭连接池</span></span><br><span class="line">        service.shutdown();</span><br><span class="line"><span class="comment">//        适用于Callable</span></span><br><span class="line"><span class="comment">//        service.submit(Callable callable);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="线程相关方法与说明"><a href="#线程相关方法与说明" class="headerlink" title="线程相关方法与说明"></a>线程相关方法与说明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high.com.company;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Thread常用方法</span></span><br><span class="line"><span class="comment"> * 1. start(): 启动当前线程；调用当前线程run()</span></span><br><span class="line"><span class="comment"> * 2. run(): 通常需要重写Thread中的方法，将创建的线程要执行的操作声明在此方法中</span></span><br><span class="line"><span class="comment"> * 3. currentThread(): 静态方法，返回当前代码执行的线程</span></span><br><span class="line"><span class="comment"> * 4. getName(): 获取当前线程名字</span></span><br><span class="line"><span class="comment"> * 5. setName(): 设置当前线程名字</span></span><br><span class="line"><span class="comment"> * 6. yield(): 释放当前cpu执行权</span></span><br><span class="line"><span class="comment"> * 7. join(): 在线程a中调用线程b的join(),此时线程a就进入阻塞状态，知道线程b完全执行完以后，线程a才结束阻塞状态</span></span><br><span class="line"><span class="comment"> * 8. sleep(long ms): 让当前线程睡眠指定毫秒</span></span><br><span class="line"><span class="comment"> * 9. isAlive():</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 线程的优先级</span></span><br><span class="line"><span class="comment"> * MAX_PRIORITY 10</span></span><br><span class="line"><span class="comment"> * MIN_PRIORITY 1</span></span><br><span class="line"><span class="comment"> * NORM_PRIORITY 5 // 默认优先级</span></span><br><span class="line"><span class="comment"> * 设置当前线程优先级</span></span><br><span class="line"><span class="comment"> * getPriority(): 获取当前线程优先级</span></span><br><span class="line"><span class="comment"> * setPriority(): 设置当前线程优先级</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 说明: 高优先级的线程要抢占低优先级线程的cpu的执行权。但是只是从概率上讲，高优先级的线程高概率情况下被执行，并不意味着只有当高优先级的线程执行完以后，低优先级的线程才执行。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//                try &#123;</span></span><br><span class="line"><span class="comment">//                    sleep(1000);</span></span><br><span class="line"><span class="comment">//                &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">//                    e.printStackTrace();</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">":"</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadMethodTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        HelloThread h1 = <span class="keyword">new</span> HelloThread(<span class="string">"Thread: 1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        h1.setName("线程一");</span></span><br><span class="line"></span><br><span class="line">        h1.start();</span><br><span class="line"></span><br><span class="line">        Thread.currentThread().setName(<span class="string">"主线程"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">":"</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">20</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    h1.join();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(h1.isAlive());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h3><ol>
<li>synchronized</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high.com.company;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Window2</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ticket = <span class="number">100</span>;</span><br><span class="line">    Object obj = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(obj) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ticket &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">":卖票，票号为:"</span> + ticket);</span><br><span class="line">                    ticket--;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 例子：卖票过程中卖出现了重票、错票 --&gt; 出现了线程的安全问题</span></span><br><span class="line"><span class="comment"> * 1. 问题出现的原因：当某个线程操作车票过程中，尚未操作完成时，其他线程参与进来，也操作车票。</span></span><br><span class="line"><span class="comment"> * 2. 解决：直到一个线程解决之后，其他才可参与进来。</span></span><br><span class="line"><span class="comment"> * 3. 同步机制解决这种。</span></span><br><span class="line"><span class="comment"> *  - 方法一：同步代码块</span></span><br><span class="line"><span class="comment"> *  synchronized(同步监视器) &#123;</span></span><br><span class="line"><span class="comment"> *      // 需要被同步的代码： 操作共享数据的代码</span></span><br><span class="line"><span class="comment"> *      // 共享数据： 多个额线程共同操作的变量。</span></span><br><span class="line"><span class="comment"> *      // 同步监视器：锁。任何一个类的对象都可以当锁。</span></span><br><span class="line"><span class="comment"> *      // 锁要求：多个线程必须要共用同一把锁。</span></span><br><span class="line"><span class="comment"> *  &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  - 方法二：同步方法</span></span><br><span class="line"><span class="comment"> *  如果操作哦共享数据的代码完整声明在一个方法中，不妨将此方法声明同步的。</span></span><br><span class="line"><span class="comment"> *  总结：</span></span><br><span class="line"><span class="comment"> *  1. 同步方法仍然涉及到同步监视器，只是不需要我们嗯显示声明</span></span><br><span class="line"><span class="comment"> *  2. 静态的同步方法，同步监视器是当前类本身</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 4. 解决安全问题，但是效率低</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowTest2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Window2 w = <span class="keyword">new</span> Window2();</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(w);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(w);</span><br><span class="line">        Thread t3 = <span class="keyword">new</span> Thread(w);</span><br><span class="line"></span><br><span class="line">        t1.setName(<span class="string">"窗口1"</span>);</span><br><span class="line">        t2.setName(<span class="string">"窗口2"</span>);</span><br><span class="line">        t3.setName(<span class="string">"窗口3"</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Lock</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high1.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解决线程安全的方式3： Lock锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 与synchronized不同：</span></span><br><span class="line"><span class="comment"> * synchronized机制在执行完相应同步代码后，自动释放同步监视器</span></span><br><span class="line"><span class="comment"> * lock需要手动启动同步, 同事结束同步也要噢手动实现</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 优先使用顺序：</span></span><br><span class="line"><span class="comment"> * Lock -&gt; 同步代码块 -&gt; 同步方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Window</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ticket = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">                <span class="keyword">if</span> (ticket &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">": 买票，票号为: "</span> + ticket);</span><br><span class="line">                    ticket--;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockTest1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Window w = <span class="keyword">new</span> Window();</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(w);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(w);</span><br><span class="line">        Thread t3 = <span class="keyword">new</span> Thread(w);</span><br><span class="line"></span><br><span class="line">        t1.setName(<span class="string">"窗口1"</span>);</span><br><span class="line">        t2.setName(<span class="string">"窗口2"</span>);</span><br><span class="line">        t3.setName(<span class="string">"窗口3"</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>死锁</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high1.com.company;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示线程死锁问题</span></span><br><span class="line"><span class="comment"> * 概念：不通的线程分别占用对方需要的同步资源不放弃，都在等待对方放弃自己需要的同步资源，就形成了死锁。</span></span><br><span class="line"><span class="comment"> * 说明：出现死锁后，不会出现异常，不会出现提示，只是所有的线程都处于阻塞状态,无法继续</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTest1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        StringBuffer s1 = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        StringBuffer s2 = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (s1) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    s1.append(<span class="string">"a"</span>);</span><br><span class="line">                    s2.append(<span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">synchronized</span> (s2) &#123;</span><br><span class="line">                        s1.append(<span class="string">"b"</span>);</span><br><span class="line">                        s2.append(<span class="string">"2"</span>);</span><br><span class="line"></span><br><span class="line">                        System.out.println(s1);</span><br><span class="line">                        System.out.println(s2);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (s2) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    s1.append(<span class="string">"c"</span>);</span><br><span class="line">                    s2.append(<span class="string">"3"</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">synchronized</span> (s1) &#123;</span><br><span class="line">                        s1.append(<span class="string">"d"</span>);</span><br><span class="line">                        s2.append(<span class="string">"4"</span>);</span><br><span class="line"></span><br><span class="line">                        System.out.println(s1);</span><br><span class="line">                        System.out.println(s2);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Bank 单例</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high1.com.company;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BankTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bank</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Bank</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Bank instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    public static synchronized Bank getInstance() &#123;</span></span><br><span class="line"><span class="comment">//        if (instance == null) &#123;</span></span><br><span class="line"><span class="comment">//            instance = new Bank();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        return instance;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bank <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//      方式1： 效率稍差</span></span><br><span class="line"><span class="comment">//        synchronized (Bank.class) &#123;</span></span><br><span class="line"><span class="comment">//            if (instance == null) &#123;</span></span><br><span class="line"><span class="comment">//                instance = new Bank();</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            return instance;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        方式2：效率更高</span></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Bank.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> Bank();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> instance;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="常用类"><a href="#常用类" class="headerlink" title="常用类"></a>常用类</h2><h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><p><strong>1). String 的使用</strong></p>
<ol>
<li>String 声明为 final，不可被继承</li>
<li>实现了 Serializable 接口: 表示字符串是支持序列化的；实现了 Comparable 接口:表示 String 可以比较大小</li>
<li>内部定义了 final char[] value 用于存储字符串数据</li>
<li>代表不可恶变的字符序列<br>体现: 1. 当对字符串重新赋值时，需要重写指定区域赋值，不能使用原有的 value 进行赋值 2. 当对现有字符串进行连接操作室，也需要重写指定区域赋值，不能使用原有的 value 进行赋值 3. replace 也同上一样</li>
<li>通过字面量方式给一个字符串赋值，此时的字符串声明在常量池中</li>
<li>字符串常量池中是不会存储相同内容的字符串的。</li>
</ol>
<p><strong>2). String 实例化方式</strong></p>
<ol>
<li>字面量</li>
<li>new + 构造器</li>
</ol>
<p><strong>3)结论:</strong></p>
<ol>
<li>常量与常量拼接结果在常量池，且常量池中不会存在相同内容的常量</li>
<li>只要其中又一个是变量，结果就在堆中</li>
<li>如果拼接的结果调用 intern(), 返回值就在常量池中</li>
</ol>
<p><strong>4). String 方法</strong></p>
<ol>
<li>length()</li>
<li>charAt(number)</li>
<li>isEmpty()</li>
<li>toLowerCase()</li>
<li>toUpperCase()</li>
<li>trim()</li>
<li>equals()</li>
<li>equalsIgnoreCase()</li>
<li>concat()</li>
<li>compareTo(String str) 会涉及到字符串排序</li>
<li>substring()</li>
<li>endsWith()</li>
<li>startsWith()</li>
<li>contains()</li>
<li>indexOf</li>
<li>lastIndexOf</li>
<li>replace</li>
<li>replaceAll</li>
<li>replaceFirst</li>
<li>matches</li>
<li>split</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * String --&gt; char[]: 调用String的toCharArray()</span></span><br><span class="line"><span class="comment">     * char[] --&gt; String: 调用String的构造器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String str1 = <span class="string">"acct"</span>;</span><br><span class="line">        <span class="keyword">char</span>[] chars = str1.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; chars.length; i++) &#123;</span><br><span class="line">            System.out.println(chars[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span>[] chars1 = &#123;<span class="string">'h'</span>, <span class="string">'h'</span>, <span class="string">'h'</span>, <span class="string">'h'</span>, <span class="string">'h'</span>&#125;;</span><br><span class="line">        String s = <span class="keyword">new</span> String(chars1);</span><br><span class="line">        System.out.println(s);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * String --&gt; byte[]: 调用String的getBytes()</span></span><br><span class="line"><span class="comment">     * byte[] --&gt; String: 调用String的构造器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String str1 = <span class="string">"abc123"</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = str1.getBytes();</span><br><span class="line">        System.out.println(Arrays.toString(bytes));</span><br><span class="line"></span><br><span class="line">        String s = <span class="keyword">new</span> String(bytes);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="StringBuffer、StringBuilder"><a href="#StringBuffer、StringBuilder" class="headerlink" title="StringBuffer、StringBuilder"></a>StringBuffer、StringBuilder</h3><p>可变不可变意思: 在原有基础上是否改变<br><strong>String、StringBuffer、StringBuilder</strong><br>String: 不可变字符序列;底层 char[]存储<br>StringBuffer: 可变字符序列;线程安全、效率低;底层 char[]存储<br>StringBuilder: 可变字符序列;线程不安全、效率高;底层 char[]存储</p>
<p><strong>源码分析</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="keyword">new</span> String(); <span class="comment">// char[] value = new char[0];</span></span><br><span class="line">String str1 = <span class="keyword">new</span> String(<span class="string">"abc"</span>); <span class="comment">// char[] value = new char[]&#123;'a', 'b', 'c'&#125;;</span></span><br><span class="line"></span><br><span class="line">StringBuffer sb1 = <span class="keyword">new</span> StringBuffer(); <span class="comment">// char[] value = new char[16]; 底层创建了一个长度是 16 的字符</span></span><br><span class="line">StringBuffer sb2 = <span class="keyword">new</span> StringBuffer(<span class="string">"abc"</span>); <span class="comment">// char[] value = new char["abc".length + 16];</span></span><br></pre></td></tr></table></figure>

<p>扩容问题: 如果要添加的数据底层数组盛不下了，那就需要扩容底层数组。默认情况下，扩容为原来容量的 2 倍 + 2，同时将原有数组中的元素复制到新的数组中。<br>开发中建议使用 StringBuffer(int capacity)</p>
<p><strong>StringBuffer 常用方法</strong><br>append(xxx)<br>delete(int start, int end)<br>replace(int start, int end, String str)<br>insert(int offset, xxx)<br>reverse()<br>indexOf(String str)<br>substring(int start, int end)<br>length()<br>charAt(int n)<br>setCharAt(int n, char ch)</p>
<p><strong>3 者效率:</strong><br>StringBuilder &gt; StringBuffer &gt; String</p>
<h3 id="Date-相关"><a href="#Date-相关" class="headerlink" title="Date 相关"></a>Date 相关</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high2.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.time.*;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.util.Calendar;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. System类中currentTimeMillis()</span></span><br><span class="line"><span class="comment"> * 2. java.util.Date和子类java.sql.Date</span></span><br><span class="line"><span class="comment"> * 3. SimpleDateFormat</span></span><br><span class="line"><span class="comment"> * 4. Calendar</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DateTimeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Date date = <span class="keyword">new</span> Date();</span><br><span class="line"><span class="comment">//        显示当前年月日时分秒</span></span><br><span class="line">        System.out.println(date.toString());</span><br><span class="line"><span class="comment">//        获取时间戳</span></span><br><span class="line">        System.out.println(date.getTime());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat();</span><br><span class="line">        System.out.println(simpleDateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line"></span><br><span class="line">        System.out.println(simpleDateFormat.parse(<span class="string">"21-3-22 下午9:26"</span>));</span><br><span class="line"></span><br><span class="line">        SimpleDateFormat simpleDateFormat1 = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd hh:mm:ss"</span>);</span><br><span class="line">        System.out.println(simpleDateFormat1.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Calendar instance = Calendar.getInstance();</span><br><span class="line">        System.out.println(instance.get(Calendar.DAY_OF_MONTH));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        LocalDateTime = LocalDate + LocalTime</span></span><br><span class="line"><span class="comment">//        LocalDateTime使用频率高</span></span><br><span class="line"><span class="comment">//        of指定时间无偏移量</span></span><br><span class="line"></span><br><span class="line">        LocalDate now = LocalDate.now();</span><br><span class="line">        LocalTime now1 = LocalTime.now();</span><br><span class="line">        LocalDateTime now2 = LocalDateTime.now();</span><br><span class="line">        LocalDateTime time = LocalDateTime.of(<span class="number">2021</span>, <span class="number">3</span>, <span class="number">23</span>, <span class="number">15</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(now);</span><br><span class="line">        System.out.println(now1);</span><br><span class="line">        System.out.println(now2);</span><br><span class="line">        System.out.println(time);</span><br><span class="line"></span><br><span class="line">        System.out.println(now2.getDayOfMonth());</span><br><span class="line">        System.out.println(now2.getDayOfWeek());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        本初子午线对应时间</span></span><br><span class="line">        Instant now = Instant.now();</span><br><span class="line">        OffsetDateTime offsetDateTime = now.atOffset(ZoneOffset.ofHours(<span class="number">8</span>));</span><br><span class="line">        System.out.println(now);</span><br><span class="line">        System.out.println(offsetDateTime);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tes6</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        同SimpleDateFormat</span></span><br><span class="line">        DateTimeFormatter isoLocalDate = DateTimeFormatter.ISO_LOCAL_DATE;</span><br><span class="line">        LocalDateTime now = LocalDateTime.now();</span><br><span class="line">        System.out.println(isoLocalDate.format(now));</span><br><span class="line"></span><br><span class="line">        DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd hh:mm:ss"</span>);</span><br><span class="line">        System.out.println(dateTimeFormatter.format(LocalDateTime.now()));</span><br><span class="line">        System.out.println(dateTimeFormatter.parse(<span class="string">"2021-03-23 03:53:41"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Enum"><a href="#Enum" class="headerlink" title="Enum"></a>Enum</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high2.com.company;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 如果枚举类中只有1个对象，则可以作为一种单例模式的实现方式</span></span><br><span class="line"><span class="comment"> * 定义的枚举类默认继承java.lang.Enum</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enum中常用方法</span></span><br><span class="line"><span class="comment"> * values();</span></span><br><span class="line"><span class="comment"> * valueOf(String str); 找不到抛异常</span></span><br><span class="line"><span class="comment"> * toString();</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 可以实现接口，在enum类中实现抽象方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnumTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(Season.Autimn.getSeasonName());</span><br><span class="line"></span><br><span class="line">        Season1 summer = Season1.SUMMER;</span><br><span class="line">        System.out.println(summer);</span><br><span class="line">        System.out.println(Season1.class.getSuperclass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义枚举类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Season</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    1. 声明Season对象的属性：private final 修饰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String seasonName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String seasonDesc;</span><br><span class="line"><span class="comment">// 2. 私有化类的构造器, 并个诶对象属性赋值</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Season</span><span class="params">(String seasonName, String seasonDesc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seasonName = seasonName;</span><br><span class="line">        <span class="keyword">this</span>.seasonDesc = seasonDesc;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 3. 提供当前枚举类的多个对象: public static final的</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Season Spring = <span class="keyword">new</span> Season(<span class="string">"春"</span>, <span class="string">"1"</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Season Summer = <span class="keyword">new</span> Season(<span class="string">"夏"</span>, <span class="string">"2"</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Season Autimn = <span class="keyword">new</span> Season(<span class="string">"秋"</span>, <span class="string">"3"</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Season Winter = <span class="keyword">new</span> Season(<span class="string">"冬"</span>, <span class="string">"4"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSeasonName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seasonName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSeasonDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seasonDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Season&#123;"</span> +</span><br><span class="line">                <span class="string">"seasonName='"</span> + seasonName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", seasonDesc='"</span> + seasonDesc + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// enum定义</span></span><br><span class="line"><span class="keyword">enum</span> Season1 &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 提供当前枚举类的对象，多个对象用","</span></span><br><span class="line">     SPRING(<span class="string">"春"</span>, <span class="string">"1"</span>),</span><br><span class="line">     SUMMER(<span class="string">"夏"</span>, <span class="string">"2"</span>),</span><br><span class="line">     AUTIUM(<span class="string">"秋"</span>, <span class="string">"3"</span>),</span><br><span class="line">     WINTER(<span class="string">"冬"</span>, <span class="string">"4"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    1. 声明Season对象的属性：private final 修饰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String seasonName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String seasonDesc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 私有化类的构造器, 并个诶对象属性赋值</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Season1</span><span class="params">(String seasonName, String seasonDesc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seasonName = seasonName;</span><br><span class="line">        <span class="keyword">this</span>.seasonDesc = seasonDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSeasonName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seasonName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSeasonDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seasonDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="比较-Comparable、-Comparator"><a href="#比较-Comparable、-Comparator" class="headerlink" title="比较 Comparable、 Comparator"></a>比较 Comparable、 Comparator</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high2.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  用 &gt; &lt; 比较对象</span></span><br><span class="line"><span class="comment"> * 像String,包装类实现了Comparable接口，重写了compareTo(obj)方法，</span></span><br><span class="line"><span class="comment"> * 从小到大排列</span></span><br><span class="line"><span class="comment"> * CompareTo(obj)比较规则：</span></span><br><span class="line"><span class="comment"> *  当前对象this大于形参对象obj，返回正整数</span></span><br><span class="line"><span class="comment"> *  当前对象this小于于形参对象obj，返回负整数</span></span><br><span class="line"><span class="comment"> *  当前对象this等于形参对象obj，返回0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  Comparator接口使用: 定制排序</span></span><br><span class="line"><span class="comment"> *  1.背景: 当元素类型没有实现java.lang.Comparable接口而又不方便修改代码，</span></span><br><span class="line"><span class="comment"> *  或者实现了java.lang.Comparable接口的排序规则不适合当前的操作，</span></span><br><span class="line"><span class="comment"> *  那么可以考虑使用Comparator的对象来排序</span></span><br><span class="line"><span class="comment"> *  2.重写compare(Object o1, Object o2)方法，比较大小，规则同上</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Comparable与Comparator对比:</span></span><br><span class="line"><span class="comment"> * 1. Comparable一旦指定，保证Comparable接口实现类的对象哪都能比较大小</span></span><br><span class="line"><span class="comment"> * 2. Comparator接口属于临时性比较，创建一个new一个</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@MyAnnotation</span>(value = <span class="string">"hiw"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompareTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String[] arr = <span class="keyword">new</span> String[]&#123;<span class="string">"AA"</span>, <span class="string">"VV"</span>, <span class="string">"DD"</span>, <span class="string">"BB"</span>, <span class="string">"CC"</span>, <span class="string">"RR"</span>&#125;;</span><br><span class="line">        Arrays.sort(arr);</span><br><span class="line"></span><br><span class="line">        System.out.println(Arrays.toString(arr));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String[] arr = <span class="keyword">new</span> String[]&#123;<span class="string">"AA"</span>, <span class="string">"VV"</span>, <span class="string">"DD"</span>, <span class="string">"BB"</span>, <span class="string">"CC"</span>, <span class="string">"RR"</span>&#125;;</span><br><span class="line">        Arrays.sort(arr, <span class="keyword">new</span> Comparator&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(String o1, String o2)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (o1 <span class="keyword">instanceof</span> String &amp;&amp; o2 <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                    String s1 = (String) o1;</span><br><span class="line">                    String s2 = (String) o2;</span><br><span class="line">                    <span class="keyword">return</span> -s1.compareTo(s2);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"传入数据类型不一致"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(Arrays.toString(arr));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Class&lt;CompareTest&gt; compareTestClass = CompareTest.class;</span><br><span class="line">      Annotation[] annotations = compareTestClass.getAnnotations();</span><br><span class="line">      System.out.println(Arrays.toString(annotations));</span><br><span class="line">        <span class="keyword">for</span> (Annotation annotation : annotations) &#123;</span><br><span class="line">            System.out.println(annotation);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Goods[] goods = <span class="keyword">new</span> Goods[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        goods[<span class="number">0</span>] = <span class="keyword">new</span> Goods(<span class="string">"aaa"</span>, <span class="number">15</span>);</span><br><span class="line">        goods[<span class="number">1</span>] = <span class="keyword">new</span> Goods(<span class="string">"bbb"</span>, <span class="number">18</span>);</span><br><span class="line">        goods[<span class="number">2</span>] = <span class="keyword">new</span> Goods(<span class="string">"ccc"</span>, <span class="number">17</span>);</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"hhhhhhhhh"</span>&#125;)</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">123</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(a);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Arrays.sort(goods);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(goods);</span><br><span class="line"></span><br><span class="line">        System.out.println(Arrays.toString(goods));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high2.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. 注解声明为<span class="doctag">@interface</span></span></span><br><span class="line"><span class="comment"> * 2. 内部定义成员，通常使用value表示</span></span><br><span class="line"><span class="comment"> * 3. 可以指定成员默认值，使用default定义</span></span><br><span class="line"><span class="comment"> * 4. 如果自定义注解没有成员，表明是一个表示作用</span></span><br><span class="line"><span class="comment"> * 5. 使用有成员注解时，主要指明成员值</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 需要处理流程才有意义(反射)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 元注解: 用来修饰其他注解的注解</span></span><br><span class="line"><span class="comment"> * Retention: 指定所修饰的Annotation生命周期: SOURCE(默认)、CLASS(默认)、RUNTIME(只有声明为这个才能通过反射获取)</span></span><br><span class="line"><span class="comment"> * Target: 用于指定被修饰的Annotation能用于修饰哪些程序元素</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Documented: 表示所修饰的注解被javadoc解析时，保留下来</span></span><br><span class="line"><span class="comment"> * Inherited: 被它修饰的注解具有继承性</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * jdk8</span></span><br><span class="line"><span class="comment"> * 可重复注解:</span></span><br><span class="line"><span class="comment"> * 1. 声明Repeatable，成员值为MyAnnotation.class</span></span><br><span class="line"><span class="comment"> * 2. MyAnnotation的Target和Retention和MyAnnotations相同</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 类型注解</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="comment">//@Repeatable(MyAnnotation.class)</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE, ElementType.FIELD, ElementType.METHOD, ElementType.PARAMETER, ElementType.CONSTRUCTOR, ElementType.LOCAL_VARIABLE&#125;)</span><br><span class="line"><span class="meta">@interface</span> MyAnnotation &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> "hi"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high2.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 泛型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注意点</span></span><br><span class="line"><span class="comment"> * 1. 泛型类型必须是类，不能是基本数据类型，需要时用包装类</span></span><br><span class="line"><span class="comment"> * 2. 如果实例化时没有指定泛型的类型，默认为java.lang.Object类型</span></span><br><span class="line"><span class="comment"> * 3. 静态方法中不能使用类的反响</span></span><br><span class="line"><span class="comment"> * 4. 异常类不能是反响的</span></span><br><span class="line"><span class="comment"> * 5. 不能使用new E[]</span></span><br><span class="line"><span class="comment"> * 6. 父类有泛型，子类可以选择保留泛型也可以选择指定泛型类型。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 泛型方法: 方法中出现了泛型结构，泛型参数与类的泛型参数没有任何关系。</span></span><br><span class="line"><span class="comment"> * 类似   public &lt;E&gt; List&lt;E&gt; fn(E[] arr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 泛型在集成方面的体现</span></span><br><span class="line"><span class="comment"> * 虽然类A是类B的负累，但是G&lt;A&gt;和G&lt;B&gt;二者不具备子父类关系，二者是并列关系。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 通配符 ?  any</span></span><br><span class="line"><span class="comment"> * 类A是类B的父类， G&lt;A&gt;和G&lt;B&gt;是没有关系的，二者共同的父类是: G&lt;?&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 有限制条件的通配符使用</span></span><br><span class="line"><span class="comment"> * ? extends A  ------ &lt;=   G&lt;? extends A&gt; 可以作为G&lt;A&gt;和G&lt;B&gt;的父类的，其中B是A的子类</span></span><br><span class="line"><span class="comment"> * ? super A   ------ &gt;=    G&lt;? super A&gt; 可以作为G&lt;A&gt;和G&lt;B&gt;的父类的，其中B是A的父类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;Integer&gt; integers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        integers.add(<span class="number">12</span>);</span><br><span class="line">        integers.add(<span class="number">52</span>);</span><br><span class="line">        integers.add(<span class="number">42</span>);</span><br><span class="line">        integers.add(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Integer integer: integers) &#123;</span><br><span class="line">            <span class="keyword">int</span> num = integer;</span><br><span class="line">            System.out.println(num);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Iterator&lt;Integer&gt; iterator = integers.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            System.out.println(iterator.next());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HashMap&lt;String, Integer&gt; stringIntegerHashMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        stringIntegerHashMap.put(<span class="string">"a"</span>, <span class="number">1</span>);</span><br><span class="line">        stringIntegerHashMap.put(<span class="string">"b"</span>, <span class="number">12</span>);</span><br><span class="line">        stringIntegerHashMap.put(<span class="string">"c"</span>, <span class="number">123</span>);</span><br><span class="line">        stringIntegerHashMap.put(<span class="string">"d"</span>, <span class="number">1234</span>);</span><br><span class="line">        stringIntegerHashMap.put(<span class="string">"e"</span>, <span class="number">12345</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(stringIntegerHashMap);</span><br><span class="line"></span><br><span class="line">        Set&lt;Map.Entry&lt;String, Integer&gt;&gt; entries = stringIntegerHashMap.entrySet();</span><br><span class="line"></span><br><span class="line">        Iterator&lt;Map.Entry&lt;String, Integer&gt;&gt; iterator = entries.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            Map.Entry&lt;String, Integer&gt; next = iterator.next();</span><br><span class="line">            String key = next.getKey();</span><br><span class="line">            Integer value = next.getValue();</span><br><span class="line">            System.out.println(key + <span class="string">": "</span> + value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">(List&lt;?&gt; list)</span> </span>&#123;</span><br><span class="line">        Iterator&lt;?&gt; iterator = list.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            Object next = iterator.next();</span><br><span class="line">            System.out.println(next);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h2><h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high2.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.TreeMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Map: key-value y = f(x)</span></span><br><span class="line"><span class="comment"> *      HashMap: 作为Map的主要实现类。线程不安全，效率高; 可以存储null的key和value</span></span><br><span class="line"><span class="comment"> *          LinkedHashMap: 保证遍历map元素时，可以按照添加的顺序实现遍历。原理添加了指针。对于频繁的遍历操作，可以使用这个。</span></span><br><span class="line"><span class="comment"> *      TreeMap: 按添加的key-value对进行排序，实现排序遍历。此时考虑key的 自然排序或定制排序。</span></span><br><span class="line"><span class="comment"> *      Hashtable: 作为古老的实现类 线程安全，效率低; 不可以存储null的key和value</span></span><br><span class="line"><span class="comment"> *          Properties: 常用来处理配置文件。key和value都是string</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * HashMap底层: 数组 + 链表 (jdk7及以前) 形成链表时，新的元素指向旧的元素</span></span><br><span class="line"><span class="comment"> *             数组 + 链表 + 红黑树 (jdk8) 形成链表时，旧的元素指向新的元素</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Map结构的理解：</span></span><br><span class="line"><span class="comment"> *  Map中的key: 无序的、不可重复的，使用Set存储所有的key --&gt; 要求key所在的类要重写equals()和hashCode() 因为key不重复</span></span><br><span class="line"><span class="comment"> *  Map中的value: 无序的、可重复的，使用Collection存储所有的value --&gt; 要求value所在的类要重写equals() 因为collection有contains方法</span></span><br><span class="line"><span class="comment"> *  一个键值对: key-value构成一个Entry对象</span></span><br><span class="line"><span class="comment"> *  Map中的entry: 无序的、不可重复的。 使用Set存储所有的entry</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  Map定义的方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  增删改</span></span><br><span class="line"><span class="comment"> *  put</span></span><br><span class="line"><span class="comment"> *  putAll: Map里put Map</span></span><br><span class="line"><span class="comment"> *  remove</span></span><br><span class="line"><span class="comment"> *  clear</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  查询</span></span><br><span class="line"><span class="comment"> *  get</span></span><br><span class="line"><span class="comment"> *  containsKey</span></span><br><span class="line"><span class="comment"> *  containsValue</span></span><br><span class="line"><span class="comment"> *  size</span></span><br><span class="line"><span class="comment"> *  isEmpty</span></span><br><span class="line"><span class="comment"> *  equals</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  元视图操作方法</span></span><br><span class="line"><span class="comment"> *  Set keySet(): 返回所有key构成的Set集合</span></span><br><span class="line"><span class="comment"> *  Collection values(): 返回所有value构成的Collection集合</span></span><br><span class="line"><span class="comment"> *  Set entrySet(): 返回所有key-value对构成的Set集合</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ngwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapTest1</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hashMap.put(<span class="keyword">null</span>, <span class="number">1</span>);</span><br><span class="line">        System.out.println(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hashMap = <span class="keyword">new</span> LinkedHashMap();</span><br><span class="line">        hashMap.put(<span class="number">122</span>, <span class="string">"aa"</span>);</span><br><span class="line">        hashMap.put(<span class="number">233</span>, <span class="string">"bb"</span>);</span><br><span class="line">        hashMap.put(<span class="number">344</span>, <span class="string">"cc"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(hashMap.keySet());</span><br><span class="line">        System.out.println(hashMap.values());</span><br><span class="line">        System.out.println(hashMap.entrySet());</span><br><span class="line"></span><br><span class="line">        System.out.println(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        带Tree 都有比较相关 排序 自然排序定制排序</span></span><br><span class="line">        TreeMap treeMap = <span class="keyword">new</span> TreeMap();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="IO流"><a href="#IO流" class="headerlink" title="IO流"></a>IO流</h2><h3 id="流介绍"><a href="#流介绍" class="headerlink" title="流介绍"></a>流介绍</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high3.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * public boolean renameTo(File dest)</span></span><br><span class="line"><span class="comment"> * 把文件重命名为指定的文件路径，如file1.renameTo(file2),想保证返回为true, 需要file1在硬盘中存在，file2在硬盘中不存在</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * createNewFile</span></span><br><span class="line"><span class="comment"> * mkdir</span></span><br><span class="line"><span class="comment"> * mkdirs</span></span><br><span class="line"><span class="comment"> * delete 删除不走回收站</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 流分类</span></span><br><span class="line"><span class="comment"> * https://tva1.sinaimg.cn/large/008i3skNly1gptmxtgapmj31qg0twn5s.jpg</span></span><br><span class="line"><span class="comment"> * https://tva1.sinaimg.cn/large/008i3skNly1gptn093dv4j31jl0u0x4d.jpg</span></span><br><span class="line"><span class="comment"> * https://tva1.sinaimg.cn/large/008i3skNly1gptn0ou5rgj31d10u0b29.jpg</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 流输入过程</span></span><br><span class="line"><span class="comment"> * https://tva1.sinaimg.cn/large/008i3skNly1gpw2l8m5mgj31mk0oenj5.jpg</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 流输出过程</span></span><br><span class="line"><span class="comment"> * https://tva1.sinaimg.cn/large/008i3skNly1gpw2mulktpj31jm0menew.jpg</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"/Users/ngwang/Desktop/待办.md"</span>);</span><br><span class="line">        System.out.println(file);</span><br><span class="line">        System.out.println(file.getAbsolutePath());</span><br><span class="line">        System.out.println(file.length());</span><br><span class="line">        System.out.println(file.getPath());</span><br><span class="line">        System.out.println(<span class="keyword">new</span> Date(file.lastModified()));</span><br><span class="line">        System.out.println(file.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"/Users/ngwang/Desktop/zshaa"</span>);</span><br><span class="line">        String[] list = file.list();</span><br><span class="line">        <span class="keyword">for</span> ( String str: list ) &#123;</span><br><span class="line">            System.out.println(str);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high3.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 流分类</span></span><br><span class="line"><span class="comment"> * https://tva1.sinaimg.cn/large/008i3skNly1gptmxtgapmj31qg0twn5s.jpg</span></span><br><span class="line"><span class="comment"> * https://tva1.sinaimg.cn/large/008i3skNly1gptn093dv4j31jl0u0x4d.jpg</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 操作数据的单位：字符流、字节流</span></span><br><span class="line"><span class="comment"> * 流的角色：节点流、处理流</span></span><br><span class="line"><span class="comment"> * 数据流向：输入流、输出流</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 流的体系结构</span></span><br><span class="line"><span class="comment"> * https://tva1.sinaimg.cn/large/008i3skNly1gptn0ou5rgj31d10u0b29.jpg</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 抽象基类</span></span><br><span class="line"><span class="comment"> * InputStream</span></span><br><span class="line"><span class="comment"> * OutputStream</span></span><br><span class="line"><span class="comment"> * Reader</span></span><br><span class="line"><span class="comment"> * Writer</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 用法说明</span></span><br><span class="line"><span class="comment"> * 文本文件 字符流处理</span></span><br><span class="line"><span class="comment"> * 非文本文件 字节流处理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileReadWriteTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FileReader fileReader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File file = <span class="keyword">new</span> File(<span class="string">"/Users/ngwang/Desktop/demospace/java/projects/JavaSenior/src/high3/com/company/demo.html"</span>);</span><br><span class="line"></span><br><span class="line">            fileReader = <span class="keyword">new</span> FileReader(file);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> data = fileReader.read();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (data != -<span class="number">1</span>) &#123;</span><br><span class="line">                System.out.print((<span class="keyword">char</span>) data);</span><br><span class="line">                data = fileReader.read();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (fileReader != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//                    一定要关</span></span><br><span class="line">                    fileReader.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        FileReader fileReader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File file = <span class="keyword">new</span> File(<span class="string">"/Users/ngwang/Desktop/demospace/java/projects/JavaSenior/src/high3/com/company/demo.txt"</span>);</span><br><span class="line"></span><br><span class="line">            fileReader = <span class="keyword">new</span> FileReader(file);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">char</span>[] chars = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">5</span>];</span><br><span class="line">            <span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((len = fileReader.read(chars)) != -<span class="number">1</span>) &#123;</span><br><span class="line"><span class="comment">//                错误写法</span></span><br><span class="line"><span class="comment">//                for (int i = 0; i &lt; chars.length; i++) &#123;</span></span><br><span class="line"><span class="comment">//                    System.out.print(chars[i]);</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                    System.out.print(chars[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (fileReader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    fileReader.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file =  <span class="keyword">new</span> File(<span class="string">"/Users/ngwang/Desktop/demospace/java/projects/JavaSenior/src/high3/com/company/demo1.txt"</span>);</span><br><span class="line"></span><br><span class="line">        FileWriter fileWriter = <span class="keyword">new</span> FileWriter(file, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        fileWriter.write(<span class="string">"Hi hi hi hi hi\n"</span>);</span><br><span class="line"></span><br><span class="line">        fileWriter.write(<span class="string">"hello hello"</span>);</span><br><span class="line"></span><br><span class="line">        fileWriter.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="转换流"><a href="#转换流" class="headerlink" title="转换流"></a>转换流</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high3.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 转换流使用</span></span><br><span class="line"><span class="comment"> * 属于字符流。。。看后缀</span></span><br><span class="line"><span class="comment"> * InputStreamReader： 将一个字节的输入流转换为字符的输入流</span></span><br><span class="line"><span class="comment"> * OutputStreamWriter：将一个字符的输出流转换为字节的输出流</span></span><br><span class="line"><span class="comment"> * 提供字节流和字符流转换</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 编码: 字节、字节数组 ---&gt; 字符数组、字符串</span></span><br><span class="line"><span class="comment"> * 解码: 字符数组、字符串 ---&gt; 字节、字节数组</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InputStreamReaderTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//        FileInputStream fileInputStream = new FileInputStream("/Users/ngwang/Desktop/demospace/java/projects/JavaSenior/src/high3/com/company/demo.html");</span></span><br><span class="line"><span class="comment">//        InputStreamReader inputStreamReader = new InputStreamReader(fileInputStream, "UTF-8");</span></span><br><span class="line"><span class="comment">//        char[] chars = new char[20];</span></span><br><span class="line"><span class="comment">//        int len;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        while ((len = inputStreamReader.read(chars)) != -1) &#123;</span></span><br><span class="line"><span class="comment">//            String str = new String(chars, 0, len);</span></span><br><span class="line"><span class="comment">//            System.out.print(str);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        inputStreamReader.close();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="对象流"><a href="#对象流" class="headerlink" title="对象流"></a>对象流</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high3.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对象流</span></span><br><span class="line"><span class="comment"> * ObjectInputStream、ObjectOutputStream</span></span><br><span class="line"><span class="comment"> * 作用: 用于存储和读取基本类型数据或对象的处理流。强大之处在于可以把java中对象</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 自定义类要想序列化，得满足以下要求</span></span><br><span class="line"><span class="comment"> * 1. 需要实现接口: Serializable</span></span><br><span class="line"><span class="comment"> * 2. 需要当前类提供一个常量: serialVersionUID</span></span><br><span class="line"><span class="comment"> * 3. 除了当前类，其内部所有属性也都要序列化</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注意: 不能序列化static和transient修饰的成员变量</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectIOStreamTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//    序列化过程: 将内存中的java对象保存在磁盘中或通过网络传输出去</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            objectOutputStream =</span><br><span class="line">                    <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"/Users/ngwang/Desktop/demospace/java/projects/JavaSenior/src/high3/com/company/aaa.data"</span>));</span><br><span class="line">            objectOutputStream.writeObject(<span class="keyword">new</span> String(<span class="string">"牛逼"</span>));</span><br><span class="line">            objectOutputStream.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (objectOutputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    objectOutputStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    反序列化过程: 将磁盘文件中的对象还原成一个java对象</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            objectInputStream =</span><br><span class="line">                    <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"/Users/ngwang/Desktop/demospace/java/projects/JavaSenior/src/high3/com/company/aaa.data"</span>));</span><br><span class="line">            Object o = objectInputStream.readObject();</span><br><span class="line">            String str = (String) o;</span><br><span class="line">            System.out.println(str);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (objectInputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    objectInputStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="缓冲流"><a href="#缓冲流" class="headerlink" title="缓冲流"></a>缓冲流</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high3.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 缓冲流</span></span><br><span class="line"><span class="comment"> * BufferedInputStream</span></span><br><span class="line"><span class="comment"> * BufferedOutputStream</span></span><br><span class="line"><span class="comment"> * BufferedReader</span></span><br><span class="line"><span class="comment"> * BufferedWriter</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 提高流读写速度</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 关闭外层流，内层流就会自动关闭</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferedTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="反射与动态代理"><a href="#反射与动态代理" class="headerlink" title="反射与动态代理"></a>反射与动态代理</h2><h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high4.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 反射提供的功能</span></span><br><span class="line"><span class="comment"> * https://tva1.sinaimg.cn/large/008i3skNgy1gpx6lqjne1j31fw0synek.jpg</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * class实例可以是哪些结构的说明</span></span><br><span class="line"><span class="comment"> * https://tva1.sinaimg.cn/large/008i3skNly1gpyg5vh2sjj315l0u0tzo.jpg</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 关于类的加载器</span></span><br><span class="line"><span class="comment"> * 1. 自定义类；对于自定义类，使用系统类加载器进行加载；调用系统类加载的getParent()，获取拓展类的加载器；调用拓展类加载器的getParent()，无法获取引导类加载器；引导类加载器主要负责加载javad的核心类库，无法加载自定义的</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 读取配置文件的方式</span></span><br><span class="line"><span class="comment"> * https://tva1.sinaimg.cn/large/008i3skNly1gpygukpbsej32fm0t0qv5.jpg</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectionTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person(<span class="string">"Tom"</span>, <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">        person.age = <span class="number">10</span>;</span><br><span class="line">        person.show();</span><br><span class="line"></span><br><span class="line">        System.out.println(person.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; personClass = Person.class;</span><br><span class="line">        Constructor&lt;Person&gt; constructor = personClass.getConstructor(String.class, <span class="keyword">int</span>.class);</span><br><span class="line">        Person person = constructor.newInstance(<span class="string">"Tom"</span>, <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(person.toString());</span><br><span class="line"><span class="comment">//      使用反射调用对象属性、方法</span></span><br><span class="line"><span class="comment">//      属性</span></span><br><span class="line">        Field age = personClass.getDeclaredField(<span class="string">"age"</span>);</span><br><span class="line">        age.set(person, <span class="number">10</span>);</span><br><span class="line">        System.out.println(person.toString());</span><br><span class="line"><span class="comment">//      方法</span></span><br><span class="line">        Method show = personClass.getDeclaredMethod(<span class="string">"show"</span>);</span><br><span class="line">        show.invoke(person);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"*****************"</span>);</span><br><span class="line"><span class="comment">//      使用反射调用对象类的私有结构。如私有构造器、属性、方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//      私有构造器</span></span><br><span class="line">        Constructor&lt;Person&gt; declaredConstructor = personClass.getDeclaredConstructor(String.class);</span><br><span class="line">        declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Person jerry = declaredConstructor.newInstance(<span class="string">"Jerry"</span>);</span><br><span class="line">        System.out.println(jerry);</span><br><span class="line"></span><br><span class="line"><span class="comment">//      属性</span></span><br><span class="line">        Field name = personClass.getDeclaredField(<span class="string">"name"</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(jerry, <span class="string">"Lille"</span>);</span><br><span class="line">        System.out.println(jerry);</span><br><span class="line"></span><br><span class="line"><span class="comment">//      方法</span></span><br><span class="line">        Method showNation = personClass.getDeclaredMethod(<span class="string">"showNation"</span>, String.class);</span><br><span class="line">        showNation.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        showNation.invoke(jerry, <span class="string">"China"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    获取class实例的方式</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line"><span class="comment">//        方式一: 调用运行时类的属性: .class</span></span><br><span class="line">        Class&lt;Person&gt; p1 =  Person.class;</span><br><span class="line">        System.out.println(p1);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        方式二: 通过运行时类的对象，调用getClass()</span></span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        System.out.println(person.getClass());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        方式三: 通过class的静态方法。forName(String classPath)</span></span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(<span class="string">"high4.com.company.Person"</span>);</span><br><span class="line">        System.out.println(aClass);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        方式四: 使用类的加载器: ClassLoader</span></span><br><span class="line"></span><br><span class="line">        ClassLoader classLoader = ReflectionTest.class.getClassLoader();</span><br><span class="line">        Class&lt;?&gt; aClass1 = classLoader.loadClass(<span class="string">"high4.com.company.Person"</span>);</span><br><span class="line">        System.out.println(aClass1);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high4.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调用运行时类中指定的结构： 属性、方法、构造器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectionTest2</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; personClass = Person.class;</span><br><span class="line">        Person person = personClass.newInstance();</span><br><span class="line"></span><br><span class="line">        Field name = personClass.getDeclaredField(<span class="string">"name"</span>);</span><br><span class="line"><span class="comment">//        保证当前属性可以访问</span></span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        name.set(person, <span class="string">"Aaa"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(name.get(person));</span><br><span class="line"></span><br><span class="line"><span class="comment">//        getDeclaredMethod 参数1：指定获取的方法名称；参数2：指明获取方法的形参列表</span></span><br><span class="line">        Method show = personClass.getDeclaredMethod(<span class="string">"show"</span>);</span><br><span class="line"><span class="comment">//          invoke 参数1：方法的调用者； 参数2：给方法形参赋值的实参</span></span><br><span class="line">        show.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        invoke方法的返回值就是该方法的返回值</span></span><br><span class="line">        Object invoke = show.invoke(person);</span><br><span class="line">        System.out.println(invoke);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high4.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewInstanceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; personClass = Person.class;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 调用此方法，创造运行时的类的对象。默认调用的是空参构造器</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * 要想此方法正常创建运行时类的对象，要求:</span></span><br><span class="line"><span class="comment">        * 1. 运行时类必须提供空参构造器</span></span><br><span class="line"><span class="comment">        * 2. 空参构造器的访问权限得够</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * javabean中要求提供一个空参构造器，原因:</span></span><br><span class="line"><span class="comment">        * 1. 便于通过反射创建运行时类的对象</span></span><br><span class="line"><span class="comment">        * 2. 便于子类继承此运行时，默认调用super()时，保证父类有此构造器</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        Person person = personClass.newInstance();</span><br><span class="line">        System.out.println(person);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">        属性</span></span><br><span class="line"><span class="comment">        getFields(): 获取当前运行时类及其父类的访问权限设置为public的属性。</span></span><br><span class="line"><span class="comment">        getDeclaredFields(): 获取当前运行时类的所有属性(不包含父类) 权限修饰符、数据类型、变量名</span></span><br><span class="line"><span class="comment">        方法</span></span><br><span class="line"><span class="comment">        getMethods(): 与getFields()对应</span></span><br><span class="line"><span class="comment">        getDeclaredMethods(): 与getDeclaredFields()对应</span></span><br><span class="line"><span class="comment">        构造器</span></span><br><span class="line"><span class="comment">        父类、带泛型的父类。。。</span></span><br><span class="line"><span class="comment">        getSuperClass</span></span><br><span class="line"><span class="comment">        getGenericSuperClass</span></span><br><span class="line"><span class="comment">        接口</span></span><br><span class="line"><span class="comment">        getInterfaces()</span></span><br><span class="line"><span class="comment">        包</span></span><br><span class="line"><span class="comment">        getPackage()</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><h4 id="静态代理展示"><a href="#静态代理展示" class="headerlink" title="静态代理展示"></a>静态代理展示</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high4.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 静态代理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ClothFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">produceCloth</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyClothFactory</span> <span class="keyword">implements</span> <span class="title">ClothFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ClothFactory factory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyClothFactory</span><span class="params">(ClothFactory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.factory = factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produceCloth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"代理工厂的准备工作..."</span>);</span><br><span class="line">        factory.produceCloth();</span><br><span class="line">        System.out.println(<span class="string">"代理工作的后续工作..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NikeFactory</span> <span class="keyword">implements</span> <span class="title">ClothFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produceCloth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Nike生产中..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticProxyTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        NikeFactory nikeFactory = <span class="keyword">new</span> NikeFactory();</span><br><span class="line">        ProxyClothFactory proxyClothFactory = <span class="keyword">new</span> ProxyClothFactory(nikeFactory);</span><br><span class="line">        proxyClothFactory.produceCloth();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="动态代理展示"><a href="#动态代理展示" class="headerlink" title="动态代理展示"></a>动态代理展示</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high4.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态代理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Human</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getBelief</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">eat</span><span class="params">(String food)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SuperMan</span> <span class="keyword">implements</span> <span class="title">Human</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBelief</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"fly"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">(String food)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"I like eat "</span> + food);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 要实现动态代理需要解决的问题</span></span><br><span class="line"><span class="comment">* p1: 如何根据加载到内存中的被代理类，动态创建一个代理类及其对象?</span></span><br><span class="line"><span class="comment">* p2: 当通过代理类的对象调用方法时，如何动态的去调用被代理类中的同名方法?</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyFactory</span> </span>&#123;</span><br><span class="line"><span class="comment">//    调用此方法，返回一个代理类的对象，解决p1</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getProxyInstance</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        MyInvocationHandler myInvocationHandler = <span class="keyword">new</span> MyInvocationHandler();</span><br><span class="line">        myInvocationHandler.bind(obj);</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(obj.getClass().getClassLoader(), obj.getClass().getInterfaces(), myInvocationHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object obj; <span class="comment">// 需要使用被代理类的对象进行赋值</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    当我们通过代理类的对象，调用方法a时，会自动的调用如下方法: invoke()</span></span><br><span class="line"><span class="comment">//    将被代理类要执行的方法a的功能声明在invoke()中</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        method: 即为代理类对象调用的方法，此方法也就作为了被代理类对象要调用的方法</span></span><br><span class="line">        Object returnValue = method.invoke(obj, args);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SuperMan superMan = <span class="keyword">new</span> SuperMan();</span><br><span class="line">        Human proxyInstance = (Human)ProxyFactory.getProxyInstance(superMan);</span><br><span class="line">        String belief = proxyInstance.getBelief();</span><br><span class="line">        System.out.println(belief);</span><br><span class="line">        proxyInstance.eat(<span class="string">"beef"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        NikeFactory nikeFactory = <span class="keyword">new</span> NikeFactory();</span><br><span class="line">        ClothFactory proxyInstance = (ClothFactory)ProxyFactory.getProxyInstance(nikeFactory);</span><br><span class="line">        proxyInstance.produceCloth();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Stream、Lambda、Optional"><a href="#Stream、Lambda、Optional" class="headerlink" title="Stream、Lambda、Optional"></a>Stream、Lambda、Optional</h2><h3 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high5.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Stream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1. Stream关注的是对数据的操作，与CPU打交道</span></span><br><span class="line"><span class="comment"> *    集合关注的是对数据的存储，与内存打交道</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2.    Stream自己不会存储数据</span></span><br><span class="line"><span class="comment"> *       Stream不会改变源对象，会返回一个持有结果的新Stream</span></span><br><span class="line"><span class="comment"> *       Stream操作是延迟执行的，意味他们会等到需要结果的时候才执行</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 3. Stream执行流程</span></span><br><span class="line"><span class="comment"> *      实例化</span></span><br><span class="line"><span class="comment"> *      一系列中间操作(过滤、映射。。。)</span></span><br><span class="line"><span class="comment"> *      终止操作</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 4. 说明</span></span><br><span class="line"><span class="comment"> *      一个中间操作链，对数据源的数据进行处理</span></span><br><span class="line"><span class="comment"> *      一旦执行终止操作，就执行中间链操作，并产生结果。之后不会再被使用</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  排序</span></span><br><span class="line"><span class="comment"> *  sorted() 自然排序</span></span><br><span class="line"><span class="comment"> *  sorted(Comparable cob) 定制排序</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  匹配与查找</span></span><br><span class="line"><span class="comment"> *  https://tva1.sinaimg.cn/large/008i3skNgy1gq9vmoe9x8j31uq0ps7wh.jpg</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  allMatch -&gt; every</span></span><br><span class="line"><span class="comment"> *  anyMatch -&gt; some</span></span><br><span class="line"><span class="comment"> *  noneMatch -&gt; 与every相反</span></span><br><span class="line"><span class="comment"> *  findFirst</span></span><br><span class="line"><span class="comment"> *  findAny</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  count</span></span><br><span class="line"><span class="comment"> *  max(Comparable cob)</span></span><br><span class="line"><span class="comment"> *  min(Comparable cob)</span></span><br><span class="line"><span class="comment"> *  forEach(Consumer c) 内部迭代</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  reduce -&gt; reduce, java只是初始值位置在前</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  相当于语法转换之后多了几个方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamApiTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">        IntStream stream = Arrays.stream(arr);</span><br><span class="line">        System.out.println(stream);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Stream&lt;Integer&gt; integerStream = Stream.of(<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(integerStream);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        无限流</span></span><br><span class="line">        Stream.iterate(<span class="number">0</span>, t -&gt; t + <span class="number">2</span>).limit(<span class="number">10</span>).forEach(System.out :: println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; strings = Arrays.asList(<span class="string">"aaa"</span>, <span class="string">"bbb"</span>, <span class="string">"ccc"</span>);</span><br><span class="line">        strings.stream().map(String::toUpperCase).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Lambda"><a href="#Lambda" class="headerlink" title="Lambda"></a>Lambda</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high5.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Consumer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Lambda表达式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 使用, 有6种</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 本质</span></span><br><span class="line"><span class="comment"> * 作为函数式接口的实例。。。js箭头函数，只不过java里是作为接口的实例</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 函数式接口: 只有一个抽象方法的接口 <span class="doctag">@FunctionInterface</span></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * java内置4大核心函数式接口</span></span><br><span class="line"><span class="comment"> * https://tva1.sinaimg.cn/large/008i3skNly1gq0rmg8qe0j30s407qjvr.jpg</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 方法引用</span></span><br><span class="line"><span class="comment"> * 当要传递给Lambda体的操作，已经有实现的方法了，可以使用方法引用。</span></span><br><span class="line"><span class="comment"> * 本质就是Lambda表达式</span></span><br><span class="line"><span class="comment"> * 使用格式: 类(或对象) :: 方法名</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 3种使用情况</span></span><br><span class="line"><span class="comment"> * 对象 :: 非静态方法</span></span><br><span class="line"><span class="comment"> * 类 :: 静态方法</span></span><br><span class="line"><span class="comment"> * 类 :: 非静态方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LambdaTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Runnable r1 = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"哈哈哈哈"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        r1.run();</span><br><span class="line"></span><br><span class="line">        Runnable r2 = () -&gt; System.out.println(<span class="string">"呵呵呵呵"</span>);</span><br><span class="line"></span><br><span class="line">        r2.run();</span><br><span class="line"></span><br><span class="line">        Comparator&lt;Integer&gt; com1 = (o1, o2) -&gt; Integer.compare(o1, o2);</span><br><span class="line">        <span class="keyword">int</span> compare1 = com1.compare(<span class="number">12</span>, <span class="number">21</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(compare1);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        方法引用</span></span><br><span class="line">        Comparator&lt;Integer&gt; com2 = Integer::compare;</span><br><span class="line">        <span class="keyword">int</span> compare2 = com2.compare(<span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">        System.out.println(compare2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="comment">//       1. 无参无返回值</span></span><br><span class="line"><span class="comment">//        同test1的r2</span></span><br><span class="line"><span class="comment">//        2. 需要一个参数，但是没有返回值</span></span><br><span class="line">        Consumer&lt;String&gt; consumer = <span class="keyword">new</span> Consumer&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">                System.out.println(s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        consumer.accept(<span class="string">"啦啦啦啦啦啦"</span>);</span><br><span class="line"></span><br><span class="line">        Consumer&lt;String&gt; consumer1 = (String s) -&gt; System.out.println(s);</span><br><span class="line"></span><br><span class="line">        consumer1.accept(<span class="string">"biu"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        3. 数据类型可以省略，因为类型推断，省略类型声明即可</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        4. 若只需一个参数，参数小括号可以省略</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        5. 需要两个或以上参数，多条执行语句，并且可以有返回值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        6. 当lambda体只有一条语句时，return与大括号若有，都可以省略</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Optional"><a href="#Optional" class="headerlink" title="Optional"></a>Optional</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> high5.com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Optional</span></span><br><span class="line"><span class="comment"> * Optional&lt;T&gt;类 是一个容器类，可以保存类型T的值，代表这个值存在。或者仅仅保存null，表示这个值不存在。可以避免空指针异常。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * isPresent() Optional封装的数据是否包含数据</span></span><br><span class="line"><span class="comment"> * of(T t) 包装的数据t要非空 与get()搭配</span></span><br><span class="line"><span class="comment"> * ofNullable(T t) 封装数据t赋给Optional内部的value.不要求t非空 与orElse搭配</span></span><br><span class="line"><span class="comment"> * orElse(T t) 如果Optional内部的value非空，则返回此value值，如果value胃口，则返回t</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OptionalTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Optional&lt;Object&gt; empty = Optional.empty();</span><br><span class="line">        System.out.println(empty.isPresent());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String str1 = <span class="string">"String 123"</span>;</span><br><span class="line">        Optional&lt;String&gt; str11 = Optional.of(str1);</span><br><span class="line">        String s = str11.get();</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String aaaæa = <span class="string">"aaaæa"</span>;</span><br><span class="line">        Optional&lt;String&gt; aaaæa1 = Optional.ofNullable(aaaæa);</span><br><span class="line">        String bbbbbb = aaaæa1.orElse(<span class="string">"bbbbbb"</span>);</span><br><span class="line">        System.out.println(bbbbbb);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2021/03/24/java高级/" data-id="ckonxihuw000dttyzmjickctu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-SSO实践" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2021/02/03/SSO实践/" class="article-date">
  <time datetime="2021-02-03T12:18:58.000Z" itemprop="datePublished">2021-02-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2021/02/03/SSO实践/">SSO实践</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2021/02/03/SSO实践/" data-id="ckonxihud0000ttyzkyap4h5t" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/单点登录-SSO/">单点登录 SSO</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-微前端实践" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2021/02/03/微前端实践/" class="article-date">
  <time datetime="2021-02-03T12:18:24.000Z" itemprop="datePublished">2021-02-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2021/02/03/微前端实践/">微前端实践</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>通过 umi 搭建了 4 个应用，1 个基座，3 个子应用<br><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnam4jeju2j31c80u0h8x.jpg" alt="项目示例"></p>
<p>项目版本相关<br><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnand5hqy7j30wy0pejus.jpg" alt="版本"></p>
<h2 id="基座"><a href="#基座" class="headerlink" title="基座"></a>基座</h2><p><code>.umirc</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#123;</span><br><span class="line">    routes: [</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/'</span>,</span><br><span class="line">            component: <span class="string">'@/pages/index'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/login'</span>,</span><br><span class="line">            component: <span class="string">'@/pages/login/index'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/app1'</span>,</span><br><span class="line">            microApp: <span class="string">'app1'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/app2'</span>,</span><br><span class="line">            microApp: <span class="string">'app2'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/app3'</span>,</span><br><span class="line">            microApp: <span class="string">'app3'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    ],</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        port: <span class="number">7000</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    qiankun: &#123;</span><br><span class="line">        master: &#123;</span><br><span class="line">        apps: [</span><br><span class="line">            &#123;</span><br><span class="line">                name: <span class="string">'app1'</span>, <span class="comment">// 唯一 id</span></span><br><span class="line">                entry: <span class="string">'//localhost:7001'</span>, <span class="comment">// app1 entry</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                name: <span class="string">'app2'</span>, <span class="comment">// 唯一 id</span></span><br><span class="line">                entry: <span class="string">'//localhost:7002'</span>, <span class="comment">// app2 entry</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                name: <span class="string">'app3'</span>, <span class="comment">// 唯一 id</span></span><br><span class="line">                entry: <span class="string">'//localhost:7003'</span>, <span class="comment">// app3 entry</span></span><br><span class="line">            &#125;,</span><br><span class="line">          ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="子应用配置"><a href="#子应用配置" class="headerlink" title="子应用配置"></a>子应用配置</h2><p>app1 <code>.umirc</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        port: <span class="number">7001</span>,</span><br><span class="line">        headers: &#123;</span><br><span class="line">            <span class="string">'Access-Control-Allow-Origin'</span>: <span class="string">'*'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    publicPath: <span class="string">'http://localhost:7001/'</span>,</span><br><span class="line">    runtimePublicPath: <span class="literal">true</span>,</span><br><span class="line">    qiankun: &#123;</span><br><span class="line">        slave: &#123;&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同理app2、app3换下端口</span></span><br></pre></td></tr></table></figure>

<p>对应项目<code>package.json</code>name 需换成<code>app1, app2, app3</code>与基座 id 对应注册</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"app1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="通信"><a href="#通信" class="headerlink" title="通信"></a>通信</h2><p>基座需在<code>app.ts</code>导出函数<code>useQiankunStateForSlave</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useQiankunStateForSlave</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [masterState, setMasterState] = useState(&#123;</span><br><span class="line">    a: <span class="number">1</span>,</span><br><span class="line">    b: <span class="number">2</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 可自定义传入一些函数</span></span><br><span class="line">  <span class="keyword">const</span> showMasterMessage = (</span><br><span class="line">    msg: <span class="built_in">any</span>,</span><br><span class="line">    <span class="keyword">type</span>: Partial&lt;keyof MessageApi&gt;</span><br><span class="line">  ): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">    message[<span class="keyword">type</span>](msg, <span class="number">2</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// useModel获取model里的数据进行消费</span></span><br><span class="line">  <span class="keyword">const</span> user = useModel(<span class="string">"user"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    masterState,</span><br><span class="line">    setMasterState,</span><br><span class="line">    user,</span><br><span class="line">    showMasterMessage,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主应用登录后的信息<br><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gnangrbc37j315h0u0ae7.jpg" alt></p>
<p>子应用同源使用 localstorage 的 token 与用户信息</p>
<h2 id="nginx-配置"><a href="#nginx-配置" class="headerlink" title="nginx 配置"></a>nginx 配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"># 配置各子应用可以独立打开，也可以集成在主应用里</span><br><span class="line"># 需处理好子应用的独立环境与集成环境</span><br><span class="line">server &#123;</span><br><span class="line">    listen       7000;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    add_header Access-Control-Allow-Origin *;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root  /usr/local/var/www/home/main_dist;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        try_files $uri $uri/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       7001;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    add_header Access-Control-Allow-Origin *;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root  /usr/local/var/www/home/app1;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        try_files $uri $uri/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       7002;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    add_header Access-Control-Allow-Origin *;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root  /usr/local/var/www/home/app2;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        try_files $uri $uri/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       7003;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    add_header Access-Control-Allow-Origin *;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root  /usr/local/var/www/home/app3;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        try_files $uri $uri/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># ...</span><br></pre></td></tr></table></figure>

<h2 id="非独立部署"><a href="#非独立部署" class="headerlink" title="非独立部署"></a>非独立部署</h2><p>集成在一起</p>
<ol>
<li>公共模块抽离</li>
<li>减少代码体积</li>
<li>快速部署</li>
</ol>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>1.样式问题</p>
<p>解决方案:</p>
<blockquote>
<p>1.BEM<br>2.css-in-js<br>3.shadow dom</p>
</blockquote>
<ol start="2">
<li>模块抽离、代码共享</li>
</ol>
<p>解决方案:</p>
<blockquote>
<p>1.共享组件库 专人管理多维护</p>
</blockquote>
<ol start="3">
<li><p>跨应用通信</p>
</li>
<li><p>重复下载文件</p>
</li>
</ol>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2021/02/03/微前端实践/" data-id="ckonxihuy000httyzg8e1i0tj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/qiankun-微前端-umi/">qiankun 微前端 umi</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-配置eslint与prettier" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2021/01/23/配置eslint与prettier/" class="article-date">
  <time datetime="2021-01-23T08:26:35.000Z" itemprop="datePublished">2021-01-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2021/01/23/配置eslint与prettier/">配置 eslint 与 prettier</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="配置-eslint-与-prettier"><a href="#配置-eslint-与-prettier" class="headerlink" title="配置 eslint 与 prettier"></a>配置 eslint 与 prettier</h1><p><a href="https://github.com/wangqinyong1994/taro-template">个人目前习惯配置</a>，该配置为 taro3 后的改造。</p>
<h2 id="开发工具"><a href="#开发工具" class="headerlink" title="开发工具"></a>开发工具</h2><ol>
<li>babel-eslint：这个包让你可以轻松在 Babel 上使用 lint。如果你不使用 ESLint 尚不支持的 Flow 或实验性功能，则不一定需要这个插件。</li>
<li>eslint：这是 lint 代码所需的主要工具。</li>
<li>eslint-config-airbnb：这个包提供了所有 Airbnb 的 ESLint 配置，你可以修改它们。</li>
<li>eslint-plugin-babel：babel-eslint 的插件伴侣。</li>
<li>eslint-plugin-import：这个插件旨在支持 ES2015+（ES6+）的导入 / 导出语法，并防止出现拼写错误的文件路径和导入名称。</li>
<li>eslint-plugin-jsx-a11y：适用于 JSX 元素可访问性规则的 linting 规则。</li>
<li>eslint-plugin-prettier：让 ESLint 与 Prettier 的使用更顺畅。</li>
<li>eslint-plugin-react：特定于 React 的 linting 规则。</li>
<li>eslint-config-jest-enzyme：用于特定于 React 和 Enzyme 的全局变量。这个 lint 配置让 ESLint 知道有哪些全局变量，并且不会针对它们发出警告——有点像断言 it 和 describe。</li>
<li>eslint-plugin-jest：Jest 的 ESLint 插件。</li>
<li>husky：在自动化部分会进行更多介绍。</li>
<li>lint-staged：在自动化部分会进行更多介绍。</li>
</ol>
<h2 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">    "lint": "eslint --debug src/",</span><br><span class="line">    "lint:write": "eslint --debug src/ --fix",</span><br><span class="line">    "prettier": "prettier --write src/**/*.js"</span><br><span class="line">  &#125;,</span><br><span class="line">"husky": &#123;</span><br><span class="line">  "hooks": &#123;</span><br><span class="line">    "pre-commit": "lint-staged"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">"lint-staged": &#123;</span><br><span class="line">  "*.(js|jsx)": ["npm run lint:write", "git add"]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="editorconfig"><a href="#editorconfig" class="headerlink" title=".editorconfig"></a>.editorconfig</h2><p>基本配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># EditorConfig is awesome: http://EditorConfig.org</span><br><span class="line"></span><br><span class="line"># top-most EditorConfig file</span><br><span class="line">root = true</span><br><span class="line"></span><br><span class="line">[*.md]</span><br><span class="line">trim_trailing_whitespace = false</span><br><span class="line"></span><br><span class="line">[*.js]</span><br><span class="line">trim_trailing_whitespace = true</span><br><span class="line"></span><br><span class="line"># Unix-style newlines with a newline ending every file</span><br><span class="line">[*]</span><br><span class="line">indent_style = space # 将缩进样式设置为空格而不是制表符；</span><br><span class="line">indent_size = 2 # 缩进大小为 2；</span><br><span class="line">end_of_line = lf # 行尾是 lf，这样不管使用的是哪种操作系统，都会有相同的行尾；</span><br><span class="line">charset = utf-8</span><br><span class="line">insert_final_newline = true # 文件末尾应该有一个新行；</span><br><span class="line">max_line_length = 120 # 单行的最大度应为 120 个字符。</span><br></pre></td></tr></table></figure>

<h2 id="eslintrc-js"><a href="#eslintrc-js" class="headerlink" title=".eslintrc.js"></a>.eslintrc.js</h2><ol>
<li><p>规则控制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;off&quot;或者0     //关闭规则关闭</span><br><span class="line">&quot;warn&quot;或者1    //在打开的规则作为警告（不影响退出代码）</span><br><span class="line">&quot;error&quot;或者2   //把规则作为一个错误（退出代码触发时为1）</span><br></pre></td></tr></table></figure>
</li>
<li><p>eslint 规则配置 off=0 warn=1 error=2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">&quot;rules&quot;: &#123;</span><br><span class="line">    &quot;indent&quot;: [2, 2], // 控制缩进为2</span><br><span class="line">    &quot;eqeqeq&quot;: 1,// 警告使用全等</span><br><span class="line">    &quot;quotes&quot;: [2, &quot;single&quot;], //单引号</span><br><span class="line">    &quot;no-console&quot;: 0, //不禁用console</span><br><span class="line">    &quot;no-debugger&quot;: 1, //禁用debugger</span><br><span class="line">    &quot;no-var&quot;: 2, //对var警告</span><br><span class="line">    &quot;semi&quot;: 2, //强制使用分号</span><br><span class="line">    &quot;semi-spacing&quot;: [2, &#123;&quot;before&quot;: false, &quot;after&quot;: true&#125;], // 强制分号前后不允许空格</span><br><span class="line">    &quot;no-irregular-whitespace&quot;: 0, //不规则的空白不允许</span><br><span class="line">    &quot;no-trailing-spaces&quot;: 1, //一行结束后面有空格就发出警告</span><br><span class="line">    &quot;eol-last&quot;: 0, //文件以单一的换行符结束</span><br><span class="line">    &quot;no-unused-vars&quot;: [2, &#123;&quot;vars&quot;: &quot;all&quot;, &quot;args&quot;: &quot;after-used&quot;&#125;], //不能有声明后未被使用的变量或参数</span><br><span class="line">    &quot;no-underscore-dangle&quot;: 0, //标识符不能以_开头或结尾</span><br><span class="line">    &quot;no-alert&quot;: 2, //禁止使用alert confirm prompt</span><br><span class="line">    &quot;no-lone-blocks&quot;: 0, //禁止不必要的嵌套块</span><br><span class="line">    &quot;no-class-assign&quot;: 2, //禁止给类赋值</span><br><span class="line">    &quot;no-cond-assign&quot;: 2, //禁止在条件表达式中使用赋值语句</span><br><span class="line">    &quot;no-const-assign&quot;: 2, //禁止修改const声明的变量</span><br><span class="line">    &quot;no-delete-var&quot;: 2, //不能对var声明的变量使用delete操作符</span><br><span class="line">    &quot;no-dupe-keys&quot;: 2, //在创建对象字面量时不允许键重复</span><br><span class="line">    &quot;no-duplicate-case&quot;: 2, //switch中的case标签不能重复</span><br><span class="line">    &quot;no-dupe-args&quot;: 2, //函数参数不能重复</span><br><span class="line">    &quot;no-empty&quot;: 2, //块语句中的内容不能为空</span><br><span class="line">    &quot;no-func-assign&quot;: 2, //禁止重复的函数声明</span><br><span class="line">    &quot;no-invalid-this&quot;: 0, //禁止无效的this，只能用在构造器，类，对象字面量</span><br><span class="line">    &quot;no-redeclare&quot;: 2, //禁止重复声明变量</span><br><span class="line">    &quot;no-spaced-func&quot;: 2, //函数调用时 函数名与()之间不能有空格</span><br><span class="line">    &quot;no-this-before-super&quot;: 0, //在调用super()之前不能使用this或super</span><br><span class="line">    &quot;no-undef&quot;: 2, //不能有未定义的变量</span><br><span class="line">    &quot;no-use-before-define&quot;: 2, //未定义前不能使用</span><br><span class="line">    &quot;camelcase&quot;: 0, //强制驼峰法命名</span><br><span class="line">    &quot;jsx-quotes&quot;: [2, &quot;prefer-double&quot;], //强制在JSX属性（jsx-quotes）中一致使用双引号</span><br><span class="line">    &quot;react/display-name&quot;: 0, //防止在React组件定义中丢失displayName</span><br><span class="line">    &quot;react/forbid-prop-types&quot;: [2, &#123;&quot;forbid&quot;: [&quot;any&quot;]&#125;], //禁止某些propTypes</span><br><span class="line">    &quot;react/jsx-boolean-value&quot;: 2, //在JSX中强制布尔属性符号</span><br><span class="line">    &quot;react/jsx-closing-bracket-location&quot;: 1, //在JSX中验证右括号位置</span><br><span class="line">    &quot;react/jsx-curly-spacing&quot;: [2, &#123;&quot;when&quot;: &quot;never&quot;, &quot;children&quot;: true&#125;], //在JSX属性和表达式中加强或禁止大括号内的空格。</span><br><span class="line">    &quot;react/jsx-indent&quot;: [2,2], // 语法缩进控制</span><br><span class="line">    &quot;react/jsx-indent-props&quot;: [2, 2], //验证JSX中的props缩进是否为2个</span><br><span class="line">    &quot;react/jsx-key&quot;: 2, //在数组或迭代器中验证JSX具有key属性</span><br><span class="line">    &quot;react/jsx-max-props-per-line&quot;: [1, &#123;&quot;maximum&quot;: 1&#125;], // 限制JSX中单行上的props的最大数量</span><br><span class="line">    &quot;react/jsx-no-bind&quot;: 0, //JSX中不允许使用箭头函数和bind</span><br><span class="line">    &quot;react/jsx-no-duplicate-props&quot;: 2, //防止在JSX中重复的props</span><br><span class="line">    &quot;react/jsx-no-literals&quot;: 0, //防止使用未包装的JSX字符串</span><br><span class="line">    &quot;react/jsx-no-undef&quot;: 1, //在JSX中禁止未声明的变量</span><br><span class="line">    &quot;react/jsx-pascal-case&quot;: 0, //为用户定义的JSX组件强制使用PascalCase</span><br><span class="line">    &quot;react/jsx-sort-props&quot;: 2, //强化props按字母排序</span><br><span class="line">    &quot;react/jsx-uses-react&quot;: 1, //防止反应被错误地标记为未使用</span><br><span class="line">    &quot;react/jsx-uses-vars&quot;: 2, //防止在JSX中使用的变量被错误地标记为未使用</span><br><span class="line">    &quot;react/no-danger&quot;: 0, //防止使用危险的JSX属性</span><br><span class="line">    &quot;react/no-did-mount-set-state&quot;: 0, //防止在componentDidMount中使用setState</span><br><span class="line">    &quot;react/no-did-update-set-state&quot;: 1, //防止在componentDidUpdate中使用setState</span><br><span class="line">    &quot;react/no-direct-mutation-state&quot;: 2, //防止this.state的直接变异</span><br><span class="line">    &quot;react/no-multi-comp&quot;: 2, //防止每个文件有多个组件定义</span><br><span class="line">    &quot;react/no-set-state&quot;: 0, //防止使用setState</span><br><span class="line">    &quot;react/no-unknown-property&quot;: 2, //防止使用未知的DOM属性</span><br><span class="line">    &quot;react/prefer-es6-class&quot;: 2, //为React组件强制执行ES5或ES6类</span><br><span class="line">    &quot;react/prop-types&quot;: 0, //防止在React组件定义中丢失props验证</span><br><span class="line">    &quot;react/react-in-jsx-scope&quot;: 2, //使用JSX时防止丢失React</span><br><span class="line">    &quot;react/self-closing-comp&quot;: 0, //防止没有children的组件的额外结束标签</span><br><span class="line">    &quot;react/sort-comp&quot;: 2, //强制组件方法顺序</span><br><span class="line">    &quot;no-extra-boolean-cast&quot;: 0, //禁止不必要的bool转换</span><br><span class="line">    &quot;react/no-array-index-key&quot;: 0, //防止在数组中遍历中使用数组key做索引</span><br><span class="line">    &quot;react/no-deprecated&quot;: 1, //不使用弃用的方法</span><br><span class="line">    &quot;react/jsx-equals-spacing&quot;: 2, //在JSX属性中强制或禁止等号周围的空格</span><br><span class="line">    &quot;no-unreachable&quot;: 1, //不能有无法执行的代码</span><br><span class="line">    &quot;comma-dangle&quot;: [&quot;error&quot;, &quot;always&quot;], //对象字面量项尾必须有逗号</span><br><span class="line">    &quot;no-mixed-spaces-and-tabs&quot;: 0, //禁止混用tab和空格</span><br><span class="line">    &quot;prefer-arrow-callback&quot;: 0, //比较喜欢箭头回调</span><br><span class="line">    &quot;arrow-parens&quot;: 0, //箭头函数用小括号括起来</span><br><span class="line">    &quot;arrow-spacing&quot;: 0, //=&gt;的前/后括号</span><br><span class="line">    &quot;prefer-const&quot;: [&quot;error&quot;, &#123;</span><br><span class="line">      &quot;destructuring&quot;: &quot;all&quot;</span><br><span class="line">    &#125;],</span><br><span class="line">    &quot;prefer-destructuring&quot;: [&quot;error&quot;, &#123;</span><br><span class="line">      &quot;VariableDeclarator&quot;: &#123;</span><br><span class="line">        &quot;array&quot;: false,</span><br><span class="line">        &quot;object&quot;: true</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;AssignmentExpression&quot;: &#123;</span><br><span class="line">        &quot;array&quot;: false,</span><br><span class="line">        &quot;object&quot;: false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      &quot;enforceForRenamedProperties&quot;: false</span><br><span class="line">    &#125;],</span><br><span class="line">    &quot;use-isnan&quot;: 2,//禁止比较时使用NaN，只能用isNaN()</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;import/ignore&quot;: [</span><br><span class="line">      &quot;node_modules&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>rules</code>外参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于预定义全局变量</span></span><br><span class="line">  env: &#123;</span><br><span class="line">    es6: <span class="literal">true</span>, <span class="comment">// 启动es6全局变量</span></span><br><span class="line">    browser: <span class="literal">true</span>, <span class="comment">// 浏览器全局变量window, document等</span></span><br><span class="line">    node: <span class="literal">true</span>, <span class="comment">// 启用node全局变量global等</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 扩展了之面配置的额外配置选项。</span></span><br><span class="line">  <span class="comment">// 现在我们正在使用 airbnb 的 linting 规则，这些规则被扩展到 jest，然后是 jest-enzyme。</span></span><br><span class="line">  extends: [<span class="string">'airbnb'</span>, <span class="string">'plugin:jest/recommended'</span>, <span class="string">'jest-enzyme'</span>],</span><br><span class="line">  <span class="comment">// 插件基本上就是我们想要使用的 linting 规则</span></span><br><span class="line">  plugins: [<span class="string">'babel'</span>, <span class="string">'import'</span>, <span class="string">'jsx-a11y'</span>, <span class="string">'react'</span>, <span class="string">'prettier'</span>],</span><br><span class="line">  <span class="comment">// 默认情况下，ESLint 使用 Espree，但因为我们使用了 babel，我们还需要使用 Babel-ESLint</span></span><br><span class="line">  parser: <span class="string">'babel-eslint'</span>,</span><br><span class="line">  <span class="comment">// 如果我们将 Espree 的默认解析器更改为 babel-eslint，需要指定 parserOptions</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  告诉 ESLint，ecmaVersion 是 6。</span></span><br><span class="line"><span class="comment">  因为我们在 EcmaScript 模块（而不是 script）中编写代码，所以我们将 sourceType 指定为 module。</span></span><br><span class="line"><span class="comment">  由于我们使用了 React，引入了 JSX，所以在 ecmaFeatures 中加了 jsx 选项，并将其设置为 true。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  parserOptions: &#123;</span><br><span class="line">    ecmaVersion: <span class="number">6</span>,</span><br><span class="line">    sourceType: <span class="string">'module'</span>,</span><br><span class="line">    ecmaFeatures: &#123;</span><br><span class="line">      jsx: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2021/01/23/配置eslint与prettier/" data-id="ckonxihv3000rttyzx6l16acq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/vscode-eslint-prettier/">vscode eslint prettier</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-java基础" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/12/30/java基础/" class="article-date">
  <time datetime="2020-12-30T13:21:48.000Z" itemprop="datePublished">2020-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/12/30/java基础/">Java基础</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><h3 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h3><ul>
<li><p>整型</p>
<p>byte 1 字节=8bit -128~127</p>
<p>short 2 字节 -2^15~2^15 - 1</p>
<p>int 4 字节 -2^31~2^31 - 1(约 21 亿)</p>
<p>long 8 字节 -2^63~2^63 - 1</p>
</li>
<li><p>浮点型</p>
<p>float 4 字节 -3.403E38 ～ 3.403E38</p>
<p>double 8 字节 -1.798E308 ～ 1.798E308</p>
</li>
<li><p>字符型</p>
<p>char 1 字符 = 2 字节</p>
</li>
<li><p>布尔型 boolean</p>
</li>
</ul>
<p>整型</p>
<ol>
<li>声明 long 变量，必须以”L”或”l”结尾</li>
<li>一般 int 够用</li>
</ol>
<p>浮点型(表示带小数点的数值)</p>
<ol>
<li>Java 浮点型默认为 double，声明 float 型，后面要加”F”或”f”</li>
<li>double 精度是 float 的两倍，一般默认采用 double</li>
</ol>
<p>字符型</p>
<ol>
<li>定义时，使用’’(单引号)</li>
<li>内部只能是一个字符</li>
<li>可以是转义字符(\n), 可以是 unicode 值</li>
</ol>
<p>布尔型</p>
<h3 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h3><ul>
<li>类 class</li>
<li>接口 interface</li>
<li>数组 array</li>
<li>字符串 String 定义时””(双引号)</li>
</ul>
<h3 id="自动转换"><a href="#自动转换" class="headerlink" title="自动转换"></a>自动转换</h3><p>容量小的数据类型变量与容量大的做运算时，<strong>自动提升为容量大的数据类型</strong></p>
<p><strong>容量大小值表示数范围的大和小</strong>，如 float 要比 long 大</p>
<p>结论： byte、char、short –&gt; int –&gt; long –&gt; float –&gt; double</p>
<p>当 byte、char、short 做运算时，结果为 int 类型</p>
<h3 id="强制转换"><a href="#强制转换" class="headerlink" title="强制转换"></a>强制转换</h3><ol>
<li>要使用强转符()</li>
<li>可能导致精度损失</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> d1 = <span class="number">12.9</span>;</span><br><span class="line"><span class="keyword">int</span> i1 = (<span class="keyword">int</span>)d1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 没有精度损失</span></span><br><span class="line"><span class="keyword">long</span> l1 = <span class="number">123</span>;</span><br><span class="line"><span class="keyword">short</span> s1 = (<span class="keyword">short</span>)l1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 有精度损失</span></span><br><span class="line"><span class="keyword">int</span> i2 = <span class="number">128</span>;</span><br><span class="line"><span class="keyword">byte</span> b = (<span class="keyword">byte</span>)i2;</span><br><span class="line">System.out.printIn(b); <span class="comment">// -128</span></span><br></pre></td></tr></table></figure>

<h3 id="赋值运算"><a href="#赋值运算" class="headerlink" title="赋值运算"></a>赋值运算</h3><p>+=</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> num = <span class="number">10</span>;</span><br><span class="line">num += <span class="number">2</span>; <span class="comment">// num = num + 2; 12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">short</span> s = <span class="number">10</span>;</span><br><span class="line">s = s + <span class="number">2</span>; <span class="comment">// error</span></span><br><span class="line">s += <span class="number">2</span>; <span class="comment">// ok +=不改变变量本身数据类型</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &amp; 都为true才为true</span></span><br><span class="line"><span class="comment">// | 有一个为true就为true</span></span><br><span class="line"><span class="comment">// ^ 异才为true</span></span><br></pre></td></tr></table></figure>

<h3 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i = <span class="number">21</span>;</span><br><span class="line">i &lt;&lt; <span class="number">2</span> = <span class="number">21</span> * <span class="number">2</span> * <span class="number">2</span></span><br><span class="line">i &lt;&lt; <span class="number">2</span> = <span class="number">21</span> * <span class="number">2</span> * <span class="number">2</span> * <span class="number">2</span></span><br><span class="line"><span class="comment">// 每向左移 就是 * 2</span></span><br><span class="line"><span class="comment">// 一定程度（移出长度）为负，因为开头为1</span></span><br></pre></td></tr></table></figure>

<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一维数组声明与初始化</span></span><br><span class="line"><span class="comment">// 静态初始化: 数组的初始化和数组元素的赋值操作同时进行</span></span><br><span class="line"><span class="keyword">int</span>[] ids = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>,<span class="number">4</span>&#125;;</span><br><span class="line"><span class="comment">// 动态初始化: 数组的初始化和数组元素的赋值操作分开进行</span></span><br><span class="line">String[] names = <span class="keyword">new</span> String[<span class="number">4</span>];</span><br><span class="line"><span class="comment">// 二维数组</span></span><br><span class="line"><span class="keyword">int</span>[][] arr = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;&#123;<span class="number">1</span>, <span class="number">2</span>&#125;, &#123;<span class="number">3</span>, <span class="number">4</span>&#125;, &#123;<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;&#125;;</span><br><span class="line">String[][] arr1 = <span class="keyword">new</span> String[<span class="number">3</span>][<span class="number">2</span>]</span><br></pre></td></tr></table></figure>

<p>工具类方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// boolean equals(int[] a, int[] b); 判断两个数组是否相等</span></span><br><span class="line"><span class="keyword">int</span>[] arr1 = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line"><span class="keyword">int</span>[] arr2 = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line"><span class="keyword">boolean</span> isEquals = Arrays.equals(arr1, arr2);</span><br><span class="line"><span class="comment">// String toString(int[] a); 输出数组信息</span></span><br><span class="line">Arrays.toString(arr1);</span><br><span class="line"><span class="comment">// void fill(int[] a, int val); 填充</span></span><br><span class="line">Arrays.fill(arr1, <span class="number">10</span>);</span><br><span class="line"><span class="comment">// void sort(int[] a);</span></span><br><span class="line">Arrays.sort(arr1);</span><br><span class="line"><span class="comment">// int binarySearch(int[] a, int key)</span></span><br><span class="line">Arrays.binarySearch(arr1, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>常见异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数组越界异常: ArrayIndexOutOfBoundsException</span></span><br><span class="line"><span class="comment">// 空指针异常: NullPointerException</span></span><br></pre></td></tr></table></figure>

<h3 id="默认初始化值"><a href="#默认初始化值" class="headerlink" title="默认初始化值"></a>默认初始化值</h3><ul>
<li>整型: 0</li>
<li>浮点型: 0.0</li>
<li>字符型: 0 或’\u0000’</li>
<li>布尔型: false</li>
<li>引用类型: null</li>
</ul>
<p>局部变量没有初始化值，意味着调用局部变量之前，一定要显示赋值。</p>
<p>非 static 属性 局部变量加载到栈，属性加载到堆。</p>
<h3 id="重载"><a href="#重载" class="headerlink" title="重载"></a>重载</h3><p>允许定义一个以上重名方法</p>
<p>方法名相同， 参数可以各种不同，构成重载</p>
<p><strong>重载判断标准</strong>：</p>
<ul>
<li>两同一不同：同一个类相同方法名</li>
<li>参数列表不同、参数个数不同、参数类型不同</li>
<li>跟方法的权限修饰符、返回值类型、形参变量名、方法体都没有关系</li>
</ul>
<p>​ <img src="https://tva1.sinaimg.cn/large/0081Kckwly1glud0k0hhyj310s0lktkz.jpg" alt></p>
<p>​</p>
<h3 id="关于构造器"><a href="#关于构造器" class="headerlink" title="关于构造器"></a>关于构造器</h3><ul>
<li>如果没有显式定义类的构造器，则系统默认提供一个空参的构造器</li>
<li>定义构造器的格式：权限修饰符 类名(形参列表){}</li>
<li>一个类中定义的多个构造器，彼此构成重载</li>
<li>一旦显式定义了类的构造器，系统就不再提供默认的空参构造器</li>
<li>一个类中，至少会有一个构造器</li>
</ul>
<h3 id="对象属性的赋值顺序"><a href="#对象属性的赋值顺序" class="headerlink" title="对象属性的赋值顺序"></a>对象属性的赋值顺序</h3><ol>
<li>默认初始化</li>
<li>显式初始化/代码块。看这两个声明 谁先谁后</li>
<li>构造器中赋值</li>
<li>通过 <code>对象.方法</code> 或 <code>对象.属性</code> 的方式赋值</li>
</ol>
<h3 id="JavaBean"><a href="#JavaBean" class="headerlink" title="JavaBean"></a>JavaBean</h3><p>符合如下 Java 类</p>
<ul>
<li>类是公共的</li>
<li>有一个无参的公共的构造器</li>
<li>有属性，且有对应的 get、set 方法</li>
</ul>
<h3 id="this"><a href="#this" class="headerlink" title="this"></a>this</h3><ol>
<li>可以用来修饰：属性、方法、构造器</li>
<li>修饰属性和方法。this 理解为当前对象</li>
<li>通常可以省略，但是当方法的形参鱼类属性同名时，必须显式去用<code>this</code></li>
</ol>
<h4 id="this-调用构造器"><a href="#this-调用构造器" class="headerlink" title="this 调用构造器"></a>this 调用构造器</h4><ol>
<li>在类的构造器中，可以显式使用<code>this(形参列表)</code>方式，调用本类中指定的构造器</li>
<li>构造器中不能通过<code>this(形参列表)</code>方式调用自己</li>
<li>如果一个类中有 n 个构造器，则最多有 n-1 个构造器中使用了<code>this(形参列表)</code></li>
<li>规定：<code>this(形参列表)</code>必须声明在当前构造器中的首行</li>
<li>构造器内部，最多只能声明一个<code>this(形参列表)</code>，用来调用其他构造器</li>
</ol>
<h3 id="package"><a href="#package" class="headerlink" title="package"></a>package</h3><ol>
<li>为了实现项目中类的管理</li>
<li>使用 package 声明类或接口所属的包，放首行</li>
<li>规范、看了要能懂，语义化</li>
<li>每`.``一次，就代表一层文件目录</li>
<li>同一个包下，不能命名同名的接口、类。</li>
</ol>
<h3 id="import"><a href="#import" class="headerlink" title="import"></a>import</h3><ol>
<li>导入指定包下的类、接口</li>
<li>声明在包与类之间</li>
<li>可以使用<code>xxx.*</code>表示可以导入 xxx 包下的所有结构</li>
<li><code>Java.lang</code>下面的可以省略</li>
<li>类或接口是本包下定义的，可以省略</li>
<li>源文件中使用不同包下重名的类，则必须至少有一个全类名的方式显示</li>
<li>使用<code>xxx.*</code>表示可以导入 xxx 包下的所有结构，但是如果使用的是 xxx 子包下的结构，仍需要显示引入</li>
<li>import static: 表示引入类或接口中的静态结构：属性或方法。</li>
</ol>
<h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><ol>
<li>一旦子类 A 继承父类 B，子类 A 就获取了父类 B 中声明的结构(属性、方法)。私有也能获取，只是因为封装性影响，不能直接调用父类的结构。</li>
<li>一个类只能有一个父类</li>
<li>子类直接继承的父类叫直接父类，间接的叫间接父类</li>
<li>子类继承父类后，就获取了直接父类以及所有间接父类中声明的属性和方法</li>
<li>如果没有显式声明一个类的父类，则此类继承自 java.lang.Object 类</li>
<li>所有的 java 类(除 java.lang.Object)，都直接或间接继承自 java.lang.Object 类</li>
</ol>
<h3 id="override"><a href="#override" class="headerlink" title="override"></a>override</h3><ol>
<li>子类继承父类后，可以对父类中同名同参数的方法，进行覆盖操作</li>
<li>应用重写以后，当创建子类对象以后，通过子类对象调用子父类中的同名同参数方法时，世纪执行的是子类重写父类的方法。</li>
<li>重写规定<ul>
<li>方法名和形参列表相同</li>
<li>子类重写方法的权限修饰符不小于父类的</li>
<li>子类不能重写父类的 private 方法</li>
<li>返回值类型<ul>
<li>父类被重写方法的返回值类型是 void，子也要 void</li>
<li>父类被重写方法的返回值类型是 A 类型，子返回可以是 A 或 A 的子类</li>
<li>父类被重写方法的返回值类型是基本数据类型，子也要一样</li>
</ul>
</li>
</ul>
</li>
<li>子类重写的方法抛出的异常类型不大于父类被重写方法抛出的异常类型。</li>
<li>子类与父类中的同名参数方法要么都声明为非 static(考虑重写)，要么都声明为 static(不是重写)</li>
</ol>
<h3 id="super"><a href="#super" class="headerlink" title="super"></a>super</h3><ol>
<li>理解为父类的</li>
<li>可以调用 属性方法构造器</li>
<li>super 调用属性和方法：通常子类中可以省略 this、super，子类没有就找父类，都有的话可以用 this、super 区分子父</li>
<li>super 调用构造器 ：<ol>
<li>可以在子类构造器中显示使用<code>super(形参列表)</code>的方式，调用父类中指定的构造器</li>
<li><code>super(形参列表)</code>使用，必须声明在子类构造器首行</li>
<li>类构造器中，针对<code>this(形参列表)</code>或<code>super(形参列表)</code>只能二选一，不能同时出现</li>
<li>在构造球首行，没有显式声明<code>this(形参列表)</code>或<code>super(形参列表)</code>，则默认调用的是父类中空参的构造器。super()</li>
<li>在类的多个构造器中，至少有一个类的构造器中使用了<code>super(形参列表)</code></li>
</ol>
</li>
</ol>
<h3 id="子类对象实例化全过程"><a href="#子类对象实例化全过程" class="headerlink" title="子类对象实例化全过程"></a>子类对象实例化全过程</h3><ol>
<li>从结果上看，子类继承父类后，就获取了父类中声明的属性或方法。创建字类的对象，在堆空间中，就会加载所有父类中声明的属性。</li>
<li>从过程上来看，跟 js 原型链一样，直到 java.lang.Object。</li>
</ol>
<p>虽然在创建子类对象时，调用了父类构造器，但是自始自终就创建一个对象，即为 new 的子类对象。</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gm19brzfxsj316s0qsdl3.jpg" alt></p>
<h3 id="多态性-是一种运行时行为"><a href="#多态性-是一种运行时行为" class="headerlink" title="多态性(是一种运行时行为)"></a>多态性(是一种运行时行为)</h3><ol>
<li><p>一个事物的多种形态</p>
</li>
<li><p>父类的引用指向子类的对象</p>
</li>
<li><p>多态使用，虚拟方法调用</p>
<ol>
<li>有了对象的多态以后，我们在编译期，只能调用父类中声明的方法，但在运行期，我们实际执行的是子类重写父类的方法。</li>
<li>总结：编译看左边；执行看右边</li>
</ol>
</li>
<li><p>使用前提：</p>
<ol>
<li>类的继承关系</li>
<li>方法的重写</li>
</ol>
</li>
<li><p>对象的多态性，只适用于方法，不适用于属性(编译运行都看左边)</p>
</li>
<li><p>如何调用子类特有的属性和方法？向下转型：使用强制类型转换符</p>
<p>Eg. <code>Man m1 = (Man)p2</code>.</p>
<p>使用强转时，可能出现<code>ClassCastException</code>异常。</p>
</li>
<li><p>若子类重写了父类方法，就意味着子类定义的方法彻底覆盖了父类里的同名方法，系统激情不可能把父类里的方法转移到子类中</p>
</li>
<li><p>对于实例变量则不存在这样的现象(7)，即使子类里定义了与父类完全相同的实例变量，这个实例变量依然不可能覆盖父类中定义的实例变量</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonTest</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Person p1 = <span class="keyword">new</span> Person();</span><br><span class="line">    p1.eat();</span><br><span class="line"></span><br><span class="line">    Man man = <span class="keyword">new</span> Man();</span><br><span class="line">    man.eat();</span><br><span class="line">    man.age = <span class="number">25</span>;</span><br><span class="line">    man.earnMoney();</span><br><span class="line"></span><br><span class="line">    Person p2 = <span class="keyword">new</span> Man();</span><br><span class="line"></span><br><span class="line">    Person p3 = <span class="keyword">new</span> Woman();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="instanceof"><a href="#instanceof" class="headerlink" title="instanceof"></a>instanceof</h4><p>同 js</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gm2dejbtb0j31ao0tigz3.jpg" alt></p>
<ol>
<li><p>a instanceof A: 判断对象 a 是否是类 A 的实例。</p>
</li>
<li><p>为了避免向下转型出现异常，进行 instanceof 判断。</p>
</li>
</ol>
<h4 id="和-equals-区别"><a href="#和-equals-区别" class="headerlink" title="== 和 equals()区别"></a>== 和 equals()区别</h4><ol>
<li><code>==</code>基本数据类型比较保存的数据是否相等（不一定要类型相同），引用类型比较地址</li>
<li>equals()引用类型可以用<ul>
<li>Object 类中定义的 equals 方法和==相同</li>
<li>String、Date、File 包装类中都重写了 equals()，重写以后比较的是实体内容是否相同</li>
</ul>
</li>
</ol>
<p>通常情况下自定义类中如果使用 equals()，也通常是比较浪个对象的实体内容睡否相同，那么我们就需要对 Object 类中的 equals()进行重写。</p>
<h3 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString"></a>toString</h3><ol>
<li>当我们输出一个对象的引用值，实际就是调用当前对象的 toString()</li>
<li>像 String、Date、File 包装类都重写了 Object 类中的 toString 方法。使得在调用对象的 toString 时，返回实体内容信息</li>
<li>自定义类也可以重写 toString 方法，当调用此方法时，返回对象实体内容</li>
</ol>
<h3 id="包装类"><a href="#包装类" class="headerlink" title="包装类"></a>包装类</h3><h4 id="包装类使用"><a href="#包装类使用" class="headerlink" title="包装类使用"></a>包装类使用</h4><ol>
<li>java 提供 8 种基本数据类型对应的包装类，使基本数据类型的变量有类的特性</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本数据类型 ---&gt; 包装类：调用包装类的构造器</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> num1 = <span class="number">10</span>;</span><br><span class="line">  Integer in1 = <span class="keyword">new</span> Integer(num1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 包装类---&gt;基本数据类型：调用包装类XXX的XXXValue()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Integer in1 = <span class="keyword">new</span> Integer(<span class="number">12</span>);</span><br><span class="line">  <span class="keyword">int</span> i1 = in1.intValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本类型、包装类---&gt;String类型</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> num1 = <span class="number">10</span>;</span><br><span class="line">  <span class="comment">// 方法1</span></span><br><span class="line">  String str1 = num1 + <span class="string">""</span>;</span><br><span class="line">  <span class="comment">// 方法2</span></span><br><span class="line">  <span class="keyword">float</span> f1 = <span class="number">12.3f</span>;</span><br><span class="line">  String str2 = String.valueOf(f1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// String类型---&gt;基本数据类型、包装类：调用包装类的parseXXX()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String str1 = <span class="string">"123"</span>;</span><br><span class="line">  <span class="keyword">int</span> num2 = Integer.parseInt(str1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 就是赋值来赋值去</span></span><br><span class="line">  <span class="comment">// 自动装箱</span></span><br><span class="line">  <span class="keyword">int</span> num2 = <span class="number">10</span>;</span><br><span class="line">  Integer in1 = num2;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> b1 = <span class="keyword">true</span>;</span><br><span class="line">  Boolean b2 = b1;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自动拆箱</span></span><br><span class="line">  <span class="keyword">int</span> num3 = in1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><ol>
<li>静态的</li>
<li>可以用来修饰：属性、方法、代码块、内部类</li>
<li>修饰属性：静态变量(类变量)<ol>
<li>属性按 static 修饰，分为静态属性和非静态属性(实例变量)</li>
<li>静态变量，我们创建类的多个对象，多个对象共享同一个静态变量。一个变所有对象都变。</li>
<li>静态变量随着类的加载而加载，静态变量加载早于对象创建</li>
<li>类只加载一次，静态变量在内存中也加载一次，存在方法区的静态域中</li>
</ol>
</li>
<li>修饰方法<ol>
<li>静态方法中只能调用静态方法和属性</li>
<li>非静态方法都可以调用</li>
</ol>
</li>
<li>静态方法内，不能使用 this 和 super</li>
<li>确定属性方法是否要声明为 static<ol>
<li>确定属性：可以被多个对象共享，不随着对象不同而不同</li>
<li>确定方法：操作静态属性的方法、工具类中的方法</li>
</ol>
</li>
</ol>
<h3 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 饿汉式</span></span><br><span class="line"><span class="comment">// 好处：线程安全</span></span><br><span class="line"><span class="comment">// 坏处：加载时间过长</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bank</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 1.私有化类的构造器</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">Bank</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2.内部创建类的对象</span></span><br><span class="line">  <span class="comment">// 4.要求此对象也必须声明为静态的</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Bank instance = <span class="keyword">new</span> Bank();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.声明public、static的返回当前类对象的方法</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bank <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> instance</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 懒汉式</span></span><br><span class="line"><span class="comment">// 好处：延迟对象加载</span></span><br><span class="line"><span class="comment">// 目前写法坏处：线程不安全</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bank</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 1.私有化类的构造器</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">Bank</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2.声明当前类对象，没有初始化</span></span><br><span class="line">  <span class="comment">// 4.此对象也必须声明为static的</span></span><br><span class="line">  <span class="keyword">private</span> Bank instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.声明public、static的返回当前类对象的方法</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bank <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">      instance = <span class="keyword">new</span> Bank();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><ol>
<li>程序入口</li>
<li>普通静态方法</li>
<li>可以做哦为与控制台交互的方式（之前使用 scanner）</li>
</ol>
<h3 id="代码块"><a href="#代码块" class="headerlink" title="代码块"></a>代码块</h3><ol>
<li>用来初始化类、对象</li>
<li>有修饰的话，只能用 static</li>
<li>静态代码块 与 非静态代码块<ol>
<li>静态代码块<ol>
<li>内部可以有输出语句</li>
<li>随着类的加载而执行，只执行一次</li>
<li>如果一个 类中定义了多个，则按照声明的先后顺序执行</li>
</ol>
</li>
<li>非静态代码块<ol>
<li>内部可以有输出语句</li>
<li>随着对象的创建而执行，每创建一个就执行一次</li>
<li>作用：可以在创建对象时，对对象的属性进行初始化</li>
<li>如果一个 类中定义了多个，则按照声明的先后顺序执行</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>执行顺序：由父及子，线性执行</p>
<h3 id="final"><a href="#final" class="headerlink" title="final"></a>final</h3><ol>
<li>可以用来修饰类、方法、变量<ol>
<li>用来修饰类：此类不能被继承</li>
<li>用来修饰方法：不能被重写</li>
<li>修饰变量：即常量</li>
<li>修饰形参时：表面此形参是一个常量</li>
</ol>
</li>
</ol>
<h3 id="抽象类和抽象方法"><a href="#抽象类和抽象方法" class="headerlink" title="抽象类和抽象方法"></a>抽象类和抽象方法</h3><h4 id="abstract"><a href="#abstract" class="headerlink" title="abstract"></a>abstract</h4><ol>
<li>可以用来修饰类、方法</li>
<li>修饰类：抽象类<ol>
<li>此类不能实例化</li>
<li>类中一定有构造器，便于子类对象实例化调用</li>
<li>开发中都会提供抽象类的子类，让子类对象实例化，完成相关操作</li>
</ol>
</li>
<li>修饰方法：抽象方法<ol>
<li>只有方法声明，没有方法体</li>
<li>包含抽象方法的类一定是抽象类，反之，抽象类中可以没有抽象方法</li>
<li>若子类重写了父类中所有的抽象方法后，此子类方可实例化；若子类没有重写父类中所有的抽象方法，则此子类也是一个抽象类，需要 abstract</li>
</ol>
</li>
<li>不能用来修饰属性、构造器</li>
<li>不能用来修饰私有方法、静态方法、final 的方法、final 的类</li>
</ol>
<h3 id="接口-interface"><a href="#接口-interface" class="headerlink" title="接口(interface)"></a>接口(interface)</h3><p>同 ts</p>
<ol>
<li>关键字 interface 定义</li>
<li>接口和类是并列的结构</li>
<li>如何定义<ol>
<li>JDK7 前<ol>
<li>只能定义全局常量和抽象方法</li>
<li>全局常量：public static final(书写时可以省略)；抽象方法： public abstract</li>
</ol>
</li>
<li>JDK8: 除 7 之外，还可以定义静态方法、默认方法</li>
</ol>
</li>
<li>接口中不能定义构造器，意味接口不能实例化</li>
<li>java 开发中，接口通过让类去实现接口(implements)的方式来使用<ol>
<li>如果实现类覆盖了接口中的所有抽象方法，则此实现类就可以完成实例化</li>
<li>如果没有，则此实现类仍是一个抽象类</li>
</ol>
</li>
<li>可以实现多个接口<ol>
<li>格式：class AA extends BB implements CC, DD, EE 先写继承后写实现</li>
</ol>
</li>
<li>接口与接口之间可以继承，而且可以多继承</li>
<li>接口的使用，体现多态性</li>
<li>接口实际上可以看作一种规范</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Flyable</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 全局变量</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_SPEED = <span class="number">7900</span>;</span><br><span class="line">  <span class="keyword">int</span> MIN_SPEED = <span class="number">1</span>; <span class="comment">// 省略了public static final</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 抽象方法</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="keyword">void</span> stop; <span class="comment">// 省略了public abstract</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Accackable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span>. <span class="function"><span class="keyword">void</span> <span class="title">attack</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plane</span> <span class="keyword">implements</span> <span class="title">Flyable</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// code...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// code...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bullet</span> <span class="keyword">extends</span> <span class="title">Object</span> <span class="keyword">implements</span> <span class="title">Flyable</span>, <span class="title">Accackable</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// code...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// code...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// code...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Aaa</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// code...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">default</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// code...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 默认方法可以省略public</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// code...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>接口中定义的静态方法，只能 通过接口来调用</p>
</li>
<li><p>通过实现类的对象，可以调用接口中的默认方法，如果实现类重写了接口中的默认方法，调用时，仍然调用的是重写之后的方法</p>
</li>
<li><p>如果子类或实现类继承的父类和实现的接口中声明了同名同参数的方法，如果子类在没有重写此方法的情况下，默认调用的是父类中的同名同参数方法。—类优先原则</p>
</li>
<li><p>如果实现类实现了多个接口，而多个接口中定义了同名同参数的方法，那么在实现类没有重写此方法的情况下，报错，这就需要在实现类中实现此方法。—接口冲突</p>
</li>
<li><p>如何在子类或是实现类的方法中调用父类、接口中被重写的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubClass</span> <span class="keyword">extends</span> <span class="title">SuperClass</span> <span class="keyword">implements</span> <span class="title">CompareA</span>, <span class="title">CompareB</span> </span>&#123;</span><br><span class="line">  <span class="comment">// code...</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">myMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 调用自己的</span></span><br><span class="line">    method3();</span><br><span class="line">    <span class="comment">// 调用父类的</span></span><br><span class="line">    <span class="keyword">super</span>.method3();</span><br><span class="line">    <span class="comment">// 调用接口中默认的方法</span></span><br><span class="line">    CompareA.<span class="keyword">super</span>.method3();</span><br><span class="line">    CompareB.<span class="keyword">super</span>.method3();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h3><p>其实就是。代理类里传调用类</p>
<p>开闭原则：对拓展开发，对修改封闭</p>
<h3 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h3><p>类里面写类</p>
<ol>
<li>允许将一个类 A 声明在另一个类 B 中，则 A 就是内部类，B 是外部类</li>
<li>内部类分类：成员内部类 、局部内部类(方法内、代码块内、构造器类)</li>
</ol>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><ol>
<li><p>异常体系结构</p>
<ol>
<li><p>Java.lang.Throwable</p>
<p>—java.lang.Error: 一般不编写针对性代码进行处理</p>
<p>—java.lang.Exception:可以进行异常的处理</p>
<p>​ —编译时异常(checked)</p>
<p>​ —运行时异常(unchecked)</p>
</li>
</ol>
</li>
</ol>
<h4 id="抓抛模型"><a href="#抓抛模型" class="headerlink" title="抓抛模型"></a>抓抛模型</h4><ol>
<li>抛：程序在正常执行过程中，一旦出现异常，会在异常代码处生成一个对应异常类对象，并将此对象抛出，一旦抛出，其后的代码就不再执行。</li>
<li>抓：可以理解为异常的处理方式<ol>
<li>try-catch-finally 可以嵌套</li>
<li>throws</li>
</ol>
</li>
<li>常用处理方式:<ol>
<li>String getMessage()</li>
<li>printStackTrace()</li>
</ol>
</li>
<li>像数据库连接、输入输出流、网络编程 Socket 等资源，JVM 是不能自动回收的，我们需要自己手动进行资源的释放。此时的资源释放，就需要声明在 finally 中</li>
<li>开发中，由于运行时异常比较常见，所以我们通常就不针对运行时异常编写 try-catch-finally。针对编译时异常，一定要考虑异常处理。</li>
<li>throws + 异常类型<ol>
<li>写在方法的声明处，指明此方法执行时，可能会抛出的异常类型，一旦方法体执行出现异常，仍会在异常代码处生成一个异常类的对象，此对象满足 throws 后异常类型时，就会被抛出。异常代码后续代码不再执行</li>
</ol>
</li>
<li>try-catch-finally：真正将异常处理掉了</li>
<li>throws 的方式只是将异常抛给了方法的调用者，并没有真正将异常处理掉</li>
</ol>
<h4 id="方法重写规定"><a href="#方法重写规定" class="headerlink" title="方法重写规定"></a>方法重写规定</h4><ol>
<li>子类重写的方法抛出的异常类型不大于父类被重写的方法抛出的异常类型</li>
</ol>
<h4 id="开发中如何选择使用-try-catch-finally-还是-throws"><a href="#开发中如何选择使用-try-catch-finally-还是-throws" class="headerlink" title="开发中如何选择使用 try-catch-finally 还是 throws"></a>开发中如何选择使用 try-catch-finally 还是 throws</h4><ol>
<li>如果父类中被重写的方法没有 throws 方式处理异常，则子类重写的方法也不能 throws，意味着如果子类重写的方法中有异常，必须使用 try-catch-finally 方式处理。</li>
<li>执行的方法 a 中，先后调用了其他几个方法，而且是递进关系，我们建议这几个方法使用 throws 方式进行处理，而执行的方法 a 可以考虑使用 try-catch-finally 进行处理。</li>
</ol>
<h4 id="异常对象的产生"><a href="#异常对象的产生" class="headerlink" title="异常对象的产生"></a>异常对象的产生</h4><ol>
<li>系统自动生成的异常对象</li>
<li>手动的生成一个异常对象并抛出(throw)</li>
</ol>
<h4 id="自定义异常"><a href="#自定义异常" class="headerlink" title="自定义异常"></a>自定义异常</h4><ol>
<li>继承现有的异常结构</li>
<li>提供全局常量：serialVersinUID</li>
<li>提供重载的构造器</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2323232323L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MyException</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MyException</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(msg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gmajokd10qj319m0mqtjs.jpg" alt></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2020/12/30/java基础/" data-id="ckonxihuk0003ttyzrwj7vf3o" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react原理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/11/29/react原理/" class="article-date">
  <time datetime="2020-11-29T07:05:48.000Z" itemprop="datePublished">2020-11-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/11/29/react原理/">React原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="React"><a href="#React" class="headerlink" title="React"></a>React</h1><p><a href="https://react.docschina.org/docs/getting-started.html" target="_blank" rel="noopener">中文官网</a></p>
<p>有两类场景会制约快速响应</p>
<ol>
<li>当遇到大计算量的操作或设备性能不足使页面掉帧，导致卡顿。</li>
<li>发送网络请求后，由于需要等待数据返回才能进一步操作导致不能快速响应。</li>
</ol>
<p>概括为：CPU 瓶颈、IO 瓶颈</p>
<p><strong>解决 CPU 瓶颈</strong></p>
<p>js 可以操作 DOM，GUI 渲染线程与 JS 线程使互斥的。所以 js 脚本执行和浏览器布局、绘制不能同时执行。</p>
<p>在 60Hz，也就是美 16.6ms 内，要完成以下工作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JS脚本执行 -----  样式布局 ----- 样式绘制</span><br></pre></td></tr></table></figure>

<p>当 js 执行时间过长就无法完成后续操作，从而造成页面掉帧与卡顿。</p>
<p><strong>解决方案</strong>：在浏览器每一帧的时间中，预留一些时间给 js 线程，react 利用这部分时间更新组件。(react 源码中预留的初始时间为 5ms)</p>
<p><strong>当预留时间不够时</strong>，react 将线程控制权交还给浏览器，使其有时间渲染 UI，react 则等待下一帧时间到来继续被中断的工作。</p>
<p><strong>这种将长任务分拆到每一帧中，像蚂蚁搬家一样一次执行一小段任务的操作，被称为<code>时间切片</code>(time slice)。</strong></p>
<p>结论：解决 CPU 瓶颈的关键是实现时间切片，而时间切片的关键是：将同步的更新变为可中断的异步更新。</p>
<p><strong>IO 的瓶颈</strong></p>
<p>网络延迟是前端开发者无法解决的，如何在网络延迟客观存在的情况下，减少对网络延迟的感知？</p>
<p><strong>解决方案</strong>: 将人机交互研究的结果整合到真实的 UI 中。</p>
<p>进入页面 loading 场景：当一小段时间足够短时，用户是无感知的。如果请求时间超过一个范围，再显示 loading 效果。</p>
<p>如果进入页面就显示 loading，即使一闪而过，用户也可以感知。为了优化体验：</p>
<p><code>React</code>实现了<a href="https://zh-hans.reactjs.org/docs/concurrent-mode-suspense.html" target="_blank" rel="noopener">Suspense (opens new window)</a>功能及配套的<code>hook</code>——<a href="https://zh-hans.reactjs.org/docs/concurrent-mode-reference.html#usedeferredvalue" target="_blank" rel="noopener">useDeferredValue</a>。。。。。。。</p>
<h2 id="老-React-架构"><a href="#老-React-架构" class="headerlink" title="老 React 架构"></a>老 React 架构</h2><p>V15</p>
<h3 id="ReactV15-架构"><a href="#ReactV15-架构" class="headerlink" title="ReactV15 架构"></a>ReactV15 架构</h3><p>分为两层：</p>
<ul>
<li>Reconciler(协调器) —– 负责找出变化的组件</li>
<li>Renderer(渲染器) —– 负责将变化的组件渲染到页面上</li>
</ul>
<h3 id="Reconciler-协调器"><a href="#Reconciler-协调器" class="headerlink" title="Reconciler(协调器)"></a>Reconciler(协调器)</h3><p>触发更新方式：<code>this.setState</code> <code>this.forceUpdate</code> <code>ReactDOM.render</code></p>
<p>每当更新发生时， Reconciler 会有如下动作：</p>
<ol>
<li>调用函数组件或类组件的<code>render</code>，将返回的 JSX 转换成 VDOM</li>
<li>将 VDOM 与上次更新时的 VDOM 对比</li>
<li>通过对比找出本次更新中变化的 VDOM</li>
<li>通知 Renderer 将变化的 VDOM 渲染到页面上</li>
</ol>
<h3 id="Renderer-渲染器"><a href="#Renderer-渲染器" class="headerlink" title="Renderer(渲染器)"></a>Renderer(渲染器)</h3><p>浏览器端的渲染 Renderer—–ReactDOM</p>
<p>因为 react 支持跨平台，因此有别的 Renderer</p>
<ul>
<li>ReactNative 渲染器：渲染 App 原生组件</li>
<li>ReactTest 渲染器：渲染出纯 js 对象用于测试</li>
<li>ReactArt 渲染器：渲染到 Canvas，SVG 或 VML</li>
</ul>
<p>每次更新发生时，Renderer 接到 Reconciler 通知，将变化的组件渲染到当前宿主环境。</p>
<h3 id="存在的缺点"><a href="#存在的缺点" class="headerlink" title="存在的缺点"></a>存在的缺点</h3><p>Reconciler 中，<code>mount</code>的组件会调用<code>mountComponent</code>，<code>update</code>的组件会调用<code>updateComponent</code>。这两个方法都会递归更新子组件。</p>
<h4 id="递归更新的缺点"><a href="#递归更新的缺点" class="headerlink" title="递归更新的缺点"></a>递归更新的缺点</h4><p>由于递归执行，所以一旦开始，中途就无法中断，当层级很深，超过 16ms 用户交互就会卡顿。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Reconciler -&gt; Renderer -&gt; 页面更新变化 -&gt; Reconciler -&gt; Renderer -&gt;...</span><br></pre></td></tr></table></figure>

<h2 id="新-React-架构-V16"><a href="#新-React-架构-V16" class="headerlink" title="新 React 架构 V16"></a>新 React 架构 V16</h2><p>v16 架构分三层</p>
<ul>
<li>Scheduler(调度器) —–调度任务优先级，高优任务优先进入 Reconciler</li>
<li>Reconciler(协调器) —– 负责找出变化的组件</li>
<li>Renderer(渲染器) —– 负责将变化的组件渲染到页面上</li>
</ul>
<h3 id="Scheduler-调度器"><a href="#Scheduler-调度器" class="headerlink" title="Scheduler(调度器)"></a>Scheduler(调度器)</h3><p>既然我们以浏览器是否有剩余时间作为任务中断的标准，那么我们需要一种机制，当浏览器有剩余时间时通知我们。</p>
<p><code>requestIdleCallback</code></p>
<p>react 放弃使用:</p>
<ul>
<li>浏览器兼容性问题</li>
<li>触发频率不稳定，受很多因素影响。</li>
</ul>
<p>然后 react 就自我实现了<code>requestIdleCallback</code>的 polyfill，就是 Scheduler。除了空闲时触发回调的功能，Scheduler 还提供了多种调度优先级任务设置。</p>
<p><a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/scheduler/README.md">Scheduler</a></p>
<h3 id="Reconciler-协调器-1"><a href="#Reconciler-协调器-1" class="headerlink" title="Reconciler(协调器)"></a>Reconciler(协调器)</h3><p>React15 时递归处理。16 就变成可中断的循环过程了。每次循环都会调用<code>shouldYield</code>判断当前是否有剩余时间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function workLoopConcurrent() &#123;</span><br><span class="line">	while(workInProgress !== null &amp;&amp; !shouldYield()) &#123;</span><br><span class="line">		workInProgress = performUnitOfWork(workInProgress);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>React16 解决中断更新时 DOM 渲染不完全的问题？</p>
<p>Reconciler 与 Renderer 不再交替工作，当 Scheduler 将任务交给 Reconciler 后，Reconciler 会为变化的 VDOM 打上代表增删更新的标记。</p>
<p><strong>整个 Scheduler 与 Reconciler 的工作都在内存中进行，只有当所有组件都完成 Reconciler 的工作，才会统一交给 Renderer</strong></p>
<h3 id="Renderer-渲染器-1"><a href="#Renderer-渲染器-1" class="headerlink" title="Renderer(渲染器)"></a>Renderer(渲染器)</h3><p>如图：</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkj899vmjmj310a0rsdmy.jpg" alt="如图"></p>
<p><code>Reconciler(协调器)</code> 内部采用了<code>fiber</code>架构</p>
<h2 id="React-V17"><a href="#React-V17" class="headerlink" title="React V17"></a>React V17</h2><h2 id="Fiber-架构"><a href="#Fiber-架构" class="headerlink" title="Fiber 架构"></a>Fiber 架构</h2><p>React Fiber 可以理解为：React 内部实现的一套状态更新机制。<strong>支持任务不同优先级，可中断与恢复，并且恢复后可以服用之前的中间状态</strong>。</p>
<p>其中每任务更新单元为 React Element 对应的 Fiber 节点。</p>
<h3 id="Fiber-含义"><a href="#Fiber-含义" class="headerlink" title="Fiber 含义"></a>Fiber 含义</h3><ol>
<li>V15 的 Reconciler 采用递归的方式进行，数据保存在递归调用栈中，因此被称为 stack Reconciler；V16 的 Reconciler 基于 Fiber 节点实现，被称为 Fiber Reconciler。</li>
<li>作为静态的数据结构来说，每个 Fiber 节点对应一个 React Ele，保存了该组件的类型、对应的 DOM 节点等信息。</li>
<li>作为动态工作单元来说，每个 Fiber 节点保存了本次更新中该组件改变的状态，要执行的工作。</li>
</ol>
<h3 id="Fiber-结构"><a href="#Fiber-结构" class="headerlink" title="Fiber 结构"></a>Fiber 结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">function FiberNode(</span><br><span class="line">  tag: WorkTag,</span><br><span class="line">  pendingProps: mixed,</span><br><span class="line">  key: null | string,</span><br><span class="line">  mode: TypeOfMode</span><br><span class="line">) &#123;</span><br><span class="line">  // 作为静态数据结构的属性</span><br><span class="line">  // Fiber对应组件的类型 FC/Class/Host</span><br><span class="line">  // HostComponent指原生的HTML标签</span><br><span class="line">  this.tag = tag;</span><br><span class="line">  this.key = key;</span><br><span class="line">  // 大部分同type，某些情况不同，比如FC使用React.memo包裹</span><br><span class="line">  this.elementType = null;</span><br><span class="line">  // 对于FC,指函数本身，对于ClassComponent,指class，对于HostCompoent，指DOM节点tagName</span><br><span class="line">  this.type = null;</span><br><span class="line">  // Fiber对应的真实DOM节点</span><br><span class="line">  this.stateNode = null;</span><br><span class="line"></span><br><span class="line">  //用于连接其他Fiber节点形成Fiber树</span><br><span class="line">  this.return = null;</span><br><span class="line">  this.child = null;</span><br><span class="line">  this.sibling = null;</span><br><span class="line">  this.index = 0;</span><br><span class="line">  this.ref = null;</span><br><span class="line"></span><br><span class="line">  // 作为动态的工作单元属性</span><br><span class="line">  // 保存本次更新造成的状态改变相关信息</span><br><span class="line">  this.pendingProps = pendingProps;</span><br><span class="line">  this.memoizedProps = null;</span><br><span class="line">  this.updateQueue = null;</span><br><span class="line">  this.memoizedState = null;</span><br><span class="line">  this.dependencies = null;</span><br><span class="line">  this.mode = mode;</span><br><span class="line">  // 保存本次更新会造成的DOM操作</span><br><span class="line">  this.effectTag = NoEffect;</span><br><span class="line">  this.nextEffect = null;</span><br><span class="line">  this.firstEffect = null;</span><br><span class="line">  this.lastEffect = null;</span><br><span class="line"></span><br><span class="line">  // 调度优先级相关</span><br><span class="line">  this.lanes = NoLanes;</span><br><span class="line">  this.childLanes = NoLanes;</span><br><span class="line"></span><br><span class="line">  // 指向该fiber在另一次更新时对应的fiber</span><br><span class="line">  this.alternate = null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 每个Fiber节点有个对应的React ele， 多个Fiber节点如何形成树，靠这几个属性</span><br><span class="line"></span><br><span class="line">// 指向父级Fiber节点</span><br><span class="line">this.return = null;</span><br><span class="line">// 指向子Fiber节点</span><br><span class="line">this.child = null;</span><br><span class="line">// 指向右边第一个兄弟Fiber节点</span><br><span class="line">this.sibling = null;</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gklinubpr1j30u014in20.jpg" alt="例子"></p>
<h3 id="Fiber-工作原理"><a href="#Fiber-工作原理" class="headerlink" title="Fiber 工作原理"></a>Fiber 工作原理</h3><h4 id="双缓存"><a href="#双缓存" class="headerlink" title="双缓存"></a>双缓存</h4><p>类比 canvas 动画绘制，每一帧绘制前都会用<code>ctx.clearRect</code>清除上一帧画面。如果当前帧画面计算量较大，导致清除上一帧画面到绘制当前帧画面之间有较长间隙，就会出现白屏。</p>
<p>为了解决这个问题，我们可以在内存中绘制当前帧动画，绘制完毕后直接用当前帧替换上一帧画面，由于省去了替换所需的计算时间，就不会出现画面闪烁问题。</p>
<p>这种在<strong>内存中构建并直接替换的技术叫双缓存</strong>。</p>
<p>React 使用双缓存来完成 Fiber 树的构建和替换，对应着 DOM 树的创建与更新。</p>
<h4 id="双缓存-Fiber-树"><a href="#双缓存-Fiber-树" class="headerlink" title="双缓存 Fiber 树"></a>双缓存 Fiber 树</h4><p>React 中最多同时存在两颗 Fiber 树：</p>
<ul>
<li>当前屏幕上显示内容对应的<code>current Fiber树</code></li>
<li>正在内存中构建的<code>workInProgress Fiber树</code></li>
</ul>
<p><code>current Fiber</code> : <code>current Fiber树</code>中的 Fiber 节点</p>
<p><code>workInProgress Fiber</code>: <code>workInProgress Fiber树</code>的 Fiber 节点</p>
<p>它们通过 alternate 属性连接。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">currentFiber.alternate === workInProgressFiber;</span><br><span class="line">workInProgressFiber.alternate === currentFiber;</span><br></pre></td></tr></table></figure>

<p>React 应用的根节点通过 current 的指针在不同的 Fiber 树的 rootFiber 间切换来实现 Fiber 树的切换。</p>
<p>当 workInProgress Fiber 构建完成交给 Renderer 渲染在页面上后，应用根节点的 current 指向 workInprogress Fiber 树，此时 workInProgress Fiber 树就变为 current Fiber 树。</p>
<p>每次状态更新都会产生新的 workInProgress Fiber 树，<strong>通过 current 与 workInProgress 的替换，完成 DOM 更新</strong>。</p>
<p>自己：其实就是挂载时内存中构建树，然后当前树指向内存树，更新时，通过缓存的内存树完成类似 canvas 无缝切换的操作。。。</p>
<h2 id="React-源码文件结构"><a href="#React-源码文件结构" class="headerlink" title="React 源码文件结构"></a>React 源码文件结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">根目录</span><br><span class="line">├── fixtures        # 包含一些给贡献者准备的小型 React 测试项目</span><br><span class="line">├── packages        # 包含元数据（比如 package.json）和 React 仓库中所有 package 的源码（子目录 src）</span><br><span class="line">├── scripts         # 各种工具链的脚本，比如git、jest、eslint等</span><br></pre></td></tr></table></figure>

<h3 id="react-文件夹"><a href="#react-文件夹" class="headerlink" title="react 文件夹"></a>react 文件夹</h3><p>含所有全局 React API</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkmocaev2xj30gc12qtde.jpg" alt></p>
<p>以上这些全平台通用，不含 ReactDOM、ReactNative 等平台特定代码。</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkmoesqe5yj30gi190wjp.jpg" alt></p>
<h3 id="scheduler"><a href="#scheduler" class="headerlink" title="scheduler"></a>scheduler</h3><p>调度器实现</p>
<h3 id="shared"><a href="#shared" class="headerlink" title="shared"></a>shared</h3><p>源码中其他模块公用的方法和全局变量</p>
<h3 id="Renderer-相关"><a href="#Renderer-相关" class="headerlink" title="Renderer 相关"></a>Renderer 相关</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- react-art- react-art</span><br><span class="line">- react-dom                 # 注意这同时是DOM和SSR（服务端渲染）的入口</span><br><span class="line">- react-native-renderer</span><br><span class="line">- react-noop-renderer       # 用于debug fiber（后面会介绍fiber）</span><br><span class="line">- react-test-renderer</span><br></pre></td></tr></table></figure>

<h3 id="试验性包文件夹"><a href="#试验性包文件夹" class="headerlink" title="试验性包文件夹"></a>试验性包文件夹</h3><p>React 将自己流程中的一部分抽离出来，形成可以独立使用的包，由于他们是试验性质，所以不被建议在生产环节使用。包括</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- react-server        # 创建自定义SSR流</span><br><span class="line">- react-client        # 创建自定义的流</span><br><span class="line">- react-fetch         # 用于数据请求</span><br><span class="line">- react-interactions  # 用于测试交互相关的内部特性，比如React的事件模型</span><br><span class="line">- react-reconciler    # Reconciler的实现，你可以用他构建自己的Renderer</span><br></pre></td></tr></table></figure>

<h3 id="辅助包文件夹"><a href="#辅助包文件夹" class="headerlink" title="辅助包文件夹"></a>辅助包文件夹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- react-is       # 用于测试组件是否是某类型</span><br><span class="line">- react-client   # 创建自定义的流</span><br><span class="line">- react-fetch    # 用于数据请求</span><br><span class="line">- react-refresh  # “热重载”的React官方实现</span><br></pre></td></tr></table></figure>

<h3 id="react-reconciler-文件夹"><a href="#react-reconciler-文件夹" class="headerlink" title="react-reconciler 文件夹"></a>react-reconciler 文件夹</h3><p>重要！。。。一边对接 Scheduler，一边对接不同平台的 Renderer，构成了整个 React16 的架构体系。</p>
<h2 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a>JSX</h2><p>会被编译为 React.createElement</p>
<h3 id="React-createElement"><a href="#React-createElement" class="headerlink" title="React.createElement"></a>React.createElement</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ReactElement = <span class="function"><span class="keyword">function</span> (<span class="params">type, key, ref, self, source, owner, props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> element = &#123;</span><br><span class="line">    <span class="comment">// 标记这是个React Element</span></span><br><span class="line">    $$<span class="keyword">typeof</span>: React_ELEMENT_TYPE,</span><br><span class="line">    type,</span><br><span class="line">    key,</span><br><span class="line">    ref,</span><br><span class="line">    props,</span><br><span class="line">    _owner: owner,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> element;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, config, children</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> propName;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> props = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> key = <span class="literal">null</span>,</span><br><span class="line">    ref = <span class="literal">null</span>,</span><br><span class="line">    self = <span class="literal">null</span>,</span><br><span class="line">    source = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (config !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 将config处理后赋值给props</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> childrenLength = <span class="built_in">arguments</span> - <span class="number">2</span>;</span><br><span class="line">  <span class="comment">// 处理children,会被赋值给props.children</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理defaultProps</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ReactElement(</span><br><span class="line">    type,</span><br><span class="line">    key,</span><br><span class="line">    ref,</span><br><span class="line">    self,</span><br><span class="line">    source,</span><br><span class="line">    ReactCurrentOwner.current,</span><br><span class="line">    props</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>createElement 返回了 ReactElement。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidElement</span>(<span class="params">object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="keyword">typeof</span> object === <span class="string">"object"</span> &amp;&amp;</span><br><span class="line">    object !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    object.$$<span class="keyword">typeof</span> === REACT_ELEMENT_TYPE</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 非null对象就是个合法的React Element。</span></span><br></pre></td></tr></table></figure>

<h3 id="React-Components"><a href="#React-Components" class="headerlink" title="React Components"></a>React Components</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AppClass <span class="keyword">instanceof</span> <span class="built_in">Function</span> === <span class="literal">true</span>;</span><br><span class="line">AppFunc <span class="keyword">instanceof</span> <span class="built_in">Function</span> === <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// 无法通过引用类型区分ClassComponent和FunctionComponent</span></span><br><span class="line"><span class="comment">// React通过ClassComponent实例原型上的isReactComponent变量判断是否是ClassComponent</span></span><br><span class="line">ClassComponent.prototype.isReactComponent = &#123;&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="JSX-与-Fiber-节点"><a href="#JSX-与-Fiber-节点" class="headerlink" title="JSX 与 Fiber 节点"></a>JSX 与 Fiber 节点</h3><p>jsx 是一种描述当前组件内容的数据结构，他不包含组件 schedule、reconcile、render 所需相关信息。</p>
<p>比如不包含：</p>
<ul>
<li>组件在更新中的优先级</li>
<li>组件的 state</li>
<li>组件被打上的用于 Renderer 的标记</li>
</ul>
<p>这些内容都包含在 Fiber 节点中。</p>
<p><strong>在组件 mount 时，Reconciler 根据 jsx 描述的组件内容生成组件对应的 Fiber 节点。</strong></p>
<p><strong>在 update 时，Reconciler 将 JSX 与 Fiber 节点保存的数据对比，生成组件对应的 Fiber 节点，并根据对比结果为 Fiber 节点打上标记。</strong></p>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><h3 id="render-阶段"><a href="#render-阶段" class="headerlink" title="render 阶段"></a>render 阶段</h3><p>render 阶段开始于<code>performSyncWorkOnRoot</code>或<code>performConcurrentWorkOnRoot</code>。这取决于本次更新时同步更新还是异步更新。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// performSyncWorkOnRoot会调用该方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoopSync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    performUnitOfWork(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// performConcurrentWorkOnRoot会调用该方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoopConcurrent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span> &amp;&amp; !shouldYield()) &#123;</span><br><span class="line">    performUnitOfWork(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到区别在于<code>shouldYield</code>。如果当前浏览器帧没有剩余时间，<code>shouldYield</code>会中止循环，知道浏览器有空闲时间后再继续遍历。</p>
<p><code>workInProgress</code>代表当前已创建的<code>workInProgress fiber</code>。</p>
<p><code>performUnitWork</code>方法会创建下一个<code>Fiber</code>节点并赋值给<code>workInProgress</code>，并将<code>workInProgress</code>与已创建的<code>Fiber</code>节点连接起来构成<code>Fiber</code>树。</p>
<p>Fiber Reconciler 是从 Stack Reconciler 重构而来，通过遍历的方式实现可中断的递归，所以<code>performUnitWork</code>的工作可以分为两部分：递和归。</p>
<h4 id="递"><a href="#递" class="headerlink" title="递"></a>递</h4><p>首先从 rootFiber 开始向下深度优先遍历，为遍历到的每个 Fiber 节点调用<strong>beginWork</strong>方法。</p>
<p>该方法会<strong>根据传入的 Fiber 节点创建子 Fiber 节点，并将这两个 Fiber 节点连接起来</strong>。</p>
<p>当遍历到叶子节点(没有子组件的组件)时就会进入归阶段。</p>
<h4 id="归"><a href="#归" class="headerlink" title="归"></a>归</h4><p>归阶段会调用<strong>completeWork</strong>处理 Fiber 节点。</p>
<p>当某个 Fiber 节点执行完 completeWork，如果其存在兄弟 Fiber 节点(fiber.sibling !== null )，会进入其兄弟 Fiber 的递阶段。</p>
<p>如果不存在兄弟 FIber，会进入父级 Fiber 的归阶段。</p>
<p>递和归阶段交错执行，直到归到 rootFiber，至此，render 阶段的工作就结束了。</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gklinubpr1j30u014in20.jpg" alt></p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkmpqdlkptj30vu0skwi0.jpg" alt></p>
<h3 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a>beginWork</h3><p>beginWork 的工作是，传入当前 Fiber 节点，创建子 Fiber 节点，具体实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// current: 当前组件对应的FIber节点在上一次更新时的Fiber节点，即workInProgress.alternate</span></span><br><span class="line"><span class="comment">// workInProgress: 当前组件对应的Fiber节点</span></span><br><span class="line"><span class="comment">// renderLanes: 优先级相关</span></span><br></pre></td></tr></table></figure>

<p>beginWork 工作分为两部分：</p>
<ul>
<li>update 时： 如果 current 存在，在满足一定条件时可以复用 current 节点，这样就能克隆 current.child 作为 workInProgress.child， 而不需新建 workInProgress.child</li>
<li>mount 时：除 fiberRootNode 以外, current === null。会根据 fiber.tag 不同，创建出不同类型的子 Fiber 节点。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="comment">// update时，如果current存在可能的优化路径，可以复用current(即上一次更新的Fiber节点)</span></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">return</span> bailoutAlreadyFinishedWork(current, workInProgress, renderLanes);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> IndeterminateComponent:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> LazyComponent:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> ClassComponent:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> HostRoot:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> HostText:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Update 时</strong></p>
<p>满足如下情况时，didReceiveUpdate === false(即可以直接复用前一次更新的子 Fiber，无需新建子 Fiber)</p>
<ol>
<li>oldProps === newProps &amp;&amp; workInProgress.type === current.type,即 props 与 fiber.type 不变</li>
<li>!includesSomeLane(renderLanes, updateLanes)，即当前 Fiber 节点优先级不够</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> oldProps = current.memoizedProps;</span><br><span class="line">  <span class="keyword">const</span> newProps = workInProgress.pendingProps;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    oldProps !== newProps ||</span><br><span class="line">    hasLegacyContextChanged() ||</span><br><span class="line">    (__DEV__ ? workInProgress.type !== current.type : <span class="literal">false</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!includesSomeLane(renderLanes, updateLanes)) &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">switch</span> (</span><br><span class="line">      workInProgress.tag</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    ) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bailoutOnAlreadyFinishWork(current, workInProgress, renderLanes);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>mount 时</strong></p>
<p>当不满足优化路径时，就要新建子 Fiber。对于我们常见组件类型，最终会进入 reconcileChildren 方法</p>
<p><strong>reconcileChildren</strong></p>
<p>是 Reconciler 模块的核心部分</p>
<ul>
<li>对 mount 的组件，会创建新的子 Fiber 节点</li>
<li>对于 update 的组件，会将当前组件与该组件在上次更新时对应的 Fiber 节点比较，diff，将比较的结果生成新的 Fiber 节点</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextChildren: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 对于mount的组件</span></span><br><span class="line">    workInProgress.child = mountChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderLanes</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 对于update的组件</span></span><br><span class="line">    workInProgress.child = reconcileChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      current.child,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderLanes</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无论走哪个逻辑，最终都会生成新的子Fiber节点，并赋值给workInProgress.child，作为本次beginWork返回值，并作为下次performUnitOfWork执行时workInProgress的传参</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>mountChildFibers 与 reconcileChildFibers 方法逻辑基本一致，唯一区别是 reconcileChildFibers 会为生成的 Fiber 节点打上 effectTag 属性，mountChildFibers 不会。</p>
</blockquote>
<p><strong>effectTag</strong></p>
<p>render 阶段的工作在内存中进行，当工作结束后会通知 Renderer 想要执行的 DOM 操作，要执行 DOM 操作的具体类型就保存在 Fiber.effectTag 中。</p>
<p>通过二进制表示 effect，可以方便的使用位操作位 fiber.effectTag 赋值多少个 effect。</p>
<p>如果要通知 Renderer 将 FIber 节点对应的 DOM 节点插入页面中，需要满足两个条件：</p>
<ol>
<li>fiber.stateNode 存在，即 Fiber 节点中保存了对应的 DOM 节点</li>
<li>(Fiber.effectTag &amp; Placement) !== 0 ，即 Fiber 节点存在 Placement effectTag。</li>
</ol>
<p>fiber.stateNode 会在 completeWork 中创建</p>
<p>假设 mountChildFibers 也会赋值 effectTag,那么可以预见 mount 时整颗 Fiber 树所有节点都会有 Placement effectTag，那么 commit 阶段在执行 dom 操作时每个节点都会执行一次插入操作，这样大量 dom 操作是极低效的。解决：在 mount 时只有 rootFiber 会赋值 Placement effecttag, 在 commit 阶段只会执行一次插入操作。</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkonwt9jkkj30zo0u07da.jpg" alt></p>
<h3 id="completeWork"><a href="#completeWork" class="headerlink" title="completeWork"></a>completeWork</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> newProps = workInProgress.pendingProps;</span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> IndeterminateComponent:</span><br><span class="line">    <span class="keyword">case</span> LazyComponent:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent:</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwordRef:</span><br><span class="line">    <span class="keyword">case</span> Fragment:</span><br><span class="line">    <span class="keyword">case</span> Mode:</span><br><span class="line">    <span class="keyword">case</span> Profiler:</span><br><span class="line">    <span class="keyword">case</span> ContextConsumer:</span><br><span class="line">    <span class="keyword">case</span> MemoComponent:</span><br><span class="line">    <span class="keyword">case</span> ClassComponent:</span><br><span class="line">    <span class="keyword">case</span> HostRoot:</span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断 update 时还需要考虑 workInProgress.stateNode !== null ? （即<strong>该 Fiber 节点是否存在对应的 DOM 节点</strong>）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">  popHostContext(workInProgress);</span><br><span class="line">  <span class="keyword">const</span> rootContainerInstance = getRootHostContainer();</span><br><span class="line">  <span class="keyword">const</span> type = workInProgress.type;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; workInProgress.stateNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// update时...</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// mount时...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="update-时"><a href="#update-时" class="headerlink" title="update 时"></a>update 时</h4><p>当 update 时，FIber 节点已经存在对应 DOM 节点，所以不需要生成 DOM 节点，需要做的主要处理 props,如</p>
<ul>
<li>onClick、onChange 等回调函数住蹙额</li>
<li>处理 style prop</li>
<li>处理 DANGEROUSLY_SET_INNER_HTML prop</li>
<li>处理 children prop</li>
</ul>
<p>最主要的逻辑是调用 updateHostComponent 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; workInProgress.stateNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">  zz(current, workInProgress, type, newProps, rootContainerInstance);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 在updateHostComponent内部，被处理完的props会被赋值给workInProgress.updateQueue,并最终会在commit阶段被渲染到页面上。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">workInProgress.updateQueue = (updatePayload: <span class="built_in">any</span>);</span><br><span class="line"><span class="comment">// updatePayload为数组形式，它的奇数索引的值为变化的prop key，偶数索引的值为变化的prop value ？？？？updatePayload</span></span><br></pre></td></tr></table></figure>

<h4 id="mount-时"><a href="#mount-时" class="headerlink" title="mount 时"></a>mount 时</h4><p>mount 主要逻辑包含：</p>
<ul>
<li>为 Fiber 节点生成对应的 DOM 节点</li>
<li>将子孙 DOM 节点插入刚生成的 DOM 节点</li>
<li>与 update 逻辑中 updateHostComponent 类似的处理 props 过程</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> currentHostContext = getHostContext();</span><br><span class="line"><span class="comment">// 为fiber创建对应的DOM节点</span></span><br><span class="line"><span class="keyword">const</span> instance = createInstance(</span><br><span class="line">  type,</span><br><span class="line">  newProps,</span><br><span class="line">  rootContainerInstance,</span><br><span class="line">  currentHostContext,</span><br><span class="line">  workInProgress</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 将子孙DOM节点插入刚生成的DOM节点中</span></span><br><span class="line">appendAllChildren(instance, workInProgress, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="comment">// DOM节点赋值给fiber.stateNode</span></span><br><span class="line">workInProgress.stateNode = instance;</span><br><span class="line"><span class="comment">// 与update逻辑中的updateHostComponent类似的处理props的过程</span></span><br><span class="line"><span class="keyword">if</span> (</span><br><span class="line">  finalizeInitialChildren(</span><br><span class="line">    instance,</span><br><span class="line">    type,</span><br><span class="line">    newProps,</span><br><span class="line">    rootContainerInstance,</span><br><span class="line">    currentHostContext</span><br><span class="line">  )</span><br><span class="line">) &#123;</span><br><span class="line">  markUpdate(workInProgress);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>commit 阶段如何通过一次插入 DOM 操作，将整颗 DOM 树插入页面？</p>
<p>completeWork 中的 appendAllChildren 方法，由于 completeWork 属于归阶段调用的函数，每次调用 appendAllChidren 时都会将已生成的子孙 DOM 节点插入当前生成的 DOM 节点下，因此当归到 rootFiber 时，已经有一个构建好的 DOM 树。</p>
<h4 id="effectList"><a href="#effectList" class="headerlink" title="effectList"></a>effectList</h4><p>问题：作为 dom 操作的依据，commit 阶段需要找到所有有 effectTag 的 fiber 节点，并依次执行 effectTag 对应的操作，那在 commit 阶段再遍历一次 FIber 树寻找 effectTag !== null 的 FIber 节点？</p>
<p>为解决这种低效的问题，在 completeWork 的上层函数 completeUnitOfWork 中，每个执行完 completeWork 且存在 effectTag 的 Fiber 节点会被保存在一条被称为 effectList 的单向链表中。</p>
<p>effectList 中第一个 Fiber 节点保存在 fiber.firstEffect，最后一个元素保存在 fiber.lastEffect。</p>
<p>类似 appendAllChildren,归阶段所有的 effectTag 的 Fiber 节点都会被追加在 effectList 中，最终形成一条以 rootFiber.firstEffect 为起点的单向链表。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">                       nextEffect         nextEffect</span><br><span class="line">rootFiber.firstEffect -----------&gt; fiber -----------&gt; fiber</span><br></pre></td></tr></table></figure>

<p>这样在 commit 阶段只需要遍历 effectList 就能执行所有 effect。</p>
<p>1 次归就存好链表再赋值。。。</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkq4bun8c8j30vp0u04dc.jpg" alt></p>
<h3 id="commit-阶段"><a href="#commit-阶段" class="headerlink" title="commit 阶段"></a>commit 阶段</h3><p>commitRoot 方法是 commit 阶段工作的起点。fiberRootNode 会作为传参。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commitRoot(root);</span><br></pre></td></tr></table></figure>

<p>在 rootFiber.firstEffect 上保存了一条需要执行副作用的 Fiber 节点的单向链表 effectList，这些 Fiber 节点的 updateQueue 中保存了变化的 props。</p>
<p>这些副作用对应的 DOM 操作在 commit 阶段执行。</p>
<p>除此之外，一些生命周期钩子、hook 需要在 commit 阶段执行。</p>
<p>commit 阶段主要工作(也就是 Renderer 的工作流程)分三部：</p>
<ul>
<li>Before mutation 阶段(执行 DOM 操作前)</li>
<li>mutation 阶段(执行 DOM 操作)</li>
<li>layout 阶段(执行 DOM 操作前后)</li>
</ul>
<h4 id="before-mutation-之前"><a href="#before-mutation-之前" class="headerlink" title="before mutation 之前"></a>before mutation 之前</h4><p>commitRootImpl 方法中直到第一句<code>if(firstEffect !== null)</code>之前属于 before mutation 之前</p>
<p>大体工作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="comment">// 触发useEffect回调与其他同步任务，由于这些任务可能触发新渲染，所以要一直遍历直到没有任务</span></span><br><span class="line">  flushPassiveEffects();</span><br><span class="line">&#125; <span class="keyword">while</span> (rootWithPendingPassiveEffects !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// root指 fiberRootNode</span></span><br><span class="line"><span class="comment">// root.finishedWork指当前应用的rootFiber</span></span><br><span class="line"><span class="keyword">const</span> finishedWork = root.finishedWork;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 凡是变量名带lane的都是优先级相关</span></span><br><span class="line"><span class="keyword">const</span> lanes = root.finishedLanes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (finishedWork === <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root.finishedWork = <span class="literal">null</span>;</span><br><span class="line">root.finishedLanes = NoLanes;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重置Scheduler绑定的回调函数</span></span><br><span class="line">root.callbackNode = <span class="literal">null</span>;</span><br><span class="line">root.callbackId = NoLanes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> remainingLanes = mergeLanes(finishedWork.lanes, finishedWork.childLanes);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重置优先级相关变量</span></span><br><span class="line">markRootFinished(root, remainingLanes);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除已完成的discrete updates 如：用户鼠标点击触发的更新</span></span><br><span class="line"><span class="keyword">if</span> (rootsWithPendingDiscreateUpdates !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !hasDiscreateLanes(remainingLanes) &amp;&amp;</span><br><span class="line">    rootsWithPendingDiscreateUpdates.has(root)</span><br><span class="line">  ) &#123;</span><br><span class="line">    rootsWithPendingDiscreateUpdates.delete(root);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重置全局变量</span></span><br><span class="line"><span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">  workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line">  workInProgress = <span class="literal">null</span>;</span><br><span class="line">  workInProgressRootRenderLanes = NoLanes;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将effectList赋值给firstEffect</span></span><br><span class="line"><span class="comment">// 由于每个fiber的effectList只包含他的子孙节点，所以根节点如果有effectTag则不会被包含进来，所以这里将有effectTag的根节点插入到effectList尾部，这样才能保证有effect的fiber都在effectList中</span></span><br><span class="line"><span class="keyword">let</span> firstEffect;</span><br><span class="line"><span class="keyword">if</span> (finishedWork.effectTag &gt; PerformedWork) &#123;</span><br><span class="line">  <span class="keyword">if</span> (finishedWork.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    finishedWork.lastEffect.nextEffect = finishedWork;</span><br><span class="line">    firstEffect = finishedWork.firstEffect;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    firstEffect = finishedWork;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 根节点没有effectTag</span></span><br><span class="line">  firstEffect = finishedWork.firstEffect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="layout-之后"><a href="#layout-之后" class="headerlink" title="layout 之后"></a>layout 之后</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rootDidHavePassiveEffects = rootDoesHavePassiveEffects;</span><br><span class="line"></span><br><span class="line"><span class="comment">// useEffect相关</span></span><br><span class="line"><span class="keyword">if</span> (rootDidHavePassiveEffects) &#123;</span><br><span class="line">  rootDidHavePassiveEffects = <span class="literal">false</span>;</span><br><span class="line">  rootWithPendingPassiveEffects = root;</span><br><span class="line">  pengdingPassiveEffectLanes = lanes;</span><br><span class="line">  pendingPassiveEffectsRenderProprity = renderPriorityLevel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 性能优化相关</span></span><br><span class="line"><span class="keyword">if</span> (remainingLanes !== NoLanes) &#123;</span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 性能优化相关</span></span><br><span class="line"><span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!rootDidHavePassiveEffects) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测无限循环的同步任务</span></span><br><span class="line"><span class="keyword">if</span> (remainingLanes === SyncLane) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在离开commitRoot函数前调用，触发一次新的调度，确保任何附加的任务被调度</span></span><br><span class="line">ensureRootIsScheduled(root, now());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行同步任务，这样同步任务不需要等到下次事件循环再执行，比如componentDidMount中执行setState创建的更新会在这里被同步执行</span></span><br><span class="line">flushSyncCallbackQueue();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>主要包括三点：</p>
<ol>
<li>useEffect 相关处理</li>
<li>性能追踪相关</li>
<li>在 commit 阶段会触发一些生命周期钩子</li>
</ol>
<h4 id="before-mutation-阶段"><a href="#before-mutation-阶段" class="headerlink" title="before mutation 阶段"></a>before mutation 阶段</h4><p>该阶段代码很短，整个过程就是遍历 effectList 并调用 commitBeforeMutationEffects 函数处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存之前的优先级，以同步优先级执行，执行完毕之后恢复之前优先级</span></span><br><span class="line"><span class="keyword">const</span> previousLanePriority = getCurrentUpdateLanePriority();</span><br><span class="line">setCuurrentUpdateLanePriority(SyncLanePriority);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将当前上下文标记为CommitContext，作为commit阶段的标志</span></span><br><span class="line"><span class="keyword">const</span> prevExectionContext = executionContext;</span><br><span class="line">executionContext |= CommitContext; <span class="comment">// |= 按位或</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理focus状态</span></span><br><span class="line">focusedInstanceHandle = prepareForCommit(root.containerInfo);</span><br><span class="line">shouldFireAfterActiveInstaceBlur = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// beforeMutation阶段的主函数</span></span><br><span class="line">commitBeforeMutationEffects(finishedWork);</span><br><span class="line"></span><br><span class="line">focusedInstanceHandle = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h5 id="commitBeforeMutationEffects"><a href="#commitBeforeMutationEffects" class="headerlink" title="commitBeforeMutationEffects"></a>commitBeforeMutationEffects</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!shouldFireAfterActiveInstanceBlur &amp;&amp; focusedInstanceHandle !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// ...focus blur相关</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> effectTag = nextEffect.effectTag;</span><br><span class="line">    <span class="comment">// 调用getSnapshotBeforeUpdate</span></span><br><span class="line">    <span class="keyword">if</span> ((effectTag &amp; Snapshot) !== NoEffect) &#123;</span><br><span class="line">      commitBeforeMutationEffectOnFiber(current, nextEffect);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调度useEffect</span></span><br><span class="line">    <span class="keyword">if</span> ((effectTag &amp; Passive) !== NoEffect) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!rootDoesHavePassiveEffects) &#123;</span><br><span class="line">        rootDoesHavePassiveEffects = <span class="literal">true</span>;</span><br><span class="line">        scheduleCallback(NormalSchedulerPriority, () =&gt; &#123;</span><br><span class="line">          flushPassiveEffects();</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    nextEffect = nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整体分三部：</p>
<ol>
<li>处理 DOM 节点渲染/删除后的 autoFocus、blur 逻辑</li>
<li>调用 getSnapshotBeforeUpdate 生命周期钩子</li>
<li>调度 useEffect</li>
</ol>
<h5 id="调用-getSnapshotBeforeUpdate"><a href="#调用-getSnapshotBeforeUpdate" class="headerlink" title="调用 getSnapshotBeforeUpdate"></a>调用 getSnapshotBeforeUpdate</h5><p>commitBeforeMutationEffectOnFiber 是 commitBeforeMutationLifeCycles 的别名</p>
<p>在该方法内会调用 getSnapshotBeforeUpdate</p>
<p>UNSAFE_原因：V15 -&gt; V16，render 阶段(componentWillxxxx)可能触发多次</p>
<p><strong>为此，用 getSnapshotBeforeUpdate 替代。可以看见 getSnapshotBeforeUpdate 是在 commit 阶段内的 before mutation 阶段调用，由于 commit 阶段是同步的，所以不会遇到多次调用问题。</strong></p>
<h5 id="调度-useEffect"><a href="#调度-useEffect" class="headerlink" title="调度 useEffect"></a>调度 useEffect</h5><p>scheduleCallback 是由 Scheduler 模块提供，用于以某个优先级异步调度一个回调函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调度useEffect</span></span><br><span class="line"><span class="keyword">if</span> ((effectTag &amp; Passive) !== NoEffect) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!rootDoesHavePassiveEffects) &#123;</span><br><span class="line">    rootDoesHavePassiveEffects = <span class="literal">true</span>;</span><br><span class="line">    scheduleCallback(NormalSchedulerPriority, () =&gt; &#123;</span><br><span class="line">      <span class="comment">// 触发useEffect</span></span><br><span class="line">      flushPassiveEffects();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="如何异步调度"><a href="#如何异步调度" class="headerlink" title="如何异步调度"></a>如何异步调度</h5><p>在 flushPassiveEffects 方法内部会从全局变量 rootWithPendingPassiveEffects 获取 effectList。</p>
<p>effectList 中保存了需要执行副作用的 Fiber 节点，其中副作用包括</p>
<ul>
<li>插入 DOM 节点(Placement)</li>
<li>更新 DOM 节点(Update)</li>
<li>删除 DOM 节点(Deletion)</li>
</ul>
<p>除此外，当一个 FC 含有 useEffect 或者 useLayoutEffect，他对应的 Fiber 节点也会被赋值 effectTag。</p>
<p>在 flushPassiveEffects 方法内部会遍历 rootDoesHavePassiveEffects 执行 effect 回调函数。</p>
<p>此时如果直接执， rootDoesHavePassiveEffects === null</p>
<p>rootDoesHavePassiveEffects 会在何时赋值？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rootDidHavePassiveEffects = rootDoesHavePassiveEffects;</span><br><span class="line"><span class="keyword">if</span> (rootDoesHavePassiveEffects) &#123;</span><br><span class="line">  rootDoesHavePassiveEffects = <span class="literal">false</span>;</span><br><span class="line">  rootWithPengdingPassiveEffects = root;</span><br><span class="line">  pendingPassiveEffectsLanes = lanes;</span><br><span class="line">  pendingPassiveEffectsRenderPriority = renderPriorityLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以整个 useEffect 异步调用分三步：</p>
<ol>
<li>Before mutation 阶段在 scheduleCallback 中调度 flushPassiveEffects</li>
<li>layout 阶段之后将 effectList 赋值给 rootWithPengdingPassiveEffects</li>
<li>scheduleCallback 触发 flushPassiveEffects，flushPassiveEffects 内部遍历 rootWithPengdingPassiveEffects</li>
</ol>
<h5 id="为何异步调用"><a href="#为何异步调用" class="headerlink" title="为何异步调用"></a>为何异步调用</h5><blockquote>
<p>与 componentDIdMount、componentDidUpdate 不同的是，在浏览器完成布局与绘制之后，传给 useEffect 的函数会延迟调用，这使得它适用于许多常见的副作用场景，比如设置订阅和事件处理等情况，因此不应在函数中执行阻塞浏览器更新屏幕的操作。</p>
</blockquote>
<p>主要是防止同步执行时阻塞浏览器渲染。</p>
<h3 id="mutation-阶段"><a href="#mutation-阶段" class="headerlink" title="mutation 阶段"></a>mutation 阶段</h3><p>DOM 操作</p>
<p>mutation 阶段也是遍历 effectList，执行函数，这里执行的是 commitMutationEffects。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nextEffect = firstEffect;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    commitMutationEffects(root, renderPriorityLevel);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    invariant(next !== <span class="literal">null</span>, <span class="string">"Should be working on an effect."</span>);</span><br><span class="line">    captureCommitPhaseError(nextEffect, error);</span><br><span class="line">    nextEffect = nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<h4 id="commitMutationEffects"><a href="#commitMutationEffects" class="headerlink" title="commitMutationEffects"></a>commitMutationEffects</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects</span>(<span class="params">root: FiberRoot, renderPriorityLevel</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 遍历effectList</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> effectTag = nextEffect.effectTag;</span><br><span class="line">    <span class="comment">// 根据ContentReset effectTag重置文字节点</span></span><br><span class="line">    <span class="keyword">if</span> (effectTag &amp; ContentReset) &#123;</span><br><span class="line">      commitResetTextContent(nextEffect);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新Ref</span></span><br><span class="line">    <span class="keyword">if</span> (effectTag &amp; Ref) &#123;</span><br><span class="line">      <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">      <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">        commitDetachRef(current);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据effectTag分别处理</span></span><br><span class="line">    <span class="keyword">const</span> primaryEffectTag =</span><br><span class="line">      effectTag &amp; (Placement | Update | Deletion | Hydrating);</span><br><span class="line">    <span class="keyword">switch</span> (primaryEffectTag) &#123;</span><br><span class="line">      <span class="comment">// 插入dom</span></span><br><span class="line">      <span class="keyword">case</span> Placement: &#123;</span><br><span class="line">        commitPlacement(nextEffect);</span><br><span class="line">        nextEffect.effectTag &amp;= ~Placement;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 插入dom并更新dom</span></span><br><span class="line">      <span class="keyword">case</span> PlacementAndUpdate: &#123;</span><br><span class="line">        <span class="comment">// 插入</span></span><br><span class="line">        commitPlacement(nextEffect);</span><br><span class="line">        nextEffect.effectTag &amp;= ~Placement;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新</span></span><br><span class="line">        <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// SSR</span></span><br><span class="line">      <span class="keyword">case</span> Hydrating: &#123;</span><br><span class="line">        nextEffect.effectTag &amp;= ~Hydrating;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// SSR</span></span><br><span class="line">      <span class="keyword">case</span> HydratingAndUpdate: &#123;</span><br><span class="line">        nextEffect.effectTag &amp;= ~Hydrating;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 更新dom</span></span><br><span class="line">      <span class="keyword">case</span> Update: &#123;</span><br><span class="line">        <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 删除dom</span></span><br><span class="line">      <span class="keyword">case</span> Deletion: &#123;</span><br><span class="line">        commitDeletion(root, nextEffect, renderPriorityLevel);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    nextEffect = nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>commitMutationEffects 会遍历 effectList，对每个 Fiber 节点执行如下操作:</p>
<ul>
<li>根据 ContentReset effectTag 重置文字节点</li>
<li>更新 Ref</li>
<li>根据 effectTag 分别处理，其中 effectTag 包括(Placement | Update | Deletion | Hydrating)</li>
</ul>
<h4 id="Placement-effect"><a href="#Placement-effect" class="headerlink" title="Placement effect"></a>Placement effect</h4><p>当 FIber 节点含有 Placement effectTag，意味着 Fiber 节点对应的 DOM 节点需要插入到页面中。</p>
<p>调用的方法为 commitPlacement</p>
<p>分三步：</p>
<ol>
<li>获取父级 dom 节点，其中 finishedWork 为传入的 Fiber 节点</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> parentFiber = getHostParentFiber(finishedWork);</span><br><span class="line"><span class="comment">// 父级dom节点</span></span><br><span class="line"><span class="keyword">const</span> parentStateNode = parentFiber.stateNode;</span><br></pre></td></tr></table></figure>

<p>2.获取 Fiber 节点的 dom 兄弟节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> before = getHostSibling(finishedWork);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>根据 dom 兄弟节点是否存在决定调用 parentNode.insertBefore 或 parentNode.appendChild 执行 dom 插入操作。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parentStateNode是否是rootFiber</span></span><br><span class="line"><span class="keyword">if</span> (isContainer) &#123;</span><br><span class="line">  insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  insertOrAppendPlacementNode(finishedWork, before, parent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getHostSibling 这步操作很耗时，当在同一个父级 Fiber 节点下一次执行多个插入操作，getHostSibling 算法复杂度为指数级。。。。</p>
<h4 id="Update-effect"><a href="#Update-effect" class="headerlink" title="Update effect"></a>Update effect</h4><p>当 Fiber 节点含有 update effecting，意味该 FIber 节点需要更新，调用的方法为 commitWork，会根据 FIber.tag 分别处理。</p>
<h4 id="FC-mutation"><a href="#FC-mutation" class="headerlink" title="FC mutation"></a>FC mutation</h4><p>当 tag 类型为 FC,会调用 commitHookEffectListUnmount。该方法会遍历 effectList，执行所有 useLayoutEffect hook 的销毁函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">useLayoutEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ...副作用逻辑</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...销毁函数</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="HostComponent-mutation"><a href="#HostComponent-mutation" class="headerlink" title="HostComponent mutation"></a>HostComponent mutation</h4><p>当 tag 类型为 HostComponent,会调用 commitUpdate。</p>
<p>最终会在 updateDOMProperties 中将 render 阶段 completeWork 中为 fiber 节点赋值的 updateQueue 对应的内容渲染在页面上。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; updatePayload.length; i += <span class="number">2</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> propKey = updatePayload[i];</span><br><span class="line">  <span class="keyword">const</span> propValue = updatePayload[i + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (propKey === STYLE) &#123;</span><br><span class="line">    setValueForStyles(domElement, propValue);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === DANGEROUSLY_SET_INNER_HTML) &#123;</span><br><span class="line">    setInnerHTML(domElement, propValue);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === CHILDREN) &#123;</span><br><span class="line">    setTextContext(domElement, propValue);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 处理props</span></span><br><span class="line">    setValueForProperty(domElement, propKey, propValue, isCustomComponentTag);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Deletion-effect"><a href="#Deletion-effect" class="headerlink" title="Deletion effect"></a>Deletion effect</h4><p>节点含有 Deletion effectTag,意味着该 fiber 节点对应的 dom 节点需要从页面中删除，调用方法为 commitDeletion。</p>
<p>该方法会执行如下操作：</p>
<ol>
<li>递归调用 Fiber 节点及其子孙 Fiber 节点中 fiber.tag 为 ClassComponent 的 componentWillUnmount 生命周期钩子，从页面中一次 fiber 节点对应的 dom 节点。</li>
<li>解绑 ref</li>
<li>调度 useEffect 的销毁函数</li>
</ol>
<p>mutation 阶段会遍历 effectList，依次执行 commitMutationEffects。该方法主要工作为根据 effectTag 调用不同的处理函数处理 FIber。</p>
<h3 id="layout-阶段"><a href="#layout-阶段" class="headerlink" title="layout 阶段"></a>layout 阶段</h3><p>该阶段的代码都是在 DOM 渲染完成后执行的。</p>
<p>该阶段触发的生命周期钩子和 hook 可以之际访问到已经改变后的 dom，即该阶段是可以参与 dom layout 的阶段。</p>
<p>与 before mutation 和 mutation 阶段一样，该阶段也是遍历 effectList，执行函数。</p>
<p>具体执行的函数是 commitLayoutEffects。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root.current = finishedWork;</span><br><span class="line"></span><br><span class="line">nextEffect = firstEffect;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    commitLayoutEffects(root, lanes);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    invariant(nextEffect !== <span class="literal">null</span>, <span class="string">"should be working on an effect"</span>);</span><br><span class="line">    captureCommitPhaseError(nextEffect, error);</span><br><span class="line">    nextEffect = nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>);</span><br><span class="line">nextEffect = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h4 id="commitLayoutEffects"><a href="#commitLayoutEffects" class="headerlink" title="commitLayoutEffects"></a>commitLayoutEffects</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutEffects</span>(<span class="params">root: FiberRoot, commit</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> effect = nextEffect.effectTag;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用生命周期钩子和hook</span></span><br><span class="line">    <span class="keyword">if</span> (effectTag &amp; (Update | Callback)) &#123;</span><br><span class="line">      <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">      commitLayoutEffectOnFiber(root, current, nextEffect, commitedLanes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 赋值ref</span></span><br><span class="line">    <span class="keyword">if</span> (effectTag &amp; Ref) &#123;</span><br><span class="line">      commitAttachRef(nextEffect);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>做了两件事</p>
<ol>
<li>commitLayoutEffectOnFiber(调用生命周期钩子和 hook)</li>
<li>commitAttachRef(赋值 ref)</li>
</ol>
<h4 id="commitLayoutEffectOnFiber"><a href="#commitLayoutEffectOnFiber" class="headerlink" title="commitLayoutEffectOnFiber"></a>commitLayoutEffectOnFiber</h4><p>根据 fiber.tag 对不同类型的节点分别处理。</p>
<ul>
<li><p>对 ClassComponent，会通过 current === null 区分 mount 还是 update，调用 componentDidMount 或 componentDidUpdat。</p>
<p>触发状态更新的 this.setState 如果赋值了第二个参数回调函数，也会在此时调用。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.setState(&#123; <span class="attr">a</span>: <span class="number">1</span> &#125;, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"xxxxx"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>对 FC 及相关类型，会调用 useLayoutEffect hook 的回调函数，调度 useEffect 的销毁与回调函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 相关类型指特殊处理后的FC,如ForwardRef、React.memo包裹的FC</span></span><br><span class="line"><span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">  <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">  <span class="keyword">case</span> ForwardRef:</span><br><span class="line">  <span class="keyword">case</span> SimpleMemoComponent:</span><br><span class="line">  <span class="keyword">case</span> Block: &#123;</span><br><span class="line">    <span class="comment">// 执行useLayoutEffect的回调函数</span></span><br><span class="line">    commitHookEffectListMount(HookLayout | HookHasEffect, finishedWork);</span><br><span class="line">    <span class="comment">// 调度useEffect的销毁函数与回调函数</span></span><br><span class="line">    schedulePassiveeEffects(finishedWork);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>useLayoutEffect 与 useEffect 区别：</p>
<p>​ useLayoutEffect<strong>从上一次更新的销毁函数调用到本次更新的回调函数调用是同步执行的</strong>。 先销毁再同步更新</p>
<p>​ useEffect 则<strong>需要先调度，在 Layout 阶段完成后在异步执行</strong>。 先调度再异步执行</p>
</li>
<li><p>对 HostRoot，如果赋值了第三个参数回调函数，也会在此时调用。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ReactDOM.render(&lt;App /&gt;, document.querySelector("#root"), function () &#123;</span><br><span class="line">  console.log("mount");</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="commitAttachRef"><a href="#commitAttachRef" class="headerlink" title="commitAttachRef"></a>commitAttachRef</h4><p>commitLayoutEffects 做的第二件事是 commitAttachRef</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitAttachRef</span>(<span class="params">finishedWork: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ref = finishedWork.ref;</span><br><span class="line">  <span class="keyword">if</span> (ref !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> instance = finishedWork.stateNode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取dom实例</span></span><br><span class="line">    <span class="keyword">let</span> instanceToUse;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> HostComponent:</span><br><span class="line">        instanceToUse = getPublicInstance(instance);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        instanceToUse = instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> ref === <span class="string">"function"</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果ref时函数形式，调用回调函数</span></span><br><span class="line">      ref(instanceToUse);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 如果是ref形式，赋值ref.current</span></span><br><span class="line">      ref.current = instanceToUse;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="current-Fiber-树切换"><a href="#current-Fiber-树切换" class="headerlink" title="current Fiber 树切换"></a>current Fiber 树切换</h4><p>至此整个 layout 阶段结束。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root.current = finishedWork;</span><br></pre></td></tr></table></figure>

<p>双缓存机制中,workInProgress Fiber 树在 commit 阶段完成渲染后会变为 current Fiber 树，这行代码的作用就是切换 fiberRootNode 指向的 current Fiber 树。</p>
<p>为啥这行代码在这？</p>
<p>componentWillUnmount 会在 mutation 阶段执行，此时 current Fiber 树还指向前一次更新的 Fiber 树，在生命周期钩子内获取的 DOM 还是更新前的。</p>
<p>componentDidMount 和 componentDidUpdate 会在 layout 阶段执行，此时 current Fiber 树已经指向更新后的 Fiber 树，在生命周期钩子内获取的 DOM 就是更新后的。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="diff"><a href="#diff" class="headerlink" title="diff"></a>diff</h3><blockquote>
<p>一个 dom 节点在某一时刻最多会有 4 个节点和他相关。</p>
<ol>
<li>current FIber。如果该 dom 节点已在页面中，current fiber 代表该 dom 节点对应的 fiber 节点</li>
<li>workInProgress Fiber。如果该 dom 节点在本次更新中渲染到页面中，workInProgress Fiber 代表该 dom 节点对应的 fiber 节点。</li>
<li>dom 节点本身。</li>
<li>JSX 对象。ClassComponent 的 render 方法，或 FC 的调用结果。JSX 对象中包含描述 dom 节点的信息。</li>
</ol>
<p><strong>diff 本质是对比 1 和 4 生成 2.</strong></p>
</blockquote>
<h3 id="diff-瓶颈以及-react-的应对"><a href="#diff-瓶颈以及-react-的应对" class="headerlink" title="diff 瓶颈以及 react 的应对"></a>diff 瓶颈以及 react 的应对</h3><p>两棵树完全比对的算法复杂程度为 O(n^3)，其中 n 是树中元素的数量。</p>
<p>为降低算法复杂度，react 的 diff 会预设 3 个限制：</p>
<ol>
<li>只对同级元素进行 diff。如果一个 dom 节点在前后两次更新中跨越了层级，那么 react 不会尝试复用它。（只同层比，跨级不比较）</li>
<li>两个不同类型的元素会产生不同的树。如果元素由 div 变为 p，react 会销毁 div 及其子孙节点，并新建 p 及其子孙节点。（元素不同树不同，只有销毁与新增操作）</li>
<li>可通过 key 来暗示子元素在不同的渲染下能保持稳定。</li>
</ol>
<h3 id="diff-实现"><a href="#diff-实现" class="headerlink" title="diff 实现"></a>diff 实现</h3><p>从 diff 入口函数 reconcileChildFibers 出发，该函数会根据 newChild 类型调用不同的处理函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据newChild类型选择不同diff函数处理</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  newChild: any</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">"object"</span> &amp;&amp; newChild !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (newChild.$$<span class="keyword">typeof</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">      <span class="comment">// 调用reconcilesSingleElement处理</span></span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">"string"</span> || <span class="keyword">typeof</span> newChild === <span class="string">"number"</span>) &#123;</span><br><span class="line">    <span class="comment">// 调用reconcileSingleTextNode处理</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isArray(newChild)) &#123;</span><br><span class="line">    <span class="comment">// 调用reconcileChildrenArray处理</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 以上都没有命中,删除节点</span></span><br><span class="line">  <span class="keyword">return</span> deleteRemainingChildren(returnFiber, currentFirstChild);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以将同级的节点数量将 diff 分为两类：</p>
<ol>
<li>当 newChild 类型为 object 、number、string，代表统计只有一个节点</li>
<li>当 newChild 类型为 Array，统计有多个节点。</li>
</ol>
<h4 id="单节点-diff"><a href="#单节点-diff" class="headerlink" title="单节点 diff"></a>单节点 diff</h4><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkzep06imaj311b0u07dm.jpg" alt></p>
<p>判断 dom 节点是否可以复用的实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileSiingleElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactElement</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = element.key;</span><br><span class="line">  <span class="keyword">let</span> child = currentFirstChild;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child.key === key) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (child.tag) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">          <span class="keyword">if</span> (child.elementType === element.type) &#123;</span><br><span class="line">            <span class="keyword">return</span> existing;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// type不同会跳出循环</span></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 代码执行到这里代表key相同但是type不同</span></span><br><span class="line">      <span class="comment">// 将该fiber及其兄弟fiber标记为删除</span></span><br><span class="line">      deleteRemainingChildren(returnFIber, child);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// key不同，将该fiber标记为删除</span></span><br><span class="line">      deleteChild(returnFiber, child);</span><br><span class="line">    &#125;</span><br><span class="line">    child = child.sibling;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建新Fiber并返回</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>key 相同? =&gt; type 相同? =&gt; 都相同 dom 节点才能复用。</p>
<h4 id="多节点-diff"><a href="#多节点-diff" class="headerlink" title="多节点 diff"></a>多节点 diff</h4><p>日常开发中，<strong>更新组件发生的频率较新增和删除更高</strong>，所以 diff 会优先判断当前节点是否是属于更新。</p>
<blockquote>
<p>虽然更新的 jsx 对象 newChildren 为数组形式，但是和 newChildren 中每个组件进行比较的是 current fiber，同级的 Fiber 节点是由 sibling 指针链接形成的单链表，即不支持双指针遍历。</p>
<p>因此无法使用双指针优化。</p>
</blockquote>
<p>基于以上，diff 的整体逻辑会经历两轮遍历。</p>
<p>第一轮遍历：处理更新的节点。</p>
<p>第二轮遍历：处理剩下的不属于更新的节点。</p>
<h5 id="第一轮遍历"><a href="#第一轮遍历" class="headerlink" title="第一轮遍历"></a>第一轮遍历</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. newChildren[i]与oldFiber比较，判断dom节点是否能复用</span><br><span class="line">2. 可服用，i++，继续比较newChildren[i]与oldFiber.slibling，可以复用则继续遍历</span><br><span class="line">3. 不可复用两种情况：1)key不同导致，立即跳出整个遍历，第一轮遍历结束 2)key同type不同，将oldFiber标记为DELETION，并继续遍历。</span><br><span class="line">4. 如果newChildren遍历完或oldFiber遍历完，跳出遍历，第一轮遍历结束</span><br></pre></td></tr></table></figure>

<p>带第一轮遍历结果进行第二轮遍历。</p>
<h5 id="第二轮遍历"><a href="#第二轮遍历" class="headerlink" title="第二轮遍历"></a>第二轮遍历</h5><p>newChildren（1）、oldFiber（2）</p>
<p>（1）（2）同时遍历完：只需在第一轮遍历进行组件更新。此时 diff 结束</p>
<p>（1）没完（2）完：已有 dom 节点都复用了，这时还有新加入的节点，意味本季更新有新节点插入，我们只需遍历剩下 newChildren 为生成的 workInProgress fiber 依次标记 placement</p>
<p>（1）完（2）没完：意味本次更新比之前的节点数量少，有节点被删除，所以需要遍历剩下 oldFiber，依次标记 Deletion</p>
<p>（1）（2）同时没完：意味有节点在这次更新中改变了位置</p>
<h5 id="处理移动的节点"><a href="#处理移动的节点" class="headerlink" title="处理移动的节点"></a>处理移动的节点</h5><p>需要用 key。</p>
<p>为快速找到 key 对应的 oldFiber，要将还未处理的 oldFiber 存入以 key 为 key，oldFiber 为 value 的 Map 中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> existingChildren = mapRemainingChildren(returnFiber, oldFiber);</span><br></pre></td></tr></table></figure>

<p>接下来遍历剩余的 newChildren，通过 newChildren[i].key 就能在 existingChilren 中找到 key 相同的 oldFiber</p>
<h5 id="标记节点是否移动"><a href="#标记节点是否移动" class="headerlink" title="标记节点是否移动"></a>标记节点是否移动</h5><p>参照物：最后一个可复用的节点在 oldFIber 的位置索引。</p>
<p>???</p>
<p>节点是按 newChildren 顺序排列，在遍历 newChildren 过程中，每个遍历到的可复用节点一定是当前遍历到的所有可复用节点中最靠右的那个，即一定在 lastPlaceIndex 对应的可复用的节点在本次更新中位置的后面。</p>
<p>那我们只需比较遍历到的可复用节点在上次更新时是否也在 lastPlaceIndex 对应的 oldFIber 后面，就能知道两次更新中这两个节点的相对位置有没有改变。</p>
<p>如果 oldIndex &lt; lastPlacedIndex，代表本次更新该节点需要向右移动。</p>
<p>lastPlacedIndex 初始为 0，每遍历一个可复用的节点，如果 oldIndex &gt;= lastPlacedIndex，则 lastPlacedIndex = oldIndex.</p>
<h3 id="状态更新"><a href="#状态更新" class="headerlink" title="状态更新"></a>状态更新</h3><h4 id="Update-结构"><a href="#Update-结构" class="headerlink" title="Update 结构"></a>Update 结构</h4><p>ClassComponent 与 HostRoot 共用同一种 Update 结构</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> update: Update&lt;*&gt; = &#123;</span><br><span class="line">  eventTime, <span class="comment">// 任务时间</span></span><br><span class="line">  lane, <span class="comment">// 优先级相关</span></span><br><span class="line">  suspenseConfig, <span class="comment">// Suspense相关</span></span><br><span class="line">  tag: UpdateState, <span class="comment">// 更新的类型 UpdateState ｜ ReplaceState | ForceUpdate | CaptureUpdate</span></span><br><span class="line">  payload: <span class="literal">null</span>, <span class="comment">// 更新挂载的数据</span></span><br><span class="line">  callback: <span class="literal">null</span>, <span class="comment">// 更新的回调函数</span></span><br><span class="line">  next: <span class="literal">null</span>, <span class="comment">// 与其他Update连接形成链表</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 由createUpdate返回</span></span><br></pre></td></tr></table></figure>

<h4 id="UpdateQueue"><a href="#UpdateQueue" class="headerlink" title="UpdateQueue"></a>UpdateQueue</h4><p>有 3 种类型</p>
<p>ClassComponent 与 HostRoot 使用的 UpdateQueue</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> queue: UpdateQueue&lt;State&gt; = &#123;</span><br><span class="line">  baseState: fiber.memoizedState, <span class="comment">// 本次更新前该fiber节点的state, Update基于该state计算更新后的state</span></span><br><span class="line">  firstBaseUpdate: <span class="literal">null</span>, <span class="comment">// 链表头</span></span><br><span class="line">  lastBaseUpdate: <span class="literal">null</span>, <span class="comment">// 链表尾</span></span><br><span class="line">  shared: &#123;</span><br><span class="line">    pending: <span class="literal">null</span>, <span class="comment">// 触发更新时，产生的Update会保存在shared.penging中形成单向环状链表</span></span><br><span class="line">  &#125;,</span><br><span class="line">  effects: <span class="literal">null</span>, <span class="comment">// 数组。保存update.callback !== null的Update</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><p>？？？</p>
<p><a href="https://react.iamkasong.com/state/priority.html#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BC%98%E5%85%88%E7%BA%A7" target="_blank" rel="noopener">优先级</a></p>
<h3 id="ReactDOM-render"><a href="#ReactDOM-render" class="headerlink" title="ReactDOM.render"></a>ReactDOM.render</h3><h4 id="创建-fiber"><a href="#创建-fiber" class="headerlink" title="创建 fiber"></a>创建 fiber</h4><p>首次执行 ReactDOM.render 会创建 fiberRootNode 和 rootFiber。其中 fiberRootNode 是整个应用的根节点，rootFiber 是要渲染组件树的根节点。</p>
<p>这一步发生在调用 ReactDOM.render 后进入的 legacyRenderSubtreeIntoContainer 方法中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// container指ReactDOM.render的第二个参数</span></span><br><span class="line">root = container._reactRootContainer = legacyCreteRootFromDOMContainer(</span><br><span class="line">  container,</span><br><span class="line">  forceHydrate</span><br><span class="line">);</span><br><span class="line">fiberRoot = root._internalRoot;</span><br></pre></td></tr></table></figure>

<p>legacyCreteRootFromDOMContainer 方法内部会调用 createFiberRoot 方法完成 fiberRootNode 和 rootFiber 的创建以及关联。并初始化 updateQueue。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createFiberRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrationCallbacks: null | SuspenseHydrationCallbacks</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建fiberRootNode</span></span><br><span class="line">  <span class="keyword">const</span> root: FiberRoot = (<span class="keyword">new</span> FiberRootNode(containerInfo, tag, hydrate): any);</span><br><span class="line">  <span class="comment">// 创建rootFiber</span></span><br><span class="line">  <span class="keyword">const</span> uninitializedFiber = createHostRootFiber(tag);</span><br><span class="line">  <span class="comment">// 连接rootFiber与fiberRootNode</span></span><br><span class="line">  root.current = uninitializedFiber;</span><br><span class="line">  uninitializedFiber.stateNode = root;</span><br><span class="line">  <span class="comment">// 初始化updateQueue</span></span><br><span class="line">  initialzeUpdateQueue(uninitializedFiber);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建-update"><a href="#创建-update" class="headerlink" title="创建 update"></a>创建 update</h4><p>做好了组件的初始化工作，接下来就等待创建 Update 来开启一次更新。</p>
<p>这一步发生在 updateContainer 中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent?: React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback?: Function</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Lane</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建update</span></span><br><span class="line">  <span class="keyword">const</span> update = createUpdate(eventTime, lane, suspenseConfig);</span><br><span class="line">  <span class="comment">// update.payload为需要挂载在根节点的组件</span></span><br><span class="line">  update.payload = &#123; element &#125;;</span><br><span class="line">  <span class="comment">// callback为ReactDOM.render的第三个参数</span></span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback;</span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    update.callback = callback;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将生成的update加入updateQueue</span></span><br><span class="line">  enqueueUpdate(current, update);</span><br><span class="line">  <span class="comment">// 调度更新</span></span><br><span class="line">  scheduleUpdateOnFiber(current, lane, eventTime);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个流程</p>
<p>创建各种 node 对象、创建更新对象、从 fiber 到 root、调度更新、diff 渲染(同步/异步)、提交更新</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">创建fiberRootNode、rootFiber、updateQueue（`legacyCreateRootFromDOMContainer`）</span><br><span class="line"></span><br><span class="line">    |</span><br><span class="line">    |</span><br><span class="line">    v</span><br><span class="line"></span><br><span class="line">创建Update对象（`updateContainer`）</span><br><span class="line"></span><br><span class="line">    |</span><br><span class="line">    |</span><br><span class="line">    v</span><br><span class="line"></span><br><span class="line">从fiber到root（`markUpdateLaneFromFiberToRoot`）</span><br><span class="line"></span><br><span class="line">    |</span><br><span class="line">    |</span><br><span class="line">    v</span><br><span class="line"></span><br><span class="line">调度更新（`ensureRootIsScheduled`）</span><br><span class="line"></span><br><span class="line">    |</span><br><span class="line">    |</span><br><span class="line">    v</span><br><span class="line"></span><br><span class="line">render阶段（`performSyncWorkOnRoot` 或 `performConcurrentWorkOnRoot`）</span><br><span class="line"></span><br><span class="line">    |</span><br><span class="line">    |</span><br><span class="line">    v</span><br><span class="line"></span><br><span class="line">commit阶段（`commitRoot`）</span><br></pre></td></tr></table></figure>

<h3 id="this-setState"><a href="#this-setState" class="headerlink" title="this.setState"></a>this.setState</h3><h4 id="this-setState-1"><a href="#this-setState-1" class="headerlink" title="this.setState"></a>this.setState</h4><p>该方法会调用 this.updater.enqueueSetState 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Component.prototype.setState = <span class="function"><span class="keyword">function</span> (<span class="params">partialState, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !(</span><br><span class="line">      <span class="keyword">typeof</span> partialState === <span class="string">"object"</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> partialState === <span class="string">"function"</span> ||</span><br><span class="line">      partialState === <span class="literal">null</span></span><br><span class="line">    )</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">Error</span>(</span><br><span class="line">      <span class="string">"setState(...): takes an object of state variables to update or a function which returns an object of state variables."</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.updater.enqueueSetState(<span class="keyword">this</span>, partialState, callback, <span class="string">"setState"</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>enqueueSetState 方法中就是 从创建 update 到调度 update 的流程。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">enqueueSetState(inst, payload, callback) &#123;</span><br><span class="line">  <span class="comment">// 通过组件实例获取对应fiber</span></span><br><span class="line">  <span class="keyword">const</span> fiber = getInstance(inst);</span><br><span class="line">  <span class="keyword">const</span> eventTime = requestEventTime();</span><br><span class="line">  <span class="keyword">const</span> suspenseConfig = requestCurrentSuspenseConfig();</span><br><span class="line">  <span class="comment">// 获取优先级</span></span><br><span class="line">  <span class="keyword">const</span> lane = requestUpdateLane(fiber, suspenseConfig);</span><br><span class="line">  <span class="keyword">const</span> update = createUpdate(eventTime, lane, suspenseConfig);</span><br><span class="line">  update.payload = payload;</span><br><span class="line">  <span class="comment">// 赋值回调函数</span></span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">undefined</span> &amp;&amp; callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    update.callback = callback;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将update插入updateQueue</span></span><br><span class="line">  enqueueUpdate(fiber, update)</span><br><span class="line">  <span class="comment">// 调度update</span></span><br><span class="line">  scheduleUpdateOnFiiber(fiber, lane, eventTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="this-forceUpdate"><a href="#this-forceUpdate" class="headerlink" title="this.forceUpdate"></a>this.forceUpdate</h4><p>this.updater 上，除了 enqueueSetState 外，还存在 enqueueForceUpdate，当我们调用 this.forceUpdate 时会调用他。</p>
<p>除了<code>update.tag = ForceUpdate</code>，以及没有额外<code>payload</code>，其他逻辑与<code>this.setState</code>一致。。。</p>
<h3 id="Hooks"><a href="#Hooks" class="headerlink" title="Hooks"></a>Hooks</h3><h4 id="极简-hooks-实现"><a href="#极简-hooks-实现" class="headerlink" title="极简 hooks 实现"></a>极简 hooks 实现</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [num, updateNum] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &lt;p onClick=&#123;() =&gt; updateNum((num) =&gt; num + 1)&#125;&gt;&#123;num&#125;&lt;/p&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可将工作分为两部：</p>
<ol>
<li>通过一些途径产生更新，更新会造成组件 render</li>
<li>组件 render 时 useState 返回 num 为更新后的结果</li>
</ol>
<p>步骤 1 分为 mount 和 update</p>
<ol>
<li>调用 ReactDOM.render 会产生 mount 的更新，更新内容为 useState 的 initialVal</li>
<li>点击 p 标签触发 updateNum 会产生一次 update 更新，更新内容为 num =&gt; num + 1</li>
</ol>
<h4 id="更新是啥"><a href="#更新是啥" class="headerlink" title="更新是啥"></a>更新是啥</h4><p>如上例子 更新就是如下数据结构</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> update = &#123;</span><br><span class="line">  <span class="comment">// 更新执行的函数</span></span><br><span class="line">  action,</span><br><span class="line">  <span class="comment">// 写同一个Hook的其他更新形成链表</span></span><br><span class="line">  next: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>改写下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 之前</span></span><br><span class="line"><span class="keyword">return</span> &lt;p onClick=&#123;() =&gt; updateNum((num) =&gt; num + 1)&#125;&gt;&#123;num&#125;&lt;/p&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 之后</span></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line">  &lt;p</span><br><span class="line">    onClick=&#123;() =&gt; &#123;</span><br><span class="line">      updateNum(<span class="function">(<span class="params">num</span>) =&gt;</span> num + <span class="number">1</span>);</span><br><span class="line">      updateNum(<span class="function">(<span class="params">num</span>) =&gt;</span> num + <span class="number">1</span>);</span><br><span class="line">      updateNum(<span class="function">(<span class="params">num</span>) =&gt;</span> num + <span class="number">1</span>);</span><br><span class="line">    &#125;&#125;</span><br><span class="line">  &gt;</span><br><span class="line">    &#123;num&#125;</span><br><span class="line">  &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>

<p>点 p 会产生 3 个 update</p>
<h4 id="update-数据结构"><a href="#update-数据结构" class="headerlink" title="update 数据结构"></a>update 数据结构</h4><p>q: 这些 update 如何组合在一起？</p>
<p>a: 他们会形成环状单向链表</p>
<p>调用 updateNum 实际调用的是 dispatchAction.bind(null, hook.queue)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchAction</span>(<span class="params">queue, action</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 创建update</span></span><br><span class="line">  <span class="keyword">const</span> update = &#123;</span><br><span class="line">    action,</span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 环状单向链表操作</span></span><br><span class="line">  <span class="keyword">if</span> (queue.pending === <span class="literal">null</span>) &#123;</span><br><span class="line">    update.next = next;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    update.next = queue.pending.next;</span><br><span class="line">    queue.pending.next = update;</span><br><span class="line">  &#125;</span><br><span class="line">  queue.pending = update;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模拟React开始调度更新</span></span><br><span class="line">  schedule();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="状态如何保存"><a href="#状态如何保存" class="headerlink" title="状态如何保存"></a>状态如何保存</h4><p>q: ClassComponent 的实例可以存储数据，对于 FC，queue 存在哪呢？</p>
<p>a: FC 对应的 fiber 中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App组件对应的fiber对象</span></span><br><span class="line"><span class="keyword">const</span> fiber = &#123;</span><br><span class="line">  <span class="comment">// 保存该FC对应的Hooks链表</span></span><br><span class="line">  memoizedState: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// 指向App函数</span></span><br><span class="line">  stateNode: App,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="Hook-数据结构"><a href="#Hook-数据结构" class="headerlink" title="Hook 数据结构"></a>Hook 数据结构</h4><p>Hook 与 update 类似，通过链表连接，不过 hook 是无环的单向链表</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hook = &#123;</span><br><span class="line">  <span class="comment">// 保存update的queue</span></span><br><span class="line">  queue: &#123;</span><br><span class="line">    pending: <span class="literal">null</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 保存hook对应的state</span></span><br><span class="line">  memoizedState: initialState,</span><br><span class="line">  <span class="comment">// 与下一个hook连接形成单向无环链表</span></span><br><span class="line">  next: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="模拟-React-调度更新流程"><a href="#模拟-React-调度更新流程" class="headerlink" title="模拟 React 调度更新流程"></a>模拟 React 调度更新流程</h4><p>用 isMount 指代 mount 还是 update</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">isMount = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">schedule</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 更新前将workInProgressHook重制为fiber保存的第一个Hook</span></span><br><span class="line">  workInProgressHook = fiber.memoizedState;</span><br><span class="line">  <span class="comment">// 触发组件render</span></span><br><span class="line">  fiber.stateNode();</span><br><span class="line">  <span class="comment">// 首次为mount之后都是update</span></span><br><span class="line">  isMount = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在组件 render 时，每当遇到下一个 useState，移动 workInProgressHook 指针</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">workInProgressHook = workInProgressHook.next;</span><br></pre></td></tr></table></figure>

<h4 id="计算-state"><a href="#计算-state" class="headerlink" title="计算 state"></a>计算 state</h4><p>render 时会调用 useState</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useState</span>(<span class="params">initiialState</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 当前useState使用hook会被赋值该变量</span></span><br><span class="line">  <span class="keyword">let</span> hook;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isMount) &#123;</span><br><span class="line">    <span class="comment">// ...mount时需要生成hook对象</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ...update时从workInProgressHook中取出该useState对应的hook</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> baseState = hook.memoizedState;</span><br><span class="line">  <span class="keyword">if</span> (hook.queue.pending) &#123;</span><br><span class="line">    <span class="comment">// ...根据queue.pending中保存的update更新state</span></span><br><span class="line">  &#125;</span><br><span class="line">  hook.memoizedState = baseState;</span><br><span class="line">  <span class="keyword">return</span> [baseState, dispatchAction.bind(<span class="literal">null</span>.hook.queue)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们找到 useState 对应的 hook 后，如果该 hook.queue.pending 不为空，则更新其 state</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useState</span>(<span class="params">initialState</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> hook;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isMount) &#123;</span><br><span class="line">    <span class="comment">// 挂载时的</span></span><br><span class="line">    hook = &#123;</span><br><span class="line">      queue: &#123;</span><br><span class="line">        pending: <span class="literal">null</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      memoizedState: initialState,</span><br><span class="line">      next: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 将hook插入fiber.memoizedState链表末尾</span></span><br><span class="line">    <span class="keyword">if</span> (!fiber.memoizedState) &#123;</span><br><span class="line">      fiber.memoizedState = hook;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      workInProgressHook.next = hook;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 移动workInProgressHook指针</span></span><br><span class="line">    workInProgressHook = hook;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新时找到对应hook</span></span><br><span class="line">    hook = workInProgressHook;</span><br><span class="line">    <span class="comment">// 移动workInProgressHook指针</span></span><br><span class="line">    workInProgressHook = workInProgressHook.next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 更新前初始state</span></span><br><span class="line">  <span class="keyword">let</span> baseState = hook.memoizedState;</span><br><span class="line">  <span class="keyword">if</span> (hook.queue.pending) &#123;</span><br><span class="line">    <span class="comment">// 获取update环状单向链表中第一个update</span></span><br><span class="line">    <span class="keyword">let</span> firstUpdate = hook.queue.pending.next;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="comment">// 执行update action</span></span><br><span class="line">      <span class="keyword">const</span> action = firstUpdate.action;</span><br><span class="line">      baseState = action(baseState);</span><br><span class="line">      firstUpdate = firstUpdate.next;</span><br><span class="line">      <span class="comment">// 最后一个update执行完后跳出循环</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (firstUpdate !== hook.queue.pending);</span><br><span class="line">    <span class="comment">// 清空queue.pending</span></span><br><span class="line">    hook.queue.pending = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将update action执行完之后的state作为memoizedState</span></span><br><span class="line">  hook.memoizedState = baseState;</span><br><span class="line">  <span class="keyword">return</span> [baseState, dispatchAction.bind(<span class="literal">null</span>, hook.queue)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="极简版与-react-区别"><a href="#极简版与-react-区别" class="headerlink" title="极简版与 react 区别"></a>极简版与 react 区别</h4><ol>
<li>React hooks 没用 ismount 变量，而是在不同时机使用不同的 dispatcher</li>
<li>React hooks 有中途跳过更新的优化手段</li>
<li>React hooks 有 batchedUpdates，三次更新只触发一次</li>
<li>React hooks 的 update 有优先级概念，可以跳过不高优先级的 update</li>
</ol>
<h3 id="hooks-数据结构"><a href="#hooks-数据结构" class="headerlink" title="hooks 数据结构"></a>hooks 数据结构</h3><h4 id="dispatcher"><a href="#dispatcher" class="headerlink" title="dispatcher"></a>dispatcher</h4><p>react hooks 中，组件 mount 时的 hook 与 update 的 hook 来源不同的对象，这类对象在源码中被称为 dispatcher</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mount时的Dispatcher</span></span><br><span class="line"><span class="keyword">const</span> HooksDispatcherOnMount: Dispatcher = &#123;</span><br><span class="line">  useCallback: mountCallback,</span><br><span class="line">  useContext: readContext,</span><br><span class="line">  useEffect: mountEffect,</span><br><span class="line">  useImperativeHandle: mountImperativeHandle,</span><br><span class="line">  useLayoutEffect: mountLayoutEffect,</span><br><span class="line">  useMemo: mountMemo,</span><br><span class="line">  useReducer: mountReducer,</span><br><span class="line">  useRef: mountRef,</span><br><span class="line">  useState: mountState,</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// update时的Dispatcher</span></span><br><span class="line"><span class="keyword">const</span> HooksDispatcherOnUpdate: Dispatcher = &#123;</span><br><span class="line">  useCallback: updateCallback,</span><br><span class="line">  useContext: readContext,</span><br><span class="line">  useEffect: updateEffect,</span><br><span class="line">  useImperativeHandle: updateImperativeHandle,</span><br><span class="line">  useLayoutEffect: updateLayoutEffect,</span><br><span class="line">  useMemo: updateMemo,</span><br><span class="line">  useReducer: updateReducer,</span><br><span class="line">  useRef: updateRef,</span><br><span class="line">  useState: updateState,</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>FC 的 render 前，会根据 FC 对应的 fiber 的以下条件区分 mount 和 update</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">current === <span class="literal">null</span> || current.memoizedState === <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>并将不同情况对应的 dispatcher 赋值给全局变量 ReactCurrentDispathcer 的 current 属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ReactCurrentDispatcher.current =</span><br><span class="line">  current === <span class="literal">null</span> || current.memoizedState === <span class="literal">null</span></span><br><span class="line">    ? HooksDispatcherOnMount</span><br><span class="line">    : HooksDispatcherOnUpdate;</span><br></pre></td></tr></table></figure>

<h4 id="hook-数据结构"><a href="#hook-数据结构" class="headerlink" title="hook 数据结构"></a>hook 数据结构</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hook: Hook = &#123;</span><br><span class="line">  memoizedState: <span class="literal">null</span>,</span><br><span class="line">  baseState: <span class="literal">null</span>,</span><br><span class="line">  baseQueue: <span class="literal">null</span>,</span><br><span class="line">  queue: <span class="literal">null</span>,</span><br><span class="line">  next: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="useState-与-useReducer"><a href="#useState-与-useReducer" class="headerlink" title="useState 与 useReducer"></a>useState 与 useReducer</h3><p>本质来说，useState 只是预置了 reducer 的 useReducer</p>
<h4 id="声明阶段"><a href="#声明阶段" class="headerlink" title="声明阶段"></a>声明阶段</h4><p>当 FC 进入 render 阶段的 beginWork 时，会调用 renderWithHooks，该方法内部会执行 FC 对应函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useState</span>(<span class="params">initialState</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> dispatcher = resolveDispatcher();</span><br><span class="line">  <span class="keyword">return</span> dispatcher.useState(initialState);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useReducer</span>(<span class="params">reducer, initialArg, init</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> dispatcher = resolveDispatcher();</span><br><span class="line">  <span class="keyword">return</span> dispatcher.useReducer(reducer, initialArg, init);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="mount-时-1"><a href="#mount-时-1" class="headerlink" title="mount 时"></a>mount 时</h5><p>mount 时, useReducer 会调用 mountReducer, useState 会调用 mountState</p>
<p>对比</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountState</span>&lt;<span class="title">S</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">	initialState: (() =&gt; S) | S,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): [<span class="title">S</span>, <span class="title">Dispatch</span>&lt;<span class="title">BasicStateAction</span>&lt;<span class="title">S</span>&gt;&gt;] </span>&#123;</span><br><span class="line">    <span class="comment">// 创建并返回当前hook</span></span><br><span class="line">    <span class="keyword">const</span> hook = mountWorkInProgressHook();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...赋值初始state</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建queue</span></span><br><span class="line">    <span class="keyword">const</span> queue = (hook.queue = &#123;</span><br><span class="line">      pending: <span class="literal">null</span>,</span><br><span class="line">      dispatch: <span class="literal">null</span>,</span><br><span class="line">      lastRenderedReducer: basicStateReducer,</span><br><span class="line">      lastRenderedState: (initialState: <span class="built_in">any</span>),</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// ...创建dispatch</span></span><br><span class="line">    <span class="keyword">return</span> [hook.memoizedState, dispatch]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountReducer</span>&lt;<span class="title">S</span>, <span class="title">I</span>, <span class="title">A</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">	reducer: (S, A) =&gt; S,</span></span></span><br><span class="line"><span class="function"><span class="params">  initialArg: I,</span></span></span><br><span class="line"><span class="function"><span class="params">  init?: I =&gt; S,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): [<span class="title">S</span>, <span class="title">Dispatch</span>&lt;<span class="title">A</span>&gt;] </span>&#123;</span><br><span class="line">  <span class="comment">// 创建并返回当前的hook</span></span><br><span class="line">  <span class="keyword">const</span> hook = mountWorkInProgressHook();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...赋值初始state</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建queue</span></span><br><span class="line">  <span class="keyword">const</span> queue = (hook.queue = &#123;</span><br><span class="line">    <span class="comment">// 保存update对象</span></span><br><span class="line">    pending: <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">// 保存dispatchAction.bind()的值</span></span><br><span class="line">    dispatch: <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">// 上一次render时使用的reducer</span></span><br><span class="line">    lastRenderedReducer: reducer,</span><br><span class="line">    <span class="comment">// 上一次render时的state</span></span><br><span class="line">    lastRenderedState: (initialState: <span class="built_in">any</span>),</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...创建dispatch</span></span><br><span class="line">  <span class="keyword">return</span> [hook.memoizedState, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个 hook 唯一区别是 queue 的 lastRenderedReducer 字段。</p>
<p>basicStateReducer</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">basicStateReducer</span>&lt;<span class="title">S</span>&gt;(<span class="params">state: S, action: BasicStateAction&lt;S&gt;</span>): <span class="title">S</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> action === <span class="string">"function"</span> ? action(state) : action;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="update-时-1"><a href="#update-时-1" class="headerlink" title="update 时"></a>update 时</h5><p>两者调用的是同一个 updateReducer</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateReducer</span>&lt;<span class="title">S</span>, <span class="title">I</span>, <span class="title">A</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">	reducer: (S, A) =&gt; S,</span></span></span><br><span class="line"><span class="function"><span class="params">  initialArg: I,</span></span></span><br><span class="line"><span class="function"><span class="params">  init?: I =&gt; S,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): [<span class="title">S</span>, <span class="title">Dispatch</span>&lt;<span class="title">A</span>&gt;] </span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前hook</span></span><br><span class="line">  <span class="keyword">const</span> hook = updateWorkInProgress();</span><br><span class="line">  <span class="keyword">const</span> queue = hook.queue;</span><br><span class="line"></span><br><span class="line">  queue.lastRenderedReducer = reducer;</span><br><span class="line">   <span class="comment">// ...同update与updateQueue逻辑类似</span></span><br><span class="line">  <span class="keyword">const</span> dispatch: Dispatch&lt;A&gt; = (queue.dispatch: <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">return</span> [hook.memoizedState, dispatch]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="调用阶段"><a href="#调用阶段" class="headerlink" title="调用阶段"></a>调用阶段</h4><p>调用阶段会执行 dispatchAction，此时 FC 对应的 fiber 以及 hook.queue 以及通过 bind 方法预先最为参数传入。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchAction</span>(<span class="params">fiber, queue, action</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...创建update</span></span><br><span class="line">  <span class="keyword">var</span> update = &#123;</span><br><span class="line">    eventTime,</span><br><span class="line">    lane,</span><br><span class="line">    suspenseConfig,</span><br><span class="line">    action,</span><br><span class="line">    eagerReducer: <span class="literal">null</span>,</span><br><span class="line">    eagerState: <span class="literal">null</span>,</span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...将update加入queue.pending</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> alternate = fiber.alternate;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    fiber === currentlyRenderingFiber$<span class="number">1</span> ||</span><br><span class="line">    (alternate !== <span class="literal">null</span> &amp;&amp; alternate === currentlyRenderingFiber$<span class="number">1</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// render阶段触发的更新</span></span><br><span class="line">    didScheduleRenderPhaseUpdateDuringThisPass = didScheduleRenderPhaseUpdate = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      fiber.lanes === NoLanes &amp;&amp;</span><br><span class="line">      (alternate === <span class="literal">null</span> || alternate.lanes === NoLanes)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// ...fiber的updateQueue为空，优化路径</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    scheduleUpdateOnFiber(fiber, lane, eventTime);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个过程概括：创建 update，将 update 加入 queue.pending 中，并开启调度。</p>
<h3 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h3><h4 id="flushPassiveEffectsImpl"><a href="#flushPassiveEffectsImpl" class="headerlink" title="flushPassiveEffectsImpl"></a>flushPassiveEffectsImpl</h4><p>flushPassiveEffects 内部会设置优先级，并执行 flushPassiveEffectsImpl</p>
<p>flushPassiveEffectsImpl 主要做 3 件事：</p>
<ul>
<li>调用该 useEffect 在上一次 render 时的销毁函数</li>
<li>调用该 useEffect 在本次 render 时的回调函数</li>
<li>如果存在同步任务，不需要等待下次事件循环的宏任务，提前执行他</li>
</ul>
<blockquote>
<p>副作用清理函数在 V16 中同步运行，对大型应用程序来说，会减缓屏幕的过度</p>
</blockquote>
<p>V17，useEffect 的两个阶段会在页面渲染后异步执行。</p>
<h4 id="销毁函数的执行"><a href="#销毁函数的执行" class="headerlink" title="销毁函数的执行"></a>销毁函数的执行</h4><p>useEffect 的执行需要保证所有组件的 useEffect 的销毁函数必须都执行完之后才能执行任意一个组件的 useEffect 的回调函数。这时因为多个组件间可能共用同一个 ref。</p>
<p>都遵循全部销毁再全部执行的顺序。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pengdingPassiveHookEffectsUnmount中保存了所有需要执行销毁的useEffect</span></span><br><span class="line"><span class="keyword">const</span> unmountEffects = pendingPassiveHookEffectsUnmount;</span><br><span class="line">pendingPassiveHookEffectsUnmount = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; unmountEffects.length; i += <span class="number">2</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> effect = ((unmountEffects[i]: any): HookEffect);</span><br><span class="line">  <span class="keyword">const</span> fiber = ((unmountEffects[i + <span class="number">1</span>]: any): Fiber);</span><br><span class="line">  <span class="keyword">const</span> destroy = effect.destroy;</span><br><span class="line">  effect.destroy = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> destroy === <span class="string">"function"</span>) &#123;</span><br><span class="line">    <span class="comment">// 销毁函数存在则执行</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      destroy();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      captureCommitPhaseError(fiber, error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">schedulePassiveEffects</span>(<span class="params">finishedWork: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue: FunctionComponentUpdateQueue | <span class="literal">null</span> = (finishedWork.updateQueue: <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">const</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.lastEffect: <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstEffect = lastEffect.next;</span><br><span class="line">    <span class="keyword">let</span> effect = firstEffect;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;next, tag&#125; = effect;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        (tag &amp; HookPassive) !== NoHookEffect &amp;&amp;</span><br><span class="line">        (tag &amp; HookHasEffect) !== NoHookEffect</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// 向`pendingPassiveHookEffectsUnmount`数组内`push`要销毁的effect</span></span><br><span class="line">        enqueuePendingPassiveHookEffectUnmount(finishedWork, effect);</span><br><span class="line">        <span class="comment">// 向`pendingPassiveHookEffectsMount`数组内`push`要执行回调的effect</span></span><br><span class="line">        enqueuePendingPassiveHookEffectMount(finishedWork, effect);</span><br><span class="line">      &#125;</span><br><span class="line">      effect = next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="回调函数执行"><a href="#回调函数执行" class="headerlink" title="回调函数执行"></a>回调函数执行</h4><p>遍历数组，执行对应 effect 的回调函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pendingPassiveHookEffectsMount中保存了所有需要执行回调的useEffect</span></span><br><span class="line"><span class="keyword">const</span> mountEffects = pendingPassiveHookEffectsMount;</span><br><span class="line">pendingPassiveHookEffectsMount = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; mountEffects.length; i += <span class="number">2</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> effect = ((mountEffects[i]: any): HookEffect);</span><br><span class="line">  <span class="keyword">const</span> fiber = ((mountEffects[i + <span class="number">1</span>]: any): Fiber);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> create = effect.create;</span><br><span class="line">    effect.destroy = create();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    captureCommitPhaseError(fiber, error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="useRef"><a href="#useRef" class="headerlink" title="useRef"></a>useRef</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// |current: T| ???</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountRef</span>&lt;<span class="title">T</span>&gt;(<span class="params">initialValue: T</span>): </span>&#123;|current: T|&#125; &#123;</span><br><span class="line">  <span class="comment">// 获取当前useRef hook</span></span><br><span class="line">  <span class="keyword">const</span> hook = mountWorkInProgressHook();</span><br><span class="line">  <span class="comment">// 创建ref</span></span><br><span class="line">  <span class="keyword">const</span> ref = &#123; <span class="attr">current</span>: initialValue &#125;;</span><br><span class="line">  hook.memorized = ref;</span><br><span class="line">  <span class="keyword">return</span> ref</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateRef</span>&lt;<span class="title">T</span>&gt;(<span class="params">initialValue: T</span>): </span>&#123;|current: T|&#125; &#123;</span><br><span class="line">  <span class="comment">// 获取当前useRef hook</span></span><br><span class="line">  <span class="keyword">const</span> hook = mountWorkInProgressHook();</span><br><span class="line">  <span class="comment">// 返回保存的数据</span></span><br><span class="line">  reutrn hook.memoizedState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// createRef</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRef</span>(<span class="params"></span>): <span class="title">RefObject</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> refObject = &#123;</span><br><span class="line">    current: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> refObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="render-阶段-1"><a href="#render-阶段-1" class="headerlink" title="render 阶段"></a>render 阶段</h4><p>在 render 阶段的 beginWork 与 completeWork 中有个同名方法 markRef 用于为含有 ref 属性的 fiber 增加 Ref effectTag。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// beginWork的markRef</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">markRef</span>(<span class="params">current: Fiber | null, workInProgress: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ref = workInProgress.ref;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (current === <span class="literal">null</span> &amp;&amp; ref !== <span class="literal">null</span>) ||</span><br><span class="line">    (current !== <span class="literal">null</span> &amp;&amp; current.ref !== ref)</span><br><span class="line">  ) &#123;</span><br><span class="line">    workInProgress.effectTag |= Ref;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// completeWork的markRef</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">markRef</span>(<span class="params">workInProgress: Fiber</span>) </span>&#123;</span><br><span class="line">  workInProgress.effectTag |= Ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>组件对应的 fiber 被赋值 Ref effectTag 需要满足的条件：</p>
<ul>
<li>fiber 类型为 HostComponent、ClassComponent、ScopeComponent</li>
<li>对于 mount, workInProgress.ref !== null,即存在 ref 属性</li>
<li>对于 update, current.ref !== workInProgress.ref ，即 ref 属性改变</li>
</ul>
<h4 id="commit-阶段-1"><a href="#commit-阶段-1" class="headerlink" title="commit 阶段"></a>commit 阶段</h4><p>在 commit 阶段的 mutation 阶段，对于 ref 属性改变的情况，需要先移除之前的 ref</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects</span>(<span class="params">root: FiberRoot, renderPriorityLevel</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> effectTag = nextEffect.effectTag;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (effectTag &amp; Ref) &#123;</span><br><span class="line">      <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">      <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 移除之前ref</span></span><br><span class="line">        commitDetachRef(current);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitDetachRef</span>(<span class="params">current: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> currentRef = current.ref;</span><br><span class="line">  <span class="keyword">if</span> (currentRef !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> currentRef === <span class="string">"function"</span>) &#123;</span><br><span class="line">      <span class="comment">// function类型ref, 调用他，传参为null</span></span><br><span class="line">      currentRef(<span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 对象类型ref, current赋值为null</span></span><br><span class="line">      currentRef.current = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="useMemo-与-useCallback"><a href="#useMemo-与-useCallback" class="headerlink" title="useMemo 与 useCallback"></a>useMemo 与 useCallback</h3><h4 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountMemo</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  nextCreate: (</span>) =&gt; <span class="title">T</span>,</span></span><br><span class="line"><span class="function">  <span class="title">deps</span>: <span class="title">Array</span>&lt;<span class="title">mixed</span>&gt; | <span class="title">void</span> | <span class="title">null</span></span></span><br><span class="line"><span class="function">): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建并返回当前hook</span></span><br><span class="line">  <span class="keyword">const</span> hook = mountWorkInProgressHook();</span><br><span class="line">  <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">  <span class="comment">// 计算value</span></span><br><span class="line">  <span class="keyword">const</span> nextValue = nextCreate();</span><br><span class="line">  <span class="comment">// 将value与deps保存在hook.memoizedState</span></span><br><span class="line">  hook.memoizedState = [nextValue, nextDeps];</span><br><span class="line">  <span class="keyword">return</span> nextValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountCallback</span>&lt;<span class="title">T</span>&gt;(<span class="params">callback: T, deps: Array&lt;mixed&gt; | void | null</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建并返回当前hook</span></span><br><span class="line">  <span class="keyword">const</span> hook = mountWorkInProgressHook();</span><br><span class="line">  <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">  <span class="comment">// 将value与deps保存在hook.memoizedState</span></span><br><span class="line">  hook.memoizedState = [callback, nextDeps];</span><br><span class="line">  <span class="keyword">return</span> callback;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与 mountCallback 这两个唯一区别是</p>
<ul>
<li>mountMemo 会将回调函数的执行结果作为 value 保存</li>
<li>mountCallback 会保存回调函数结果作为 value 保存</li>
</ul>
<h4 id="update"><a href="#update" class="headerlink" title="update"></a>update</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateMemo</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  nextCreate: (</span>) =&gt; <span class="title">T</span>,</span></span><br><span class="line"><span class="function">  <span class="title">deps</span>: <span class="title">Array</span>&lt;<span class="title">mixed</span>&gt; | <span class="title">void</span> | <span class="title">null</span></span></span><br><span class="line"><span class="function">): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 返回当前hook</span></span><br><span class="line">  <span class="keyword">const</span> hook = updateWorkInProgressHook();</span><br><span class="line">  <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">  <span class="keyword">const</span> prevState = hook.memoizedState;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prevState !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextDeps !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> prevDeps: <span class="built_in">Array</span>&lt;mixed&gt; | <span class="literal">null</span> = prevState[<span class="number">1</span>];</span><br><span class="line">      <span class="comment">// 判断update前后value是否变化</span></span><br><span class="line">      <span class="keyword">if</span> (areHookInputsEqual(nextDeps, prevDeps)) &#123;</span><br><span class="line">        <span class="comment">// 未变化</span></span><br><span class="line">        <span class="keyword">return</span> prevState[<span class="number">0</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 变化，重新计算value</span></span><br><span class="line">  <span class="keyword">const</span> nextValue = nextCreate();</span><br><span class="line">  hook.memoizedState = [nextValue, nextDeps];</span><br><span class="line">  <span class="keyword">return</span> nextValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateCallback</span>&lt;<span class="title">T</span>&gt;(<span class="params">callback: T, deps: Array&lt;mixed&gt; | void | null</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 返回当前hook</span></span><br><span class="line">  <span class="keyword">const</span> hook = updateWorkInProgressHook();</span><br><span class="line">  <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">  <span class="keyword">const</span> prevState = hook.memoizedState;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prevState !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextDeps !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> prevDeps: <span class="built_in">Array</span>&lt;mixed&gt; | <span class="literal">null</span> = prevState[<span class="number">1</span>];</span><br><span class="line">      <span class="comment">// 判断update前后value是否变化</span></span><br><span class="line">      <span class="keyword">if</span> (areHookInputsEqual(nextDeps, prevDeps)) &#123;</span><br><span class="line">        <span class="comment">// 未变化</span></span><br><span class="line">        <span class="keyword">return</span> prevState[<span class="number">0</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 变化，将新的callback作为value</span></span><br><span class="line">  hook.memoizedState = [callback, nextDeps];</span><br><span class="line">  <span class="keyword">return</span> callback;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Concurrent-Mode"><a href="#Concurrent-Mode" class="headerlink" title="Concurrent Mode"></a>Concurrent Mode</h2><p>Scheduler，含两个功能：</p>
<ol>
<li>时间切片</li>
<li>优先级调度</li>
</ol>
<h3 id="时间切片原理"><a href="#时间切片原理" class="headerlink" title="时间切片原理"></a>时间切片原理</h3><p>本质是模拟实现<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback" target="_blank" rel="noopener">requesrIdleCallback</a></p>
<p>除去浏览器重排重绘，下图是浏览器一帧中可以用于执行 js 的时机。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一个task(宏任务) -- 队列中全部job(微任务) -- requestAnimationFrame -- 浏览器重排/重绘 -- requestIdleCallback</span><br></pre></td></tr></table></figure>

<p>requestAnimationFrame 让我们可以在浏览器重排重绘之前执行 js。</p>
<p>我们通常使用这个 api 实现 js 动画，这时浏览器渲染前的最后时机。</p>
<h3 id="优先级调度"><a href="#优先级调度" class="headerlink" title="优先级调度"></a>优先级调度</h3><p>Scheduler 对外暴露一个方法 unstable_runWithPriority</p>
<p>这个方法接受一个优先级与一个回调函数，在回调函数内部调用获取优先级的方法都会取得第一个参数对应的优先级：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unstable_runWithPriority</span>(<span class="params">priorityLevel, eventHandler</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (priorityLevel) &#123;</span><br><span class="line">    <span class="keyword">case</span> ImmediatePriority:</span><br><span class="line">    <span class="keyword">case</span> UserBlockingPriority:</span><br><span class="line">    <span class="keyword">case</span> NormalPriority:</span><br><span class="line">    <span class="keyword">case</span> LowPriority:</span><br><span class="line">    <span class="keyword">case</span> IdlePriority:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      priorityLevel = NormalPriority;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> previousPriorityLevel = currentPriorityLevel;</span><br><span class="line">  currentPriorityLevel = priorityLevel;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> eventHandler();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    currentPriorityLevel = previousPriorityLevel;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="lane"><a href="#lane" class="headerlink" title="lane"></a>lane</h4><p>使用 31 位二进制代表 31 条赛道，位数越小的赛道优先级越高，某些相邻的赛道拥有相同优先级</p>
<p>越低优先级的更新越容易被打断，导致积压下来，所以需要更多的位。</p>
<p>优先级运算-位运算</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2020/11/29/react原理/" data-id="ckonxihvg001ettyzch9ostzp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/React/">React</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-设计模式" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/10/14/设计模式/" class="article-date">
  <time datetime="2020-10-14T15:04:14.000Z" itemprop="datePublished">2020-10-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/10/14/设计模式/">前端路线</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h1><table>
<thead>
<tr>
<th align="center">SN</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Creational</td>
<td align="center">根据创建对象的概念分为以下几类</td>
</tr>
<tr>
<td align="center">Class</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">Factory Method(工厂方法)</td>
<td align="center">通过将数据和事件接口化来构建若干个子类。</td>
</tr>
<tr>
<td align="center">Object</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">Abstract Factory(抽象工厂)</td>
<td align="center">建立若干族类的一个实例，这个实例不需要具体类的细节信息。</td>
</tr>
<tr>
<td align="center">Builder(建造者)</td>
<td align="center">将对象的构建方法和其实现形式分离开来，总是构建相同类型的对象。</td>
</tr>
<tr>
<td align="center">Prototype(原型)</td>
<td align="center">一个完全初始化的实例，用于拷贝</td>
</tr>
<tr>
<td align="center">Singleton(单例)</td>
<td align="center">一个类只有唯一的一个实例，这个实例在镇哥哥程序中有一个全局的访问点。</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Structural</th>
<th>根据创建对象块氛围以下几类</th>
</tr>
</thead>
<tbody><tr>
<td>Class</td>
<td></td>
</tr>
<tr>
<td>Adapter(适配器)</td>
<td>将不同类的接口进行匹配，调整，这样景观内部接口不兼容但是不同的类还是可以协同工作。</td>
</tr>
<tr>
<td>Bridge(桥接)</td>
<td>将对象的接口从其实现中分离出来，这样对象的实现和接口可以独立的变化。</td>
</tr>
<tr>
<td>Composite(组合)</td>
<td>通过将简单可组合的对象组合起来，构成一个完整的对象，这个对象的能力将会潮服哦这些组成部分的能力的综合，即会有新能力产生。</td>
</tr>
<tr>
<td>Decorator(装饰器)</td>
<td>动态给对象增加一些可替换的处理流程。</td>
</tr>
<tr>
<td>Facada(外观)</td>
<td>一个类隐藏了内部子系统的复杂度，只暴露出一些简单的接口。</td>
</tr>
<tr>
<td>Flyweight(享元)</td>
<td>一个细粒度对象，用于将包含在其他地方的信息在不同对象之间高效地共享。</td>
</tr>
<tr>
<td>Proxy(代理)</td>
<td>一个充当占位符的对象用来代表一个真实的对象。</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Behavioral</th>
<th>基于对象间作用方式来分类</th>
</tr>
</thead>
<tbody><tr>
<td>Class</td>
<td></td>
</tr>
<tr>
<td>Interpreter(解释器)</td>
<td>将语言元素包含在一个应用的一种方式，用于匹配目标语言的语法。</td>
</tr>
<tr>
<td>Template Method(模版方法)</td>
<td>在一个方法中为某个算法简历一层外壳，将算法的具体步骤交给子类去做。</td>
</tr>
<tr>
<td>Object</td>
<td></td>
</tr>
<tr>
<td>Chain of Responsibility(响应链)</td>
<td>一种将请求在一串对象中传递的方式，寻找可以处理这个请求的对象。</td>
</tr>
<tr>
<td>Command(命令)</td>
<td>封装命令请求为一个对象，从而使记录日志，队列缓存请求，未处理请求进行错误处理 这些功能成为可能。？？？</td>
</tr>
<tr>
<td>Iterator(迭代器)</td>
<td>在不需要直到集合内部工作原理的情况下，顺序访问一个集合里的元素。</td>
</tr>
<tr>
<td>Mediator(中介者)</td>
<td>在类之间定义简化的通行方式，用于避免类之间显式的持有彼此的引用。</td>
</tr>
<tr>
<td>Observer(观察者)</td>
<td>用于将变化通知给多个类的方式，可以保证类之间的一致性。</td>
</tr>
<tr>
<td>State(状态)</td>
<td>当对象改变时，改变对象的行为。</td>
</tr>
<tr>
<td>Strateg(策略)</td>
<td>将算法封装到类中，将选择和实现分离开来。</td>
</tr>
<tr>
<td>Visitor(访问者)</td>
<td>为类增加新的操作而不改变类本身。</td>
</tr>
</tbody></table>
<h2 id="构造器模式"><a href="#构造器模式" class="headerlink" title="构造器模式"></a>构造器模式</h2><p>原：构造器是一个当新建对象的内存被分配后，用来初始化该对象的一个特殊函数。它是用来创建特殊类型对象的，首先它要准备使用的对象，其次在对象初次被创建时，通过接收参数，构造器用来对成员的属性和方法进行赋值。</p>
<p>白：其实就是创建一个空对象，然后赋值啊赋值。。。</p>
<h3 id="对象创建"><a href="#对象创建" class="headerlink" title="对象创建"></a>对象创建</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对象构建三种方式</span></span><br><span class="line"><span class="keyword">var</span> a = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> a = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br></pre></td></tr></table></figure>

<h3 id="属性设置"><a href="#属性设置" class="headerlink" title="属性设置"></a>属性设置</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. a.b</span></span><br><span class="line"><span class="comment">// 2. a[b]</span></span><br><span class="line"><span class="comment">// 3.</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(newObject, <span class="string">'key'</span>, &#123;</span><br><span class="line">  value: <span class="string">'xxxxx'</span>,</span><br><span class="line">  writeable: <span class="literal">true</span>,</span><br><span class="line">  enumerable: <span class="literal">true</span>,</span><br><span class="line">  configurable: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 4.</span></span><br><span class="line"><span class="built_in">Object</span>.definePropertie(newObject, &#123;</span><br><span class="line">  key1: &#123;</span><br><span class="line">    value: <span class="string">'val1'</span>,</span><br><span class="line">    writeable: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  key2: &#123;</span><br><span class="line">    value: <span class="string">'val2'</span>,</span><br><span class="line">    writeable: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="使用原型的构造器"><a href="#使用原型的构造器" class="headerlink" title="使用原型的构造器"></a>使用原型的构造器</h3><p>js 函数中的 prototype，当调用 js 构造器创建一个对象时，构造函数 prototype 上的属性对于所创建的对象来说都看见。这样就可以创建多访问相同 prototype 的 Car 对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Car</span>(<span class="params">model, year, miles</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.model = model;</span><br><span class="line">  <span class="keyword">this</span>.year = year;</span><br><span class="line">  <span class="keyword">this</span>.miles = miles;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Car.prototype.toString = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.model + <span class="string">''</span> + <span class="keyword">this</span>.miles;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// usage</span></span><br><span class="line"><span class="keyword">var</span> aaa = <span class="keyword">new</span> Car(<span class="string">'aaa'</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> bbb = <span class="keyword">new</span> Car(<span class="string">'bbb'</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这样的话，单个toString()实例被所有的Car对象所共享了。</span></span><br></pre></td></tr></table></figure>

<h2 id="模块化模式"><a href="#模块化模式" class="headerlink" title="模块化模式"></a>模块化模式</h2><p>原：用来进一步模拟类的概念，通过这样一种方式：我可以在一个单一的对象中包含公有/私有方法和变量，从而从全局范围中屏蔽特定的部分。这个结果是可以减少我们的函数名称在页面中其他脚本区域定义的函数名称冲突的可能性。</p>
<p>白：建个模块对象，起个名字，类似[Symbol.xxx]，使上下文各种引用不冲突。其实就是闭包。</p>
<h3 id="创建一个自包含模块实现模块化模式"><a href="#创建一个自包含模块实现模块化模式" class="headerlink" title="创建一个自包含模块实现模块化模式"></a>创建一个自包含模块实现模块化模式</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 闭包来一波</span></span><br><span class="line"><span class="keyword">var</span> module1 = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> count = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    increment: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> count++;</span><br><span class="line">    &#125;</span><br><span class="line">    reset: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      count = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br><span class="line"></span><br><span class="line"><span class="comment">// usage</span></span><br><span class="line">module1.increment();</span><br><span class="line">module1.reset()</span><br></pre></td></tr></table></figure>

<h3 id="含命名空间、公有-私有变量的模块化实现"><a href="#含命名空间、公有-私有变量的模块化实现" class="headerlink" title="含命名空间、公有/私有变量的模块化实现"></a>含命名空间、公有/私有变量的模块化实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> module2 = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> privateVar, privateMethod;</span><br><span class="line"></span><br><span class="line">  privateVar = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  privateMethod = <span class="function"><span class="keyword">function</span> (<span class="params">foo</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(foo);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    privateVar: <span class="string">'foo'</span>,</span><br><span class="line">    privateMethod: <span class="function"><span class="keyword">function</span> (<span class="params">bar</span>) </span>&#123;</span><br><span class="line">      privateVar++;</span><br><span class="line">      privateMethod(bar);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h3 id="购物车例子"><a href="#购物车例子" class="headerlink" title="购物车例子"></a>购物车例子</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> basketModule = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 私有</span></span><br><span class="line">  <span class="keyword">var</span> basket = [];</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">privatefn1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">privatefn2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    addItem: <span class="function"><span class="keyword">function</span>(<span class="params">values</span>) </span>&#123;</span><br><span class="line">      basket.push(values);</span><br><span class="line">    &#125;,</span><br><span class="line">    getItemCount: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> basket.length;</span><br><span class="line">    &#125;,</span><br><span class="line">    doSomething: privatefn1,</span><br><span class="line">    getTotal: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    	<span class="keyword">var</span> q = <span class="keyword">this</span>.getItemCount();</span><br><span class="line">      retun q;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 就是把同类相关东西放到一起，一顿操作，拿到相关数据信息返回或者其他。。。</span></span><br></pre></td></tr></table></figure>

<h3 id="模块模式变体"><a href="#模块模式变体" class="headerlink" title="模块模式变体"></a>模块模式变体</h3><h4 id="import-mixing-导入混合"><a href="#import-mixing-导入混合" class="headerlink" title="import mixing(导入混合)"></a>import mixing(导入混合)</h4><p>展现如何将全局作为一个参数传入模块的匿名函数，这种方式允许我们导入全局，并且按照我们的想法在本地为这些全局起一个别名。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> module3 = (<span class="function"><span class="keyword">function</span> (<span class="params">JQ, _</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">privateMethod1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    JQ(<span class="string">'.container'</span>).html(<span class="string">'test'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">privateMethod2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(_.min([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    publicMethod: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      privateMethod1();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)(JQuery, _);</span><br><span class="line"></span><br><span class="line">module3.publicMethod();</span><br></pre></td></tr></table></figure>

<h4 id="Exports-导出"><a href="#Exports-导出" class="headerlink" title="Exports(导出)"></a>Exports(导出)</h4><p>这个变体允许我们声明全局对象而不用使用他们。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> module4 = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="built_in">module</span> = &#123;&#125;,</span><br><span class="line">    privateVar = <span class="string">'123'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">privateMethod</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">module</span>.publicProperty = <span class="string">'aaa'</span>;</span><br><span class="line">  <span class="built_in">module</span>.publicMethod = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(privateMethod);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">module</span>;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h3 id="优-缺点"><a href="#优-缺点" class="headerlink" title="优/缺点"></a>优/缺点</h3><p>优点：对于真正封装概念更清晰；支持私有数据，内部能访问私有外部不能访问。</p>
<p>缺点：</p>
<ol>
<li>因为我们采用不同的方式访问公有私有成员，因此当我们想改变这些成员可见性时，不得不在所有使用这些成员地方修改代码。</li>
<li>不能在对象之后添加的方法里面访问这些私有变量。</li>
</ol>
<h2 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h2><p>特点：全局、唯一</p>
<p>原则：单一职责</p>
<p>基本版：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> CreateSingleton = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> instance = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">      <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (instance = <span class="keyword">this</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">CreateSingleton.prototype.getName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a = <span class="keyword">new</span> CreateSingleton(<span class="string">'a'</span>);</span><br><span class="line"><span class="keyword">let</span> b = <span class="keyword">new</span> CreateSingleton(<span class="string">'b'</span>);</span><br><span class="line">a.getName(); <span class="comment">// a</span></span><br><span class="line">b.getName(); <span class="comment">// a</span></span><br></pre></td></tr></table></figure>

<p>代理版：将创建对象的操作和实例判断的操作进行解耦拆分，实现更小粒度的划分，符合单一职责原则。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只负责创建实例</span></span><br><span class="line"><span class="keyword">let</span> Singleton = <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Singleton.prototype.getName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只负责判断实例</span></span><br><span class="line"><span class="keyword">let</span> ProxyCreateSingleton = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> instance = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">      <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (instance = <span class="keyword">new</span> Singleton(name));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a = <span class="keyword">new</span> ProxyCreateSingleton(<span class="string">'a'</span>);</span><br><span class="line"><span class="keyword">let</span> b = <span class="keyword">new</span> ProxyCreateSingleton(<span class="string">'b'</span>);</span><br><span class="line">a.getName(); <span class="comment">// a</span></span><br><span class="line">b.getName(); <span class="comment">// a</span></span><br></pre></td></tr></table></figure>

<h3 id="惰性单例"><a href="#惰性单例" class="headerlink" title="惰性单例"></a>惰性单例</h3><p>页面开始加载时候我们的实例是没有进行创建的，当我们点击之后才开始，通过惰性单例按需创建实例，提高性能。</p>
<h2 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h2><p>原：</p>
<ol>
<li>一个被称作被观察者的对象，维护一组被称为观察者的对象，这些对象依赖于被观察者，被观察者自动将自身的状态的任何变化通知给他们。</li>
<li>当一个被观察者需要将一些变化通知给观察者的时候，将采用广播的方式，这条广播可能包含特定于这条通知的一些数据。</li>
<li>当特定的观察者不再需要接受来自它所注册的被观察者的通知的时候，被观察者可以将其从无所维护的组中删除。</li>
<li>包含如下组件：<ol>
<li>被观察者：维护一组观察者，提供用于增加或移除观察者的方法。</li>
<li>观察者： 提供一个更新接口，用于当被观察者状态变化时得到通知。</li>
<li>具体的被观察者：状态变化时广播通知给观察者，保持具体的观察者信息。</li>
<li>具体的观察者：保持一个指向具体被观察者的引用，实现一个更新接口，用于观察，以便保证自身状态总是和观察者状态一致的。</li>
</ol>
</li>
</ol>
<p>白：被观察者放着(订阅)观察者(数组)，也就是观察者要注册到被观察者上，然后遍历执行。。</p>
<p>创建观察者:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObserverList</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.observerList = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  add(obj) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.observerList.push(obj)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  empty()&#123;</span><br><span class="line">    <span class="keyword">this</span>.observerList = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  count() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.observerList.length;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span>(index) &#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">-1</span> &amp;&amp; index &lt; <span class="keyword">this</span>.observerList.length) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.observerList[index]<span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  insert(obj, index) &#123;</span><br><span class="line">    <span class="keyword">let</span> pointer = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.observerList.unshift(obj);</span><br><span class="line">      pointer = index;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (index === <span class="keyword">this</span>.observerList.length) &#123;</span><br><span class="line">      <span class="keyword">this</span>.observerList.push(obj);</span><br><span class="line">      pointer = index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pointer</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  indexOf(obj, startIndex) &#123;</span><br><span class="line">    <span class="keyword">let</span> i = startIndex, pointer = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; <span class="keyword">this</span>.observerList.length) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.observerList[i] === obj) &#123;</span><br><span class="line">        pointer = i;</span><br><span class="line">      &#125;</span><br><span class="line">      i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pointer;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  removeAt(index) &#123;</span><br><span class="line">    <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="keyword">this</span>.observerList.shift()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (index === <span class="keyword">this</span>.observerList.length - <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.observerList.pop()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建被观察者</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.observers = <span class="keyword">new</span> ObserverList();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addObserver(observer) &#123;</span><br><span class="line">    <span class="keyword">this</span>.observers.add(observer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  removeObserver(observer) &#123;</span><br><span class="line">    <span class="keyword">this</span>.observers.removeAt(<span class="keyword">this</span>.observers.indexOf(observer, <span class="number">0</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notify(context) &#123;</span><br><span class="line">    <span class="keyword">let</span> observerCount = <span class="keyword">this</span>.observers.count();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; observerCount; i++) &#123;</span><br><span class="line">      <span class="keyword">this</span>.observers.get(i).update(context);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>建立新的观察者的一个框架</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.update = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="观察者模式与发布订阅模式的不同"><a href="#观察者模式与发布订阅模式的不同" class="headerlink" title="观察者模式与发布订阅模式的不同"></a>观察者模式与发布订阅模式的不同</h3><p>原：</p>
<ol>
<li>观察者模式要求想要接受相关通知的观察者<strong>必须到发起这个事件的被观察者上注册这个事件</strong>。</li>
<li>发布订阅模式使用一个主题/事件频道，这个频道处于想要获取通知的订阅者和发起事件的发布者之间。这个事件系统允许代码定义应用相关的事件，这个事件可以传递特殊的参数，参数重包含有订阅着所需要的值。<strong>这种想法是为了避免订阅者和发布者之间的依赖性。</strong>这种使订阅着可以实现一个合适的事件处理函数，用于注册和接受由发布者广播的相关通知。</li>
</ol>
<p>白：发布订阅由中间商处理。</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk9m5h2kalj313w0u049e.jpg" alt></p>
<h3 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3><p>优点：</p>
<ol>
<li>鼓励人找出不同部门间的关系，同时帮助我们找出这样的层，该层中包含的直接关系，可以通过一系列的观察者和被观察者替换掉。这种方式将应用程序切割降耦。</li>
<li>当我们需要维护相关对象的一致性时，可以避免对象之间的紧密耦合。eg. 一个对象可以通知及另一个对象，而不需要知道这个对象的信息。</li>
</ol>
<p>缺点：其实都是没有强关联导致的，既是好处也是坏处。</p>
<ol>
<li>假设发布者有一个或者多个订阅着正在监听它们，基于这种假设，在某些应用处理过程中来记录或者输出错误日志，如果订阅者执行日志功能崩溃了，因为系统解耦，发布者没法感知道这些事情。。。(订阅者坏掉了，发布者感知不到。 = =那肯定啊)</li>
<li>订阅者对彼此之间存在没有感知，对切换发布者的代价无从得知，因为订阅者和发布者之间的动态关系，更新依赖也很难去追踪。</li>
</ol>
<p>EventEmitter</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  consturctor() &#123;</span><br><span class="line">    <span class="keyword">this</span>._event = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  on(type, handler) &#123;</span><br><span class="line">    (<span class="keyword">this</span>._event[type] || (<span class="keyword">this</span>._event[type] = [])).push(handler);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  off(type, handler) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._event[type]) &#123;</span><br><span class="line">      <span class="keyword">this</span>._event[type].splice(<span class="keyword">this</span>._event[type].indexOf(handler) &gt;&gt;&gt; <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  once(type, handler) &#123;</span><br><span class="line">    <span class="keyword">let</span> fired = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">magic</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.off(type, magic);</span><br><span class="line">      <span class="keyword">if</span> (fired) &#123;</span><br><span class="line">        fired = <span class="literal">true</span>;</span><br><span class="line">        handler.apply(<span class="keyword">this</span>, args);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.on(type, magic);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  emit(type) &#123;</span><br><span class="line">    <span class="keyword">let</span> payload = [].slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> array = <span class="keyword">this</span>._event[type] || [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;</span><br><span class="line">      <span class="keyword">let</span> handler = <span class="keyword">this</span>._event[type][i];</span><br><span class="line">      handler.apply(<span class="keyword">this</span>, payload);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// usage</span></span><br><span class="line"><span class="keyword">var</span> em = <span class="keyword">new</span> EventEmitter();</span><br><span class="line">em.on(<span class="string">'test'</span>, (aaa) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">123</span>, aaa);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">em.emit(<span class="string">'test'</span>, <span class="string">'dssd'</span>);</span><br></pre></td></tr></table></figure>

<h2 id="中介者模式"><a href="#中介者模式" class="headerlink" title="中介者模式"></a>中介者模式</h2><p>原：如果系统组件之间存在大量的直接关系，就可能是时候，使用一个中心的控制点，来让不同的组件通过它来通信。中介者通过将组件之间显式的直接引用替换成通过中心点来交互的方式，来做到松耦合。举个 🌰，飞行控制系统，一个航站塔(中介者)处理哪个飞机可以起飞哪个可以降落，因为所有通信(监听的通知或者广播的通知)都是飞机和控制塔之间进行的，而不是飞机与飞机之间。一个中央集权的控制中心是这个系统成功的关键。</p>
<p>白：就是上面 🌰。。。</p>
<p>从实现角度来讲，中介者模式是观察者模式中的共享被观察者对象，在这个系统中的对象之间直接的发布订阅关系被牺牲掉了，取代的是维护一个通信的中心节点。</p>
<p>也可以认为是一种补充——用于应用级别的通知，例如不同子系统之间的通信，子系统本身很复杂，可能需要使用发布订阅模式来做内部组件之间的解耦。</p>
<h3 id="基础实现"><a href="#基础实现" class="headerlink" title="基础实现"></a>基础实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mediator = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 可广播或收听的主题的存储器</span></span><br><span class="line">  <span class="keyword">var</span> topics = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 订阅主题时，提供要执行的回调</span></span><br><span class="line">  <span class="comment">// 当那个话题被广播</span></span><br><span class="line">  <span class="keyword">var</span> subscribe = <span class="function"><span class="keyword">function</span> (<span class="params">topic, fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!topics[topic]) &#123;</span><br><span class="line">      topics[topic] = [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    topics[topic].push(&#123; <span class="attr">context</span>: <span class="keyword">this</span>, <span class="attr">callback</span>: fn &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将事件发布/广播到应用程序的其余部分</span></span><br><span class="line">  <span class="keyword">var</span> publish = <span class="function"><span class="keyword">function</span> (<span class="params">topic</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!topics[topic]) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    args = <span class="built_in">Array</span>.prototypr.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = topics[topic].length; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> subscription = topics[topic][i];</span><br><span class="line">      subscription.callback.apply(subscription.context, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    publish,</span><br><span class="line">    subscribe,</span><br><span class="line">    installTo: <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">      obj.subscribe = subscribe;</span><br><span class="line">      obj.publish = publish;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h3 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h3><p>优点：</p>
<ol>
<li>节约了对象或者组件之间的通信信道，这些对象或者组件存在于从多对多到多对一的系统之中。</li>
</ol>
<p>缺点：</p>
<ol>
<li>它引入一个单点故障。在模块直击爱你防止一个中间人也可能会造成性能损失，因为它们经常是间接的进行通信的。</li>
</ol>
<h3 id="中介者-VS-观察者-？？"><a href="#中介者-VS-观察者-？？" class="headerlink" title="中介者 VS 观察者 ？？"></a>中介者 VS 观察者 ？？</h3><ol>
<li>在观察者模式中，没有封装约束的单一对象。取而代之，观察者和主题必须合作来维护约束，通信的模式决定于观察者和主题相互关联的方式：一个单独的主题经常有许多的观察者，而有时候一个主题的观察者是另一个观察者的主题。</li>
<li>中间人和观察者都提倡松耦合，然而中间人默认使用让对象严格通过中间人进行通信的方式实现松耦合。观察者模式则创造了观察者对象，这些观察者对象会发布触发对象认购的感兴趣的事件。</li>
</ol>
<h2 id="原型模式"><a href="#原型模式" class="headerlink" title="原型模式"></a>原型模式</h2><p>原：基于原型的继承中，我们创建作为其他对象原型的对象。原型对象自身被当作构造器创建的每一个对象的蓝本高效的使用着。如果构造函数使用的原型包含例如叫做 name 的属性，那么每一个通过同一个构造器创建的对象豆浆拥有这个相同的属性。</p>
<p>白：其实就是创建一个 base 原型。使用 Object.create。。。。</p>
<p>eg：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myCar = &#123;</span><br><span class="line">  name: <span class="string">'aaa'</span>,</span><br><span class="line">  dirve: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'dirve'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  panic: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'panic'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> yourCar = <span class="built_in">Object</span>.create(myCar);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(yourCar.name); <span class="comment">// 可以看见原型</span></span><br></pre></td></tr></table></figure>

<p>Object.create。。。实现思路</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">F</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">  F.prototype = obj;</span><br><span class="line">  F.prototype.constructor = F;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> F();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h2><p>原：该模式目标是将方法的调用，请求或者操作封装到一个单独的对象中，给我们酌情执行同时参数化和传递方法调用的能力。</p>
<p>白：封装完调用方法。。。lodash、underscore??</p>
<p>实现简单明智的命令对象，将一个行为和对象对调用这个行为的需求都绑定到了一起，它们始终都包含一个执行操作(run()或者 execute())，所有带有相同接口的命令对象能够被简单的根据需要调换。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> CarManager = &#123;</span><br><span class="line">    requestInfo: <span class="function"><span class="keyword">function</span> (<span class="params">model, id</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> model + id + <span class="string">''</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    buyVehicle: <span class="function"><span class="keyword">function</span> (<span class="params">model, id</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> model + id + <span class="string">''</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    arrangeViewing: <span class="function"><span class="keyword">function</span> (<span class="params">model, id</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> model + id + <span class="string">''</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这样的话，如果CarManager核心api改变了，者可能需要所有直接访问这些方法的对象也跟着被修改，这可以被看作是种耦合。咋办？</span></span><br><span class="line"><span class="comment">// 扩展一波，以便我们这个命令模式的应用程序得到这种效果：接受任何可以在CarManager对象上面执行的方法，传送任何可以被使用的数据，如Car模型和ID</span></span><br></pre></td></tr></table></figure>

<p>希望的效果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CarManager.execute = <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    CarManager[name] &amp;&amp;</span><br><span class="line">    CarManager[name].apply(CarManager, [].slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>))</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>最终调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CarManager.execute(<span class="string">'arrangeViewing'</span>, <span class="string">'Ferrari'</span>, <span class="string">'14523'</span>);</span><br><span class="line">CarManager.execute(<span class="string">'requestInfo'</span>, <span class="string">'Ford Mondeo'</span>, <span class="string">'54323'</span>);</span><br><span class="line">CarManager.execute(<span class="string">'requestInfo'</span>, <span class="string">'Ford Escort'</span>, <span class="string">'34232'</span>);</span><br><span class="line">CarManager.execute(<span class="string">'buyVehicle'</span>, <span class="string">'Ford Escort'</span>, <span class="string">'34232'</span>);</span><br></pre></td></tr></table></figure>

<p>更像是对已有对象，封装了添加外部执行的方法。</p>
<h2 id="外观模式"><a href="#外观模式" class="headerlink" title="外观模式"></a>外观模式</h2><p>原：该模式提供了面向一种更大型的代码体提供了一个更高级别的舒适的接口，隐藏了其真正的潜在复杂性。把这一模式想象成要是呈现给开发者简化的 API。，一些总是会提升使用性能的东西。</p>
<p>白：内部消化逻辑代码，提供给开发者更简单的 API，其实就是封装复杂逻辑块，按逻辑分层搞代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">module</span> = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _private = &#123;</span><br><span class="line">    i: <span class="number">5</span>,</span><br><span class="line">    <span class="keyword">get</span>: function () &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.i);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span>: function (val) &#123;</span><br><span class="line">      <span class="keyword">this</span>.i = val;</span><br><span class="line">    &#125;,</span><br><span class="line">    run: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'running'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    jump: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'jumping'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    facade: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">      _private.set(args.val);</span><br><span class="line">      _private.get();</span><br><span class="line">      <span class="keyword">if</span> (args.run) &#123;</span><br><span class="line">        _private.run();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.facade(&#123; <span class="attr">run</span>: <span class="literal">true</span>, <span class="attr">val</span>: <span class="number">10</span> &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="工厂模式"><a href="#工厂模式" class="headerlink" title="工厂模式"></a>工厂模式</h2><p>原：一种关注对象创建概念的创建模式。不同之处在于它没有明确要求我们使用一个构造器。取而代之，一个工厂能提供一个创建对象的公共接口，我们可以在其中指定我们希望被创建的工厂对象的类型。</p>
<p>白：创建基础类，之后按照这个类来建东西。</p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ol>
<li>当我们的对象或者组件设置涉及到高程度级别的复杂度时。</li>
<li>当我们需要根据我们所在的环境方便的生成不同对象的实体时。</li>
<li>当我们在许多共享同一个属性的许多小型对象或组件上工作时。</li>
<li>当带有其他仅仅需要满足一种 API 约定的对象的组合对象工作时。 ？？</li>
</ol>
<h3 id="抽象工厂"><a href="#抽象工厂" class="headerlink" title="抽象工厂"></a>抽象工厂</h3><ol>
<li>目标是以一个通用的目标将一组独立的工厂进行封装。它将一对对象的实现细节从它们的一般实例中分离。</li>
<li>一般用于在一种必须从其创建或生产对象的方式处独立，或者需要同多种类型的对象一起工作。</li>
</ol>
<p>🌰：一个发动机工厂,它定义了获取或者注册发动机类型的方式.抽象工厂会被命名为 AbstractVehicleFactory.抽象工厂将允许像”car”或者”truck”的发动机类型的定义,并且构造工厂将仅实现满足发动机合同的类.(例如:Vehicle.prototype.driven 和 Vehicle.prototype.breakDown)。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> AbstractVehicleFactory = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> types = &#123;&#125;;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    getVehicle: <span class="function"><span class="keyword">function</span> (<span class="params">type, customizations</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> Vehicle = types[type];</span><br><span class="line">      <span class="keyword">return</span> Vehicle ? <span class="keyword">new</span> Vehicle(customizations) : <span class="literal">null</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    registerVehicle: <span class="function"><span class="keyword">function</span> (<span class="params">type, Vehicle</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> proto = Vehicle.prototype;</span><br><span class="line">      <span class="keyword">if</span> (proto.drive &amp;&amp; proto.breakDown) &#123;</span><br><span class="line">        types[type] = Vehicle;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> AbstractVehicleFactory;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">// usage</span></span><br><span class="line">AbstractVehicleFactory.registerVehicle(<span class="string">'car'</span>, Car);</span><br><span class="line">AbstractVehicleFactory.registerVehicle(<span class="string">'truck'</span>, Truck);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> car = AbstractVehicleFactory.getVehicle(<span class="string">'car'</span>, &#123;</span><br><span class="line">  color: <span class="string">'lime grern'</span>,</span><br><span class="line">  state: <span class="string">'link new'</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> truck = AbstractVehicleFactory.getVehicle(<span class="string">'truck'</span>, &#123;</span><br><span class="line">  wheelSize: <span class="string">'lime grern'</span>,</span><br><span class="line">  color: <span class="string">'link new'</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="Mixin-模式"><a href="#Mixin-模式" class="headerlink" title="Mixin 模式"></a>Mixin 模式</h2><p>原：提供能被一个或者一组子类简单继承功能的类，意在重用功能。</p>
<p>白：继承。。。原型链拓展。。。类比早期 react 的 mixin，vue 的 mixins。。。</p>
<h3 id="优缺点-2"><a href="#优缺点-2" class="headerlink" title="优缺点"></a>优缺点</h3><p>优点：在一个系统中降解功能的重复性，增加功能的重用性。</p>
<p>缺点：将功能注入对象原型会造成原型污染，造成一定程度上的原油功能的不确定性。</p>
<h2 id="装饰器模式"><a href="#装饰器模式" class="headerlink" title="装饰器模式"></a>装饰器模式</h2><p>原：提供了向一个系统中现有的类动态添加行为的能力，不关心类的基础功能，只是将它自身拷贝到超类之中。</p>
<p>白：手机与手机壳的关系。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多个装饰器的装饰对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MacBook</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.cost = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">this</span>.screenSize = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">15</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重写里面的方法</span></span><br><span class="line"><span class="comment">// 装饰器1</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Memory</span>(<span class="params">macbook</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> v = macbook.cost();</span><br><span class="line">  macbook.cost = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v + <span class="number">75</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 装饰器2</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Engraving</span>(<span class="params">macbook</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> v = macbook.cost();</span><br><span class="line">  macbook.cost = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v + <span class="number">200</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 装饰器3</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Insurance</span>(<span class="params">macbook</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> v = macbook.cost();</span><br><span class="line">  macbook.cost = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v + <span class="number">250</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> mb = <span class="keyword">new</span> MacBook();</span><br><span class="line">Memory(mb);</span><br><span class="line">Engraving(mb);</span><br><span class="line">Insurance(mb);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(mb.cost()); <span class="comment">// 100 + 75 + 200 + 250</span></span><br><span class="line"><span class="built_in">console</span>.log(mb.screenSize()); <span class="comment">// 15</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 装饰类</span></span><br><span class="line">@testDec</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testDec</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  target.isDec = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(Demo.isDec); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 装饰器原理</span></span><br><span class="line">@decorator</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;&#125;</span><br><span class="line">A = decorator(A) || A;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以传参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testDec</span>(<span class="params">isDec</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">target</span>) </span>&#123;</span><br><span class="line">    target.isDec = isDec;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// usage</span></span><br><span class="line">@testDec(tue)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Demo.isDec); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>主要使用装饰类和装饰方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 装饰类</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mixins</span>(<span class="params">...list</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">target</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.assgin(target.prototype, ...list);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Foo = &#123;</span><br><span class="line">  foo() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'foo'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">@mixins(Foo)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;&#125;</span><br><span class="line"><span class="keyword">const</span> myClass = <span class="keyword">new</span> MyClass();</span><br><span class="line">myClass.foo(); <span class="comment">// 'foo'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 装饰方法</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readonly</span>(<span class="params">target, name, descriptor</span>) </span>&#123;</span><br><span class="line">  descriptor.writable = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> descriptor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.first = <span class="string">'A'</span>;</span><br><span class="line">    <span class="keyword">this</span>.last = <span class="string">'B'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @readonly</span><br><span class="line">  name() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.first&#125;</span> <span class="subst">$&#123;<span class="keyword">this</span>.last&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> Person();</span><br><span class="line"><span class="built_in">console</span>.log(p.name()); <span class="comment">// name只读，会报错</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印日志</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">target, name, descriptor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> oldValue = descriptor.value;</span><br><span class="line"></span><br><span class="line">  descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;name&#125;</span>`</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    <span class="keyword">return</span> oldValue.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> descriptor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Math</span> </span>&#123;</span><br><span class="line">  @log</span><br><span class="line">  add(a, b) &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> math = <span class="keyword">new</span> <span class="built_in">Math</span>();</span><br><span class="line"><span class="keyword">const</span> result = math.add(<span class="number">2</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<h3 id="优缺点-3"><a href="#优缺点-3" class="headerlink" title="优缺点"></a>优缺点</h3><p>好多设计模式是优点同时也是缺点。。。</p>
<p>优点：对象可以用新的行为装饰从而继续使用，并不用担心基础对象被改变。</p>
<p>缺点：使应用程序变得复杂更难管理</p>
<h2 id="适配器模式"><a href="#适配器模式" class="headerlink" title="适配器模式"></a>适配器模式</h2><p>原：将一个对象或者类的接口翻译成某个指定的系统可以使用另外一个接口。</p>
<p>白：iphone 港版充电器与国行充电器，转接口。</p>
<h2 id="享元模式"><a href="#享元模式" class="headerlink" title="享元模式"></a>享元模式</h2><p>原：是一个优化重复、缓慢和低效数据共享代码的经典结构化解决方案。目标 hi 以相关对象尽可能多的共享数据，来减少应用程序中内存的使用。</p>
<p>白：为减少对象创建的个数。</p>
<p>当有大量对象时，有可能会造成内存溢出，我们将其中共同的部分抽象出来，如果有相同的业务请求，直接返回在内存中已有的对象，避免重新创建。</p>
<h3 id="优缺点-4"><a href="#优缺点-4" class="headerlink" title="优缺点"></a>优缺点</h3><p>优点：大大减少对象的创建，降低系统的内存，使效率提高</p>
<p>缺点：提高系统复杂度，需要分离出外部状态和内部状态，而且外部状态具有固有化性质，不应该随着内部状态变化而变化，否则会造成系统的混乱。</p>
<h2 id="MVC-模式"><a href="#MVC-模式" class="headerlink" title="MVC 模式"></a>MVC 模式</h2><p>原：一种架构设计模式，通过分离关注点的方式来改进应用组织方式。它促成了业务数据(Models)从用户界面(Views)中分离出来，还有第三个组成部分(Controllers)负责管理传统意义上的业务逻辑和用户输入。</p>
<p>白：Models 处理数据，Views 展示 UI，Controllers 搞搞逻辑。。。其实就是切分思想。</p>
<h3 id="对比-MVP"><a href="#对比-MVP" class="headerlink" title="对比 MVP"></a>对比 MVP</h3><p>P 代表展示器，在 MVP 中，P 观察着模型并且当模型发生改变的时候对视图进行更新，P 切实的将模型绑定到了视图，这一责任在 MVC 中被 Controller 提前持有了。</p>
<p>相较于 MVC 的好处是，增强了应用的可测试性，并提供了一个更加干净的视图和模型之间的隔离。</p>
<p>但是伴随着缺乏数据绑定支持的缺陷，意味着必须对这个任务做另外的处理。</p>
<h2 id="对比-MVVM"><a href="#对比-MVVM" class="headerlink" title="对比 MVVM"></a>对比 MVVM</h2><p>数据驱动，数据与页面绑定。。。类比 Vue</p>
<h2 id="组合模式"><a href="#组合模式" class="headerlink" title="组合模式"></a>组合模式</h2><p>原：描一组对象可像单个对象一样对待，这允许我们能统一的处理单个对象或多个对象，这意味着无论是一个对象还是一千个对象我们都能以通用行为处理。</p>
<p>白：就是封装一组行为。。。封装。📦</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单一节点</span></span><br><span class="line">$(<span class="string">'#a'</span>).addClass(<span class="string">'active'</span>);</span><br><span class="line">$(<span class="string">'#b'</span>).addClass(<span class="string">'active'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//一组节点</span></span><br><span class="line">$(<span class="string">'div'</span>).addClass(<span class="string">'active'</span>);</span><br><span class="line">$(<span class="string">'.item'</span>).addClass(<span class="string">'active'</span>);</span><br><span class="line">$(<span class="string">'input'</span>).addClass(<span class="string">'active'</span>);</span><br></pre></td></tr></table></figure>

<p>jQ 的 addClass</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单个多个一样的处理，多个要循环遍历</span></span><br><span class="line">addClass: <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> classNames, i, l, elem, setClass, c, cl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (jQuery.isFunction(value)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">j</span>) </span>&#123;</span><br><span class="line">      jQuery(<span class="keyword">this</span>).addClass(value.call(<span class="keyword">this</span>, j, <span class="keyword">this</span>.className));</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (value &amp;&amp; <span class="keyword">typeof</span> value === <span class="string">'string'</span>) &#123;</span><br><span class="line">    classNames = value.split(rspace);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>, l = <span class="keyword">this</span>.length; i &lt; l; i++ ) &#123;</span><br><span class="line">      elem = <span class="keyword">this</span>[ i ];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ( elem.nodeType === <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !elem.className &amp;&amp; classNames.length === <span class="number">1</span> ) &#123;</span><br><span class="line">          elem.className = value;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          setClass = <span class="string">" "</span> + elem.className + <span class="string">" "</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> ( c = <span class="number">0</span>, cl = classNames.length; c &lt; cl; c++ ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( !~setClass.indexOf( <span class="string">" "</span> + classNames[ c ] + <span class="string">" "</span> ) ) &#123;</span><br><span class="line">              setClass += classNames[ c ] + <span class="string">" "</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          elem.className = jQuery.trim( setClass );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="迭代器模式"><a href="#迭代器模式" class="headerlink" title="迭代器模式"></a>迭代器模式</h2><p>原：提供一种方法顺序访问一个容器对象中的各个元素，而不需要暴露该对象的内部表示。</p>
<p>白：对象内部实现指针指向。。。[Symbol.iterator]</p>
<h2 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h2><p>当一个逻辑中，存在很多 if else 或者 switch，并且它们解决的问题是一样的，就可以使用。</p>
<p>白：把条件语句的表现形式通过对象键值对展现。</p>
<h2 id="责任链模式"><a href="#责任链模式" class="headerlink" title="责任链模式"></a>责任链模式</h2><p>原：很多对象由每一个对象对其下家引用而连接起来形成一条链，请求在这条链上传递，直到链上的某一个对象决定处理此请求。发出这个请求的客户端并不知道链上的哪一个对象最终处理这个请求，这使得系统可以在不影响客户端的情况下动态地重新组织和分配责任。</p>
<p>白：if else else if…</p>
<h2 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h2><p>原：代理以一种中间人的角色，帮我们处理我们无能为力的事情。</p>
<p>当我们遇到以下场景：</p>
<ul>
<li>无法直接访问某个对象</li>
<li>不想直接访问某个对象</li>
<li>访问某个对象存在困难</li>
</ul>
<p>就需要使用代理模式</p>
<p>白：代理处理我们的委托，去请求对象的结果</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2020/10/14/设计模式/" data-id="ckonxihv0000mttyzsi5fdfdt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/前端-设计模式/">前端 设计模式</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-关于npm" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/07/14/关于npm/" class="article-date">
  <time datetime="2020-07-14T15:04:14.000Z" itemprop="datePublished">2020-07-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/07/14/关于npm/">前端路线</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>工程化</p>
<h2 id="编辑器设置"><a href="#编辑器设置" class="headerlink" title="编辑器设置"></a>编辑器设置</h2><h3 id="Vscode-常用插件"><a href="#Vscode-常用插件" class="headerlink" title="Vscode 常用插件"></a>Vscode 常用插件</h3><ul>
<li><p>Git History</p>
</li>
<li><p>GitLens</p>
</li>
<li><p>Path Intellisense</p>
</li>
<li><p>Auto Close Tag</p>
</li>
<li><p>Auto Rename Tag</p>
</li>
<li><p>Color Highlight</p>
</li>
<li><p>VSCode Highlight Matching Tag</p>
</li>
<li><p>HTML CSS Support</p>
</li>
<li><p>Vetur</p>
</li>
<li><p>ES7 React/Redux/GraphQL/React-Native snippets</p>
</li>
<li><p>npm</p>
</li>
<li><p>npm Intellisense</p>
</li>
<li><p>Prettier - Code formatter</p>
</li>
<li><p>Live Server</p>
</li>
</ul>
<h2 id="Vscode-快捷键"><a href="#Vscode-快捷键" class="headerlink" title="Vscode 快捷键"></a>Vscode 快捷键</h2><ul>
<li><p>快捷键列表查看 <code>cmd + k</code> &amp; <code>cmd + s</code></p>
</li>
<li><p>快速打开文件 <code>cmd + p</code></p>
</li>
<li><p>编辑器命令<code>cmd + p</code> &amp; 输入 <code>&gt;</code></p>
</li>
<li><p>快速打开和关闭侧边栏 <code>cmd + b</code></p>
</li>
<li><p>快速打开集成终端 <code>control</code> + <em>`</em></p>
</li>
<li><p>代码格式化 <code>shift + option + f</code> || <code>cmd + k &amp; cmd + f</code></p>
</li>
<li><p>清除多余空格 <code>cmd + k &amp; cmd + x</code></p>
</li>
<li><p>折叠代码 <code>cmd + k &amp; cmd + (0|1|2|3|4)</code> 伸展代码 <code>cmd + k &amp; cmd + j</code></p>
</li>
<li><p>往上/下复制行 <code>shift + option + 上/下箭头</code></p>
</li>
<li><p>选择单词 局部选中<code>cmd + d</code> 全部选中<code>cmd + shift + l</code></p>
</li>
<li><p>文件中跳转符号 <code>cmd + p</code>之后输入<code>@</code></p>
</li>
<li><p>快速复制当前行 <code>cmd + shift + d</code></p>
</li>
<li><p>删除当前行 <code>cmd + x</code></p>
</li>
<li><p>往上/下同时编辑 <code>cmd + option + 上/下箭头</code></p>
</li>
</ul>
<h2 id="prettier"><a href="#prettier" class="headerlink" title="prettier"></a>prettier</h2><ol>
<li><p>编辑器中安装 prettier 插件</p>
</li>
<li><p>项目中安装 prettier</p>
</li>
<li><p><code>shift + cmd + p</code>打开用户首选项，用户区全局设置，工作区当前项目设置，添加 prettier 规则之后，格式化文档方式可选择 prettier，就以 prettier 的规则去格式化代码。项目中使用 prettier，需要进行代码格式化，需要下载 prettier 到开发环境，添加 script 命令 <code>&quot;prettier&quot;: &quot;prettier -c --write &#39;**/*.{js,jsx,tsx,ts,less,md,json}&#39;&quot;,</code>,项目中添加.prettierrc 自定义规则，添加.prettierignore 进行无需格式化代码文件配置。<img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk475fk5bcj311a0u01kx.jpg" alt="编辑器"></p>
</li>
</ol>
<h2 id="githooks"><a href="#githooks" class="headerlink" title="githooks"></a>githooks</h2><p>安装<code>husky</code> <code>lint-staged</code></p>
<p><code>package.json</code>添加如下配置，提交代码前进行 lint-staged 下的一系列流程，代码格式化之后进行 eslint 检测。</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gk47c7c6uqj311u0jqgo2.jpg" alt="package.json"></p>
<h2 id="npm"><a href="#npm" class="headerlink" title="npm"></a>npm</h2><h3 id="semver-语义化版本"><a href="#semver-语义化版本" class="headerlink" title="semver(语义化版本)"></a>semver(语义化版本)</h3><p>约定一个包的版本必须包含 3 个数字，格式必须是<code>MAJOR.MINOR.PATCH</code>(主版本.小版本.修订版本号)</p>
<ul>
<li>MAJOR 对应大版本迭代，做了不兼容旧版的修改时要更新此版本号</li>
<li>MINOR 对应小版本迭代，发生兼容旧版 API 的修改或功能更新时，更新 MINOR 版本号</li>
<li>PATCH 对应修订版本号，一般针对修复 BUG 的版本号</li>
</ul>
<table>
<thead>
<tr>
<th>range</th>
<th>含义</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td>^2.2.1</td>
<td>制定 MAJOR 版本号下所有更新的版本</td>
<td>匹配 2.2.3、2.3.0，不匹配 1.0.3、3.0.1</td>
</tr>
<tr>
<td>~2.2.1</td>
<td>制定 MAJOR.MINOR 版本号下所有更新的版本</td>
<td>匹配 2.2.3、2.2.9，不匹配 2.3.0、2.4.5</td>
</tr>
<tr>
<td>&gt;=2.1</td>
<td>版本号大于等于 2.1.0</td>
<td>匹配 2.1.2、3.1</td>
</tr>
<tr>
<td>&lt;=2.2</td>
<td>版本号小于等于 2.2.0</td>
<td>匹配 1.0.0、2.2.1、2.2.11</td>
</tr>
<tr>
<td>1.0.0-2.0.0</td>
<td>版本号从 1.0.0-2.0.0、包含各自</td>
<td>匹配 1.0.0、1.3.4、2.0.0</td>
</tr>
</tbody></table>
<p>两版本号可用空格(与)或者<code>||</code>(或)。</p>
<p>另外几种写法:</p>
<ul>
<li><code>*</code>或<code>x</code>匹配所有的主版本</li>
<li><code>1</code>或<code>1.x</code>匹配主版本号为 1 的所有版本</li>
<li><code>1.2</code>或<code>1.2.x</code>匹配版本号为 1.2 开头的所有版本</li>
<li>M.M.P 后面加<code>-</code>被视为不稳定、不建议生产使用的版本</li>
</ul>
<h3 id="scripts"><a href="#scripts" class="headerlink" title="scripts"></a>scripts</h3><p><code>npm run</code>运行时变量：在<code>npm run</code>的脚本执行环境内，可以通过环境变量方式获取许多运行时相关信息。以下都可以通过<code>process.env</code>对象访问获得</p>
<ul>
<li><code>npm_lifecycle_enent</code>:正在运行的脚本名称</li>
<li><code>npm_package_&lt;key&gt;</code>:获取当前包 package.json 中某个字段的配置值:如<code>npm_package_name</code>获取包名</li>
<li><code>npm_package_&lt;key&gt;_&lt;sub-key&gt;</code>: package.json 中嵌套字段属性：如<code>npm_package_dependencied_webpack</code>可以获取到 package.json 中的<code>dependencies.webpack</code>字段的值，即为 webpack 版本号</li>
</ul>
<h2 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h2><h3 id="version"><a href="#version" class="headerlink" title="version"></a>version</h3><p>遵循 server 规范，</p>
<p><code>npm view &lt;packageName&gt; version</code>查看某个模块的最新版本</p>
<p><code>npm view &lt;packageName&gt; versions</code>查看某个模块的所有历史版本</p>
<h3 id="descripting-amp-keywords"><a href="#descripting-amp-keywords" class="headerlink" title="descripting &amp; keywords"></a>descripting &amp; keywords</h3><p>相当于 npm 上的 seo</p>
<h3 id="dependencies-amp-devDependencies"><a href="#dependencies-amp-devDependencies" class="headerlink" title="dependencies &amp; devDependencies"></a>dependencies &amp; devDependencies</h3><ul>
<li>dependencies 生产环境依赖</li>
<li>devDependencies 开发环境依赖</li>
</ul>
<h3 id="scripts-1"><a href="#scripts-1" class="headerlink" title="scripts"></a>scripts</h3><p>使用<code>npm run xxx</code>去执行里面的脚本</p>
<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><p>项目入口，不指定时默认根目录下<code>index.js</code>，发 npm 包会用到</p>
<h3 id="files"><a href="#files" class="headerlink" title="files"></a>files</h3><p>用于描述我们使用<code>npm publish</code>命令后推送到<code>npm</code>服务器的文件列表，如果指定文件夹，则文件夹内所有内容都会包含进来。eg. <code>files: [&#39;dist&#39;, &#39;lib&#39;, &#39;es&#39;]</code></p>
<h3 id="private"><a href="#private" class="headerlink" title="private"></a>private</h3><p>一般公司非开源项目，都会设置该值为<code>true</code>，因为<code>npm</code>拒绝发私有模块，通过设置该值可以防止私有模块被无意间发布出去。`</p>
<h3 id="engines"><a href="#engines" class="headerlink" title="engines"></a>engines</h3><p>针对 node 版本不同可能会导致的问题。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"engines": &#123;</span><br><span class="line">   "node": "&gt;= 8.16.0"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>也可以指定适用的<code>npm</code>版本</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"engines": &#123;</span><br><span class="line">   "npm": "&gt;= 6.9.0"</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="bin"><a href="#bin" class="headerlink" title="bin"></a>bin</h3><p>自定义命令</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"bin": &#123;</span><br><span class="line">  "my-app-cli": "./bin/cli.js"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上代码指定<code>my-app-cli</code>命令执行<code>bin</code>下的<code>cli.js</code>文件。</p>
<p>自定义实现时，需要在<code>cli.js</code>第一行写入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env node</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2020/07/14/关于npm/" data-id="ckonxihur0008ttyz6iv4il6o" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/前端-工程化-npm/">前端 工程化 npm</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><a class="extend next" rel="next" href="/blog/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Chrome/">Chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/React/">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/qiankun-微前端-umi/">qiankun 微前端 umi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/vscode-eslint-prettier/">vscode eslint prettier</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/webpack/">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/上卷-this-原型对象/">上卷 this 原型对象</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/上卷-作用域和闭包/">上卷 作用域和闭包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/上卷-对象/">上卷 对象</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/中卷-异步与性能/">中卷 异步与性能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/中卷-类型-值/">中卷 类型 值</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/你不知道的JavaScript/">你不知道的JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/前端-工程化-npm/">前端 工程化 npm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/前端-设计模式/">前端 设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/单点登录-SSO/">单点登录 SSO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/序/">序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/测试/">测试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/blog/tags/Java/" style="font-size: 20px;">Java</a> <a href="/blog/tags/React/" style="font-size: 10px;">React</a> <a href="/blog/tags/qiankun-微前端-umi/" style="font-size: 10px;">qiankun 微前端 umi</a> <a href="/blog/tags/vscode-eslint-prettier/" style="font-size: 10px;">vscode eslint prettier</a> <a href="/blog/tags/webpack/" style="font-size: 10px;">webpack</a> <a href="/blog/tags/上卷-this-原型对象/" style="font-size: 10px;">上卷 this 原型对象</a> <a href="/blog/tags/上卷-作用域和闭包/" style="font-size: 10px;">上卷 作用域和闭包</a> <a href="/blog/tags/上卷-对象/" style="font-size: 10px;">上卷 对象</a> <a href="/blog/tags/中卷-异步与性能/" style="font-size: 10px;">中卷 异步与性能</a> <a href="/blog/tags/中卷-类型-值/" style="font-size: 10px;">中卷 类型 值</a> <a href="/blog/tags/你不知道的JavaScript/" style="font-size: 10px;">你不知道的JavaScript</a> <a href="/blog/tags/前端-工程化-npm/" style="font-size: 10px;">前端 工程化 npm</a> <a href="/blog/tags/前端-设计模式/" style="font-size: 10px;">前端 设计模式</a> <a href="/blog/tags/单点登录-SSO/" style="font-size: 10px;">单点登录 SSO</a> <a href="/blog/tags/序/" style="font-size: 10px;">序</a> <a href="/blog/tags/测试/" style="font-size: 10px;">测试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/07/">July 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2021/03/26/测试相关/">测试相关</a>
          </li>
        
          <li>
            <a href="/blog/2021/03/24/headless-chrome/">headless chrome</a>
          </li>
        
          <li>
            <a href="/blog/2021/03/24/java高级/">Java高级</a>
          </li>
        
          <li>
            <a href="/blog/2021/02/03/SSO实践/">SSO实践</a>
          </li>
        
          <li>
            <a href="/blog/2021/02/03/微前端实践/">微前端实践</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 WangQinyong<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>



  </div>
</body>
</html>