<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>webpack相关 | 王秦勇的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="打包webpackgithub webpack 中文官网 英文官网  大模块 entry output loader plugins    entry单入口语法： entry: string | string[] 对象语法：entry: { [entryChunkName: string]: string | string[] } 常见场景： 分离应用程序 app 与第三方库 vender 123">
<meta name="keywords" content="webpack">
<meta property="og:type" content="article">
<meta property="og:title" content="webpack相关">
<meta property="og:url" content="https://github.com/wangqinyong1994/blog/2019/09/07/webpack相关/index.html">
<meta property="og:site_name" content="王秦勇的博客">
<meta property="og:description" content="打包webpackgithub webpack 中文官网 英文官网  大模块 entry output loader plugins    entry单入口语法： entry: string | string[] 对象语法：entry: { [entryChunkName: string]: string | string[] } 常见场景： 分离应用程序 app 与第三方库 vender 123">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gkfth961gsj31120g2jvk.jpg">
<meta property="og:updated_time" content="2021-01-23T08:55:05.562Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="webpack相关">
<meta name="twitter:description" content="打包webpackgithub webpack 中文官网 英文官网  大模块 entry output loader plugins    entry单入口语法： entry: string | string[] 对象语法：entry: { [entryChunkName: string]: string | string[] } 常见场景： 分离应用程序 app 与第三方库 vender 123">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gkfth961gsj31120g2jvk.jpg">
  
    <link rel="alternate" href="/blog/atom.xml" title="王秦勇的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blog/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">王秦勇的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/blog/" id="subtitle">记录一下</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/wangqinyong1994/blog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-webpack相关" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2019/09/07/webpack相关/" class="article-date">
  <time datetime="2019-09-06T16:05:48.000Z" itemprop="datePublished">2019-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      webpack相关
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h1><h2 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h2><p><a href="https://github.com/webpack/webpack">github webpack</a></p>
<p><a href="https://www.webpackjs.com/" target="_blank" rel="noopener">中文官网</a></p>
<p><a href="https://webpack.js.org/" target="_blank" rel="noopener">英文官网</a></p>
<ol>
<li>大模块<ul>
<li>entry</li>
<li>output</li>
<li>loader</li>
<li>plugins</li>
</ul>
</li>
</ol>
<h3 id="entry"><a href="#entry" class="headerlink" title="entry"></a>entry</h3><p>单入口语法： <code>entry: string | string[]</code></p>
<p>对象语法：<code>entry: { [entryChunkName: string]: string | string[] }</code></p>
<p>常见场景：</p>
<p>分离应用程序 app 与第三方库 vender</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    app: <span class="string">'./src/app.js'</span>,</span><br><span class="line">    vendors: <span class="string">'./src/vendors.js'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该配置比较常见于只有一个入口起点的SPA</span></span><br><span class="line"><span class="comment">// 如果应用程序bundle中没有vendor，那么你可以在webpack中实现长缓存。</span></span><br></pre></td></tr></table></figure>

<p><a href="https://www.webpackjs.com/guides/caching/" target="_blank" rel="noopener">缓存</a></p>
<p>mpa</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    p1: <span class="string">'./src/p1/index.js'</span>,</span><br><span class="line">    p2: <span class="string">'./src/p2/index.js'</span>,</span><br><span class="line">    p3: <span class="string">'./src/p3/index.js'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="output"><a href="#output" class="headerlink" title="output"></a>output</h3><p><strong>即使多入口，也只指定一个输出</strong></p>
<ul>
<li>filename: 输出文件文件名</li>
<li>path: 输出路径</li>
</ul>
<p>多入口起点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    app: <span class="string">'./src/app.js'</span>,</span><br><span class="line">    search: <span class="string">'./src/search.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">'[name].js'</span>,</span><br><span class="line">    path: __dirname + <span class="string">'/dist'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cdn + 资源 hash</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.js</span></span><br><span class="line">output: &#123;</span><br><span class="line">  path: <span class="string">'/xx/xx/assets/[hash]'</span>,</span><br><span class="line">  publicPath: <span class="string">'https://cdn.xxx.com/assets/[hash]/'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//编译时不知道最终输出文件的publicPath时，publicPath可以留空，并且在入口起点文件运行时动态设置。可在入口起点设置__webpack_public_path__</span></span><br><span class="line"></span><br><span class="line">__webpack_public_path__ = runtimePublicPath</span><br><span class="line"></span><br><span class="line"><span class="comment">// __webpack_对象_键__</span></span><br></pre></td></tr></table></figure>

<h3 id="mode"><a href="#mode" class="headerlink" title="mode"></a>mode</h3><p>Webpack4.x 以上，指定<code>mode</code> development/production</p>
<h3 id="loader"><a href="#loader" class="headerlink" title="loader"></a>loader</h3><p>3 中使用 loader 方式</p>
<ul>
<li>webpack.config.js 里配置</li>
<li>每个 import 语句中显示指定</li>
<li>shell 里指定</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">      use: [</span><br><span class="line">        &#123;</span><br><span class="line">          loader: <span class="string">'style-loader'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          loader: <span class="string">'css-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            modules: <span class="literal">true</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 内联</span></span><br><span class="line"><span class="keyword">import</span> Styles <span class="keyword">from</span> <span class="string">'style-loader!css-loader?modules!./styles.css'</span>;</span><br></pre></td></tr></table></figure>

<p>cli</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webpack --module-bind jade-loader --module-bind 'css=style-loader!css-loader'</span><br></pre></td></tr></table></figure>

<h4 id="loader-特性"><a href="#loader-特性" class="headerlink" title="loader 特性"></a>loader 特性</h4><ul>
<li><p>链式传递、配置处、由后往前、由下往上。</p>
</li>
<li><p>同步或异步</p>
</li>
<li><p>运行在 nodejs 中</p>
</li>
<li><p>可接受查询参数，用于 loader 传递配置</p>
</li>
<li><p>可使用 options 对象配置</p>
</li>
<li><p>可以将普通 npm 块导出为 loader，做法在 package.json 里定义一个 loader</p>
</li>
<li><p>plugin 可以配合 loader</p>
</li>
<li><p>loader 可产生额外的任意文件</p>
</li>
</ul>
<h4 id="loader-原理"><a href="#loader-原理" class="headerlink" title="loader 原理"></a>loader 原理</h4><p>导出函数，函数里返回字符串。。。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file-loader</span></span><br><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loader</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> filename = loaderUtils.interpolateName(<span class="keyword">this</span>, <span class="string">`[hash].[ext]`</span>, &#123;</span><br><span class="line">    content: source,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">this</span>.emitFile(filename, source);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`module.exports="<span class="subst">$&#123;filename&#125;</span>"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">loader.raw = <span class="literal">true</span>;</span><br><span class="line"><span class="built_in">module</span>.exports = loader;</span><br><span class="line"></span><br><span class="line"><span class="comment">// url-loader</span></span><br><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="keyword">const</span> mime = <span class="built_in">require</span>(<span class="string">'mime'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loader</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; limit &#125; = loaderUtils.getOptions(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> (limit &amp;&amp; limit &gt; source.length) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`module.exports = "data:<span class="subst">$&#123;mime.getType(</span></span></span><br><span class="line"><span class="string"><span class="subst">      <span class="keyword">this</span>.resourcePath</span></span></span><br><span class="line"><span class="string"><span class="subst">    )&#125;</span>;base64,<span class="subst">$&#123;source.toString(<span class="string">'base64'</span>)&#125;</span>"`</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'./file-loader'</span>).call(<span class="keyword">this</span>, source);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">loader.raw = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = loader;</span><br></pre></td></tr></table></figure>

<h4 id="loader-相关-api"><a href="#loader-相关-api" class="headerlink" title="loader 相关 api"></a>loader 相关 api</h4><ol>
<li><p>缓存 webpack 来提高编译效率 this.cacheable(); this.cacheable 原理？？</p>
</li>
<li><p>异步：当一个 loader 无依赖可异步的时候，不阻塞去执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">  asyncAction(content, <span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);</span><br><span class="line">    callback(<span class="literal">null</span>, result);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// this.async原理？？</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>传入源文件以 buffer 形式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports.raw = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取 loader 的 options</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = loaderUtils.getOptions(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">return</span> source;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>校验传入 options 是否符合要求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="keyword">const</span> validate = <span class="built_in">require</span>(<span class="string">'schema-utils'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> json = &#123;</span><br><span class="line">  type: <span class="string">'object'</span>,</span><br><span class="line">  properties: &#123;</span><br><span class="line">    content: &#123;</span><br><span class="line">      type: <span class="string">'string'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = loaderUtils.getOptions(<span class="keyword">this</span>);</span><br><span class="line">  validate(json, options, <span class="string">'xxx-loader'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 不满足schema报错</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>loader 返回其他结果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// this.callback告诉webpack返回的结果</span></span><br><span class="line">  <span class="keyword">this</span>.callback(<span class="literal">null</span>, source, sourceMaps);</span><br><span class="line">  <span class="comment">// 当使用this.callback返回内容时，该loader必须返回undefind，以让webpack知道该loader返回结果在this.callback中，而不是在return中</span></span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>同步与异步</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据实际情况去识别使用同步还是异步</span></span><br><span class="line"><span class="comment">// 异步demo</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">  asyncAction(source, <span class="function"><span class="keyword">function</span> (<span class="params">err, result, sourceMaps, ast</span>) </span>&#123;</span><br><span class="line">    callback(err, result, sourceMaps, ast);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>其他</p>
<ul>
<li>this.context 当前处理文件的所在目录</li>
<li>this.resource 当前处理文件的完整请求路径，包括 querystring</li>
<li>this.resourcePath 当前处理文件的路径</li>
<li>this.resourceQuery 当前处理文件的 querystring</li>
<li>this.target 等于 webpack 中 Target</li>
<li>this.loadModule(request: string, callback: function(err, source, sourceMap, module) {}) 处理一个文件时，如果依赖其他文件的处理结果才能得出当前文件的结果时</li>
<li>this.resolve(context: string, request: string, callback: function(err, res: string) {}) 像 require 语句一样获取指定文件的完整路径</li>
<li>this.addDependency(file: string) 给当前处理文件添加其依赖的文件，以便在其依赖文件变化时，会重新调用 loader 处理该文件</li>
<li>this.addContextDependency(directory: string) 把整个目录加入到当前正在处理文件的依赖中</li>
<li>this.clearDependencies 清楚当前正在处理文件的所有依赖</li>
</ul>
</li>
</ol>
<p>api 的原理？？</p>
<h3 id="plugins"><a href="#plugins" class="headerlink" title="plugins"></a>plugins</h3><p>插件是一个具有<code>apply</code>属性的 js 对象。<code>apply</code>属性会被 webpack compiler 调用，并且 compiler 对象可在整个编译生命周期访问。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConsoleLogOnBuildWebpackPlugin.js</span></span><br><span class="line"><span class="keyword">const</span> pluginName = <span class="string">'ConsoleLogOnBuildWebpackPlugin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConsoleLogOnBuildWebpackPlugin</span> </span>&#123;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.hooks.run.tap(pluginName, (compilation) =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'webpack xxxxxx'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// compiler hook的tap方法第一个参数，要为插件名称，以便可以在所有hook中复用。</span></span><br></pre></td></tr></table></figure>

<p>另一种调用方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"><span class="keyword">const</span> configuration = <span class="built_in">require</span>(<span class="string">'./webpack.config.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> compiler = webpack(configuration);</span><br><span class="line">compiler.apply(<span class="keyword">new</span> webpack.ProgressPlugin());</span><br><span class="line">compiler.run(<span class="function"><span class="keyword">function</span> (<span class="params">err, stats</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//... error-first</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p><a href="https://github.com/webpack/tapable">Tapable</a></p>
<p>webpack 本质是一种事件流机制，工作流程是将各个插件串联起来，而实现这一切的核心就是 Tababl，webpack 中最核心的负责 Compiler 和负责创建 bundles 的 Compilation 都是 Tapable 的实例。</p>
<p>Tapable 的钩子</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkfth961gsj31120g2jvk.jpg" alt="Tapable的钩子"></p>
<table>
<thead>
<tr>
<th>钩子 name</th>
<th>执行方式</th>
<th>使用要点</th>
</tr>
</thead>
<tbody><tr>
<td>SyncHook</td>
<td>同步串行</td>
<td>不关心监听函数返回值</td>
</tr>
<tr>
<td>SyncBailHook(同步熔断)</td>
<td>同步串行</td>
<td>只要监听函数中有一个函数的返回值不为 null，则跳过剩下的所有逻辑</td>
</tr>
<tr>
<td>SyncWaterfallHook</td>
<td>同步串行</td>
<td>上一个监听函数的返回值可以传给下一个监听函数</td>
</tr>
<tr>
<td>SyncLoopHook</td>
<td>同步循环</td>
<td>当监听函数被触发的时候，如果该监听函数返回 true 则这个监听函数会反复执行，如果返回 undefined 则表示退出循环</td>
</tr>
<tr>
<td>AsyncParallelHook</td>
<td>异步并发</td>
<td>不关心监听函数返回值</td>
</tr>
<tr>
<td>AsyncParallelBailHook(异步熔断)</td>
<td>异步并发</td>
<td>只要监听函数返回值不为 null，就会忽略后面的监听函数执行，直接跳跃到 callAsync 等触发函数绑定的回调函数，然后执行这个被绑定的会调函数</td>
</tr>
<tr>
<td>AsyncSeriesHook</td>
<td>异步串行</td>
<td>不关心 callback()的灿忽视</td>
</tr>
<tr>
<td>AsyncSeriesBailHook</td>
<td>异步串行</td>
<td>callback()参数不为 null，就会直接执行 callAsync 等触发函数绑定的会调函数</td>
</tr>
<tr>
<td>AsyncSeriesWaterfallHook</td>
<td>异步串行</td>
<td>上一个监听函数中的 callback(err, data)的第二个参数，可以最为下一个监听函数的参数</td>
</tr>
</tbody></table>
<p>hooks 原理是发布订阅模式的实现。。。</p>
<p>同步串行</p>
<ol>
<li>SyncHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不关心监听函数返回值</span></span><br><span class="line"><span class="keyword">const</span> &#123; SyncHook &#125; = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="keyword">const</span> queue = <span class="keyword">new</span> SyncHook([<span class="string">'name'</span>]); <span class="comment">// string[]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 订阅</span></span><br><span class="line">queue.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name1, name2</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name1, name2, <span class="number">1</span>); <span class="comment">// webpack1 undefined 1</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">'1'</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name1</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name1, <span class="number">2</span>); <span class="comment">// webpack 2</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name1</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name1, <span class="number">3</span>); <span class="comment">// webpack 3</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布</span></span><br><span class="line">queue.call(<span class="string">'webpack'</span>, <span class="string">'webpack-cli'</span>); <span class="comment">// 发布时触发订阅的函数，同时传入参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncHook1</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 订阅</span></span><br><span class="line">  tap(name, fn) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks.push(fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发布</span></span><br><span class="line">  call() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks.forEach(<span class="function">(<span class="params">hook</span>) =&gt;</span> hook(...arguments));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>SyncBailHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只要监听函数中有一个函数的返回值不为 null，则跳过剩下所有的逻辑</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; SyncBailHook &#125; = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> SyncBailHook([<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'wrong'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">queue.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.call(<span class="string">'webpack'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行结果:</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">webpack 1</span></span><br><span class="line"><span class="comment">webpack 2</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncBailHook1</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 订阅</span></span><br><span class="line">  tap(name, fn) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks.push(fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发布</span></span><br><span class="line">  call() &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = <span class="keyword">this</span>.hooks.length; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">let</span> hook = <span class="keyword">this</span>.hooks[i];</span><br><span class="line">      <span class="keyword">let</span> result = hook(...arguments);</span><br><span class="line">      <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>SyncWaterfallHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上一个监听函数的返回值可以传给下一个监听函数</span></span><br><span class="line"><span class="keyword">const</span> &#123; SyncWaterfallHok &#125; = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue = <span class="keyword">new</span> SyncWaterfallHok([<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data, <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.call(<span class="string">'webpack'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">返回</span></span><br><span class="line"><span class="comment">webpack 1</span></span><br><span class="line"><span class="comment">1 2</span></span><br><span class="line"><span class="comment">2 3</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncWaterfallHook1</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 订阅</span></span><br><span class="line">  tap(name, fn) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks.push(fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发布</span></span><br><span class="line">  call() &#123;</span><br><span class="line">    <span class="keyword">let</span> result = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = <span class="keyword">this</span>.hooks.length; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">let</span> hook = <span class="keyword">this</span>.hooks[i];</span><br><span class="line">      result = i == <span class="number">0</span> ? hook(...arguments) : hook(result);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>SyncLoopHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当监听函数被触发时，如果该监听函数返回true，则这个监听函数会反复执行，如果返回undefined则表示退出循环</span></span><br><span class="line"><span class="keyword">const</span> &#123; SyncLoopHook &#125; = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue = <span class="keyword">new</span> SyncLoopHook([<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> count = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'count: '</span>, count--);</span><br><span class="line">  <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.call(<span class="string">'webpack'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	count: 3</span></span><br><span class="line"><span class="comment">	count: 2</span></span><br><span class="line"><span class="comment">	count: 1</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncLoopHook1</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hook = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 订阅</span></span><br><span class="line">  tap(name, fn) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hook = fn;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发布</span></span><br><span class="line">  call() &#123;</span><br><span class="line">    <span class="keyword">let</span> result;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      result = <span class="keyword">this</span>.hook(...arguments);</span><br><span class="line">    &#125; <span class="keyword">while</span> (result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>异步并行</p>
<ol>
<li><p>AsyncParallelHook</p>
<p>不关心监听函数返回值，有三种注册/发布的模式</p>
<table>
<thead>
<tr>
<th>异步订阅</th>
<th>调用方法</th>
</tr>
</thead>
<tbody><tr>
<td>tap</td>
<td>callAsync</td>
</tr>
<tr>
<td>tapAsync</td>
<td>callAsync</td>
</tr>
<tr>
<td>tapPromise</td>
<td>Promise</td>
</tr>
</tbody></table>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tap模式</span></span><br><span class="line"><span class="keyword">const</span> &#123; AsyncParallelHook &#125; = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue1 = <span class="keyword">new</span> AsyncParallelHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue1.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.callAsync(<span class="string">'webpack'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	webpack 3</span></span><br><span class="line"><span class="comment">	cost: 4.520ms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// tapAsync模式 回调形式</span></span><br><span class="line"><span class="keyword">const</span> queue2 = <span class="keyword">new</span> AsyncParallelHook([<span class="string">'name'</span>]);</span><br><span class="line">conole.time(<span class="string">'cost1'</span>);</span><br><span class="line">queue2.tapAsync(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue2.callAsync(<span class="string">'webpack'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost1'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	webpack 3</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	time: 3004.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// promise模式 promsie形式</span></span><br><span class="line"><span class="keyword">const</span> queue3 = <span class="keyword">new</span> AsyncParallelHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost3'</span>);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue3.promise(<span class="string">'webpack'</span>).then(</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'error'</span>);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	webpack 3</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	cost3: 3007.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理？？</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>AsyncParallelBailHook(异步并行熔断)</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只要监函数的返回值不为null，就会忽略后面的监听函数执行，直跳跃到callAsync等触发函数绑定的回调函数，然后执行这个被绑定的回调函数。</span></span><br><span class="line"><span class="keyword">const</span> queue1 = <span class="keyword">new</span> AsyncParallelBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue1.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'wrong'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.callAsync(<span class="string">'webpack'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	cost: 4.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue2 = <span class="keyword">new</span> AsyncParallelBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost1'</span>);</span><br><span class="line">queue2.tapAsync(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'wrong'</span>;</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue2.callAsync(<span class="string">'webpack'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost1'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	webpack 3</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue3 = <span class="keyword">new</span> AsyncParallelBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost3'</span>);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">      reject(<span class="string">'wrong'</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="number">3</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue3.promise(<span class="string">'webpack'</span>).then(</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'error'</span>);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">返回</span></span><br><span class="line"><span class="comment">webpack1</span></span><br><span class="line"><span class="comment">webpack2</span></span><br><span class="line"><span class="comment">error</span></span><br><span class="line"><span class="comment">cost3: 2008.xxxms</span></span><br><span class="line"><span class="comment">webpack 3</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>异步串行</p>
<ol>
<li>AsyncSeriesHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不关心callback()的参数</span></span><br><span class="line"><span class="keyword">const</span> queue1 = <span class="keyword">new</span> AsyncSeriesHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost1'</span>);</span><br><span class="line">queue1.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'wrong'</span></span><br><span class="line">&#125;)</span><br><span class="line">queue1.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;)</span><br><span class="line">queue1.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">&#125;)</span><br><span class="line">queue1.callAsync(<span class="string">'zfpx'</span>, err =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost1'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	1</span></span><br><span class="line"><span class="comment">	2</span></span><br><span class="line"><span class="comment">	3</span></span><br><span class="line"><span class="comment">	undefined</span></span><br><span class="line"><span class="comment">	cost1: 3.9xxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue2 = <span class="keyword">new</span> AsyncSeriesHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost2'</span>);</span><br><span class="line">queue2.tapAsync(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">queue2.tapAsync(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">queue2.tapAsync(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name,<span class="number">3</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">queue2.callAsync(<span class="string">'webpack'</span>, err =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost2'</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	webpack 3</span></span><br><span class="line"><span class="comment">	undefined</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	cost2: 6xxx.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue3 = AsyncSeriesHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost3'</span>);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">1</span>)</span><br><span class="line">      resolve()</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">queue3.tapPromise(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">2</span>)</span><br><span class="line">      resolve()</span><br><span class="line">    &#125;, <span class="number">2000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">queue3.tapPromise(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">3</span>)</span><br><span class="line">      resolve()</span><br><span class="line">    &#125;, <span class="number">3000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">queue3.promise(<span class="string">'webpack'</span>).then(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err)</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	webpack 3</span></span><br><span class="line"><span class="comment">	undefined</span></span><br><span class="line"><span class="comment">	cost3: 6xxx.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncSeriesHook1</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks = []</span><br><span class="line">  &#125;</span><br><span class="line">  tapAsync(name, fn) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks.push(fn)</span><br><span class="line">  &#125;</span><br><span class="line">  callAsync() &#123;</span><br><span class="line">    <span class="keyword">let</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">let</span> args = [...arguments];</span><br><span class="line">    <span class="keyword">let</span> done = args.pop();</span><br><span class="line">    <span class="keyword">let</span> idx = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 如果next的参数有值，就直接跳跃到执行callAsync的回调函数</span></span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> done(err);</span><br><span class="line">      <span class="keyword">let</span> fn = self.hooks[idx++];</span><br><span class="line">      fn ? fn(..args, next) : done()</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>AsyncSeriesBailHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// callback()的参数不为null，就会直接执行callAsync等触发函数绑定的回调函数</span></span><br><span class="line"><span class="comment">// tap</span></span><br><span class="line"><span class="keyword">const</span> queue1 = <span class="keyword">new</span> AsyncSeriesBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost1'</span>);</span><br><span class="line">queue1.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'wrong'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.callAsync(<span class="string">'webpack'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost1'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	1</span></span><br><span class="line"><span class="comment">	null</span></span><br><span class="line"><span class="comment">	cost1: 3.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// tapAsync</span></span><br><span class="line"><span class="keyword">const</span> queue2 = <span class="keyword">new</span> AsyncSeriesBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost2'</span>);</span><br><span class="line">queue2.tapAsync(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">    callback();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">    callback(<span class="string">'wrong'</span>);</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">    callback();</span><br><span class="line">  &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.callAsync(<span class="string">'webpack'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost2'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	wrong</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	cost2: 3xxx.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// promise</span></span><br><span class="line"><span class="keyword">const</span> queue3 = <span class="keyword">new</span> AsyncSeriesBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost3'</span>);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.promise(<span class="string">'webpack'</span>).then(</span><br><span class="line">  (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	undefined</span></span><br><span class="line"><span class="comment">	error</span></span><br><span class="line"><span class="comment">	cost3: 3xxx.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>AsyncSeriesWaterfallHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上一个监听函数中的callback(err, data)的第二个参数，可以作为下一个监听函数的参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// tap</span></span><br><span class="line"><span class="keyword">const</span> queue1 = <span class="keyword">new</span> AsyncSeriesWaterfallHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost1'</span>);</span><br><span class="line">queue1.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'aa'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>, data);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'bb'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="number">3</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>, data);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.callAsync(<span class="string">'webpack'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost1'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	2 aa</span></span><br><span class="line"><span class="comment">	3 bb</span></span><br><span class="line"><span class="comment">	null ??</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	cost1: 5.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// tapAsync</span></span><br><span class="line"><span class="keyword">const</span> queue2 = <span class="keyword">new</span> AsyncSeriesWaterfallHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost2'</span>);</span><br><span class="line">queue2.tapAsync(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'1: '</span>, name);</span><br><span class="line">    callback(<span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'2: '</span>, data);</span><br><span class="line">    callback(<span class="literal">null</span>, <span class="number">3</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'3: '</span>, data);</span><br><span class="line">    callback(<span class="literal">null</span>, <span class="number">3</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.callAsync(<span class="string">'webpack'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost2'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	1: webpack</span></span><br><span class="line"><span class="comment">	2: 2</span></span><br><span class="line"><span class="comment">	3: 3</span></span><br><span class="line"><span class="comment">	null</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	cost2: 6xxx.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// promise</span></span><br><span class="line"><span class="keyword">const</span> queue3 = <span class="keyword">new</span> AsyncSeriesWaterfallHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost3'</span>);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'1: '</span>, name);</span><br><span class="line">      resolve(<span class="string">'1'</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'2: '</span>, name);</span><br><span class="line">      resolve(<span class="string">'2'</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'3: '</span>, data);</span><br><span class="line">      resolve(<span class="string">'over'</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.promise(<span class="string">'webpack'</span>).then(</span><br><span class="line">  (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	1: webpack</span></span><br><span class="line"><span class="comment">	2: 1</span></span><br><span class="line"><span class="comment">	3: 2</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	cost3: 6xxx.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncSeriesWaterfallHook1</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks = [];</span><br><span class="line">  &#125;</span><br><span class="line">  tapAsync(name, fn) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks.push(fn);</span><br><span class="line">  &#125;</span><br><span class="line">  callAsync() &#123;</span><br><span class="line">    <span class="keyword">let</span> self = <span class="keyword">this</span>,</span><br><span class="line">      args = [...arguments],</span><br><span class="line">      done = args.pop();</span><br><span class="line">    <span class="built_in">console</span>.log(args);</span><br><span class="line">    <span class="keyword">let</span> idx = <span class="number">0</span>,</span><br><span class="line">      result = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (idx &gt;= self.hooks.length) <span class="keyword">return</span> done();</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> done(err);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> fn = self.hooks[idx++];</span><br><span class="line">      <span class="keyword">if</span> (idx === <span class="number">1</span>) &#123;</span><br><span class="line">        fn(...args, next);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fn(data, next);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TODO: 几个 hooks 的发布订阅原理</p>
<p><a href="https://juejin.im/post/6844903573675835400" target="_blank" rel="noopener">详解</a></p>
<h3 id="webpack-compiler"><a href="#webpack-compiler" class="headerlink" title="webpack compiler"></a>webpack compiler</h3><p>webpack 的入口文件其实就实例了 Compiler 并调用了 run 方法进行了编译，webpack 的编译都按照如下钩子调用顺序执行。</p>
<ul>
<li>before-run 清楚缓存</li>
<li>run 注册缓存数据钩子</li>
<li>before-compile</li>
<li>compile 开始编译</li>
<li>make 从入口分析依赖以及间接依赖模块，创建模块对象</li>
<li>build-module 模块构建</li>
<li>seal 构建结果封装，不可再更改</li>
<li>after-compile 完成构建、缓存数据</li>
<li>emit 输出到 dist 目录</li>
</ul>
<h3 id="webpack-compilation"><a href="#webpack-compilation" class="headerlink" title="webpack compilation"></a>webpack compilation</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2019/09/07/webpack相关/" data-id="ckr0g7uf4000lwyyzxca0ptkh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/webpack/">webpack</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2019/09/15/异步与性能/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          异步与性能
        
      </div>
    </a>
  
  
    <a href="/blog/2019/09/03/类型与语法/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">类型与语法</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Chrome/">Chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/React/">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Spring/">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/qiankun-微前端-umi/">qiankun 微前端 umi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/vscode-eslint-prettier/">vscode eslint prettier</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/webpack/">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/上卷-this-原型对象/">上卷 this 原型对象</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/上卷-作用域和闭包/">上卷 作用域和闭包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/上卷-对象/">上卷 对象</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/中卷-异步与性能/">中卷 异步与性能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/中卷-类型-值/">中卷 类型 值</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/你不知道的JavaScript/">你不知道的JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/前端-工程化-npm/">前端 工程化 npm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/前端-设计模式/">前端 设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/单点登录-SSO/">单点登录 SSO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/序/">序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/测试/">测试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/blog/tags/Java/" style="font-size: 20px;">Java</a> <a href="/blog/tags/React/" style="font-size: 10px;">React</a> <a href="/blog/tags/Spring/" style="font-size: 10px;">Spring</a> <a href="/blog/tags/qiankun-微前端-umi/" style="font-size: 10px;">qiankun 微前端 umi</a> <a href="/blog/tags/vscode-eslint-prettier/" style="font-size: 10px;">vscode eslint prettier</a> <a href="/blog/tags/webpack/" style="font-size: 10px;">webpack</a> <a href="/blog/tags/上卷-this-原型对象/" style="font-size: 10px;">上卷 this 原型对象</a> <a href="/blog/tags/上卷-作用域和闭包/" style="font-size: 10px;">上卷 作用域和闭包</a> <a href="/blog/tags/上卷-对象/" style="font-size: 10px;">上卷 对象</a> <a href="/blog/tags/中卷-异步与性能/" style="font-size: 10px;">中卷 异步与性能</a> <a href="/blog/tags/中卷-类型-值/" style="font-size: 10px;">中卷 类型 值</a> <a href="/blog/tags/你不知道的JavaScript/" style="font-size: 10px;">你不知道的JavaScript</a> <a href="/blog/tags/前端-工程化-npm/" style="font-size: 10px;">前端 工程化 npm</a> <a href="/blog/tags/前端-设计模式/" style="font-size: 10px;">前端 设计模式</a> <a href="/blog/tags/单点登录-SSO/" style="font-size: 10px;">单点登录 SSO</a> <a href="/blog/tags/序/" style="font-size: 10px;">序</a> <a href="/blog/tags/测试/" style="font-size: 10px;">测试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/07/">July 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2021/07/12/Spring/">Spring</a>
          </li>
        
          <li>
            <a href="/blog/2021/03/26/测试相关/">测试相关</a>
          </li>
        
          <li>
            <a href="/blog/2021/03/24/headless-chrome/">headless chrome</a>
          </li>
        
          <li>
            <a href="/blog/2021/03/24/java高级/">Java高级</a>
          </li>
        
          <li>
            <a href="/blog/2021/02/03/SSO实践/">SSO实践</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 WangQinyong<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>



  </div>
</body>
</html>