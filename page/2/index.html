<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>王秦勇的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="王秦勇的博客">
<meta property="og:url" content="https://github.com/wangqinyong1994/blog/page/2/index.html">
<meta property="og:site_name" content="王秦勇的博客">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="王秦勇的博客">
  
    <link rel="alternate" href="/blog/atom.xml" title="王秦勇的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blog/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">王秦勇的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/blog/" id="subtitle">记录一下</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/wangqinyong1994/blog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-异步与性能" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2019/09/15/异步与性能/" class="article-date">
  <time datetime="2019-09-15T03:47:44.000Z" itemprop="datePublished">2019-09-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2019/09/15/异步与性能/">异步与性能</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>现在与将来</strong></p>
<ol>
<li>setTimeout精度不高， 是因为事件循环。</li>
<li>一旦有事件需要运行， 事件循环就会运行， 知道队列清空。 事件循环的每一轮称谓一个tick。用户交互、IO和定时器都会向事件队列中加入事件。任意时刻， 一次只能从队列中处理一个事件。 执行事件的时候， 可能肢解或间接地引发一个或多个后续事件。</li>
</ol>
<p><strong>回调</strong></p>
<p><strong>Promise</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2019/09/15/异步与性能/" data-id="ckonxgfap000i78yzmy7gmxwd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/中卷-异步与性能/">中卷 异步与性能</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-webpack相关" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2019/09/07/webpack相关/" class="article-date">
  <time datetime="2019-09-06T16:05:48.000Z" itemprop="datePublished">2019-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2019/09/07/webpack相关/">webpack相关</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h1><h2 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h2><p><a href="https://github.com/webpack/webpack">github webpack</a></p>
<p><a href="https://www.webpackjs.com/" target="_blank" rel="noopener">中文官网</a></p>
<p><a href="https://webpack.js.org/" target="_blank" rel="noopener">英文官网</a></p>
<ol>
<li>大模块<ul>
<li>entry</li>
<li>output</li>
<li>loader</li>
<li>plugins</li>
</ul>
</li>
</ol>
<h3 id="entry"><a href="#entry" class="headerlink" title="entry"></a>entry</h3><p>单入口语法： <code>entry: string | string[]</code></p>
<p>对象语法：<code>entry: { [entryChunkName: string]: string | string[] }</code></p>
<p>常见场景：</p>
<p>分离应用程序 app 与第三方库 vender</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    app: <span class="string">'./src/app.js'</span>,</span><br><span class="line">    vendors: <span class="string">'./src/vendors.js'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该配置比较常见于只有一个入口起点的SPA</span></span><br><span class="line"><span class="comment">// 如果应用程序bundle中没有vendor，那么你可以在webpack中实现长缓存。</span></span><br></pre></td></tr></table></figure>

<p><a href="https://www.webpackjs.com/guides/caching/" target="_blank" rel="noopener">缓存</a></p>
<p>mpa</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    p1: <span class="string">'./src/p1/index.js'</span>,</span><br><span class="line">    p2: <span class="string">'./src/p2/index.js'</span>,</span><br><span class="line">    p3: <span class="string">'./src/p3/index.js'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="output"><a href="#output" class="headerlink" title="output"></a>output</h3><p><strong>即使多入口，也只指定一个输出</strong></p>
<ul>
<li>filename: 输出文件文件名</li>
<li>path: 输出路径</li>
</ul>
<p>多入口起点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    app: <span class="string">'./src/app.js'</span>,</span><br><span class="line">    search: <span class="string">'./src/search.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">'[name].js'</span>,</span><br><span class="line">    path: __dirname + <span class="string">'/dist'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cdn + 资源 hash</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.js</span></span><br><span class="line">output: &#123;</span><br><span class="line">  path: <span class="string">'/xx/xx/assets/[hash]'</span>,</span><br><span class="line">  publicPath: <span class="string">'https://cdn.xxx.com/assets/[hash]/'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//编译时不知道最终输出文件的publicPath时，publicPath可以留空，并且在入口起点文件运行时动态设置。可在入口起点设置__webpack_public_path__</span></span><br><span class="line"></span><br><span class="line">__webpack_public_path__ = runtimePublicPath</span><br><span class="line"></span><br><span class="line"><span class="comment">// __webpack_对象_键__</span></span><br></pre></td></tr></table></figure>

<h3 id="mode"><a href="#mode" class="headerlink" title="mode"></a>mode</h3><p>Webpack4.x 以上，指定<code>mode</code> development/production</p>
<h3 id="loader"><a href="#loader" class="headerlink" title="loader"></a>loader</h3><p>3 中使用 loader 方式</p>
<ul>
<li>webpack.config.js 里配置</li>
<li>每个 import 语句中显示指定</li>
<li>shell 里指定</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">      use: [</span><br><span class="line">        &#123;</span><br><span class="line">          loader: <span class="string">'style-loader'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          loader: <span class="string">'css-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            modules: <span class="literal">true</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 内联</span></span><br><span class="line"><span class="keyword">import</span> Styles <span class="keyword">from</span> <span class="string">'style-loader!css-loader?modules!./styles.css'</span>;</span><br></pre></td></tr></table></figure>

<p>cli</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webpack --module-bind jade-loader --module-bind 'css=style-loader!css-loader'</span><br></pre></td></tr></table></figure>

<h4 id="loader-特性"><a href="#loader-特性" class="headerlink" title="loader 特性"></a>loader 特性</h4><ul>
<li><p>链式传递、配置处、由后往前、由下往上。</p>
</li>
<li><p>同步或异步</p>
</li>
<li><p>运行在 nodejs 中</p>
</li>
<li><p>可接受查询参数，用于 loader 传递配置</p>
</li>
<li><p>可使用 options 对象配置</p>
</li>
<li><p>可以将普通 npm 块导出为 loader，做法在 package.json 里定义一个 loader</p>
</li>
<li><p>plugin 可以配合 loader</p>
</li>
<li><p>loader 可产生额外的任意文件</p>
</li>
</ul>
<h4 id="loader-原理"><a href="#loader-原理" class="headerlink" title="loader 原理"></a>loader 原理</h4><p>导出函数，函数里返回字符串。。。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file-loader</span></span><br><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loader</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> filename = loaderUtils.interpolateName(<span class="keyword">this</span>, <span class="string">`[hash].[ext]`</span>, &#123;</span><br><span class="line">    content: source,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">this</span>.emitFile(filename, source);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`module.exports="<span class="subst">$&#123;filename&#125;</span>"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">loader.raw = <span class="literal">true</span>;</span><br><span class="line"><span class="built_in">module</span>.exports = loader;</span><br><span class="line"></span><br><span class="line"><span class="comment">// url-loader</span></span><br><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="keyword">const</span> mime = <span class="built_in">require</span>(<span class="string">'mime'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loader</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; limit &#125; = loaderUtils.getOptions(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> (limit &amp;&amp; limit &gt; source.length) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`module.exports = "data:<span class="subst">$&#123;mime.getType(</span></span></span><br><span class="line"><span class="string"><span class="subst">      <span class="keyword">this</span>.resourcePath</span></span></span><br><span class="line"><span class="string"><span class="subst">    )&#125;</span>;base64,<span class="subst">$&#123;source.toString(<span class="string">'base64'</span>)&#125;</span>"`</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'./file-loader'</span>).call(<span class="keyword">this</span>, source);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">loader.raw = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = loader;</span><br></pre></td></tr></table></figure>

<h4 id="loader-相关-api"><a href="#loader-相关-api" class="headerlink" title="loader 相关 api"></a>loader 相关 api</h4><ol>
<li><p>缓存 webpack 来提高编译效率 this.cacheable(); this.cacheable 原理？？</p>
</li>
<li><p>异步：当一个 loader 无依赖可异步的时候，不阻塞去执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">  asyncAction(content, <span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);</span><br><span class="line">    callback(<span class="literal">null</span>, result);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// this.async原理？？</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>传入源文件以 buffer 形式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports.raw = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取 loader 的 options</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = loaderUtils.getOptions(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">return</span> source;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>校验传入 options 是否符合要求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"><span class="keyword">const</span> validate = <span class="built_in">require</span>(<span class="string">'schema-utils'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> json = &#123;</span><br><span class="line">  type: <span class="string">'object'</span>,</span><br><span class="line">  properties: &#123;</span><br><span class="line">    content: &#123;</span><br><span class="line">      type: <span class="string">'string'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = loaderUtils.getOptions(<span class="keyword">this</span>);</span><br><span class="line">  validate(json, options, <span class="string">'xxx-loader'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 不满足schema报错</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>loader 返回其他结果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// this.callback告诉webpack返回的结果</span></span><br><span class="line">  <span class="keyword">this</span>.callback(<span class="literal">null</span>, source, sourceMaps);</span><br><span class="line">  <span class="comment">// 当使用this.callback返回内容时，该loader必须返回undefind，以让webpack知道该loader返回结果在this.callback中，而不是在return中</span></span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>同步与异步</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据实际情况去识别使用同步还是异步</span></span><br><span class="line"><span class="comment">// 异步demo</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">  asyncAction(source, <span class="function"><span class="keyword">function</span> (<span class="params">err, result, sourceMaps, ast</span>) </span>&#123;</span><br><span class="line">    callback(err, result, sourceMaps, ast);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>其他</p>
<ul>
<li>this.context 当前处理文件的所在目录</li>
<li>this.resource 当前处理文件的完整请求路径，包括 querystring</li>
<li>this.resourcePath 当前处理文件的路径</li>
<li>this.resourceQuery 当前处理文件的 querystring</li>
<li>this.target 等于 webpack 中 Target</li>
<li>this.loadModule(request: string, callback: function(err, source, sourceMap, module) {}) 处理一个文件时，如果依赖其他文件的处理结果才能得出当前文件的结果时</li>
<li>this.resolve(context: string, request: string, callback: function(err, res: string) {}) 像 require 语句一样获取指定文件的完整路径</li>
<li>this.addDependency(file: string) 给当前处理文件添加其依赖的文件，以便在其依赖文件变化时，会重新调用 loader 处理该文件</li>
<li>this.addContextDependency(directory: string) 把整个目录加入到当前正在处理文件的依赖中</li>
<li>this.clearDependencies 清楚当前正在处理文件的所有依赖</li>
</ul>
</li>
</ol>
<p>api 的原理？？</p>
<h3 id="plugins"><a href="#plugins" class="headerlink" title="plugins"></a>plugins</h3><p>插件是一个具有<code>apply</code>属性的 js 对象。<code>apply</code>属性会被 webpack compiler 调用，并且 compiler 对象可在整个编译生命周期访问。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConsoleLogOnBuildWebpackPlugin.js</span></span><br><span class="line"><span class="keyword">const</span> pluginName = <span class="string">'ConsoleLogOnBuildWebpackPlugin'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConsoleLogOnBuildWebpackPlugin</span> </span>&#123;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.hooks.run.tap(pluginName, (compilation) =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'webpack xxxxxx'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// compiler hook的tap方法第一个参数，要为插件名称，以便可以在所有hook中复用。</span></span><br></pre></td></tr></table></figure>

<p>另一种调用方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"><span class="keyword">const</span> configuration = <span class="built_in">require</span>(<span class="string">'./webpack.config.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> compiler = webpack(configuration);</span><br><span class="line">compiler.apply(<span class="keyword">new</span> webpack.ProgressPlugin());</span><br><span class="line">compiler.run(<span class="function"><span class="keyword">function</span> (<span class="params">err, stats</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//... error-first</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p><a href="https://github.com/webpack/tapable">Tapable</a></p>
<p>webpack 本质是一种事件流机制，工作流程是将各个插件串联起来，而实现这一切的核心就是 Tababl，webpack 中最核心的负责 Compiler 和负责创建 bundles 的 Compilation 都是 Tapable 的实例。</p>
<p>Tapable 的钩子</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkfth961gsj31120g2jvk.jpg" alt="Tapable的钩子"></p>
<table>
<thead>
<tr>
<th>钩子 name</th>
<th>执行方式</th>
<th>使用要点</th>
</tr>
</thead>
<tbody><tr>
<td>SyncHook</td>
<td>同步串行</td>
<td>不关心监听函数返回值</td>
</tr>
<tr>
<td>SyncBailHook(同步熔断)</td>
<td>同步串行</td>
<td>只要监听函数中有一个函数的返回值不为 null，则跳过剩下的所有逻辑</td>
</tr>
<tr>
<td>SyncWaterfallHook</td>
<td>同步串行</td>
<td>上一个监听函数的返回值可以传给下一个监听函数</td>
</tr>
<tr>
<td>SyncLoopHook</td>
<td>同步循环</td>
<td>当监听函数被触发的时候，如果该监听函数返回 true 则这个监听函数会反复执行，如果返回 undefined 则表示退出循环</td>
</tr>
<tr>
<td>AsyncParallelHook</td>
<td>异步并发</td>
<td>不关心监听函数返回值</td>
</tr>
<tr>
<td>AsyncParallelBailHook(异步熔断)</td>
<td>异步并发</td>
<td>只要监听函数返回值不为 null，就会忽略后面的监听函数执行，直接跳跃到 callAsync 等触发函数绑定的回调函数，然后执行这个被绑定的会调函数</td>
</tr>
<tr>
<td>AsyncSeriesHook</td>
<td>异步串行</td>
<td>不关心 callback()的灿忽视</td>
</tr>
<tr>
<td>AsyncSeriesBailHook</td>
<td>异步串行</td>
<td>callback()参数不为 null，就会直接执行 callAsync 等触发函数绑定的会调函数</td>
</tr>
<tr>
<td>AsyncSeriesWaterfallHook</td>
<td>异步串行</td>
<td>上一个监听函数中的 callback(err, data)的第二个参数，可以最为下一个监听函数的参数</td>
</tr>
</tbody></table>
<p>hooks 原理是发布订阅模式的实现。。。</p>
<p>同步串行</p>
<ol>
<li>SyncHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不关心监听函数返回值</span></span><br><span class="line"><span class="keyword">const</span> &#123; SyncHook &#125; = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"><span class="keyword">const</span> queue = <span class="keyword">new</span> SyncHook([<span class="string">'name'</span>]); <span class="comment">// string[]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 订阅</span></span><br><span class="line">queue.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name1, name2</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name1, name2, <span class="number">1</span>); <span class="comment">// webpack1 undefined 1</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">'1'</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name1</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name1, <span class="number">2</span>); <span class="comment">// webpack 2</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name1</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name1, <span class="number">3</span>); <span class="comment">// webpack 3</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布</span></span><br><span class="line">queue.call(<span class="string">'webpack'</span>, <span class="string">'webpack-cli'</span>); <span class="comment">// 发布时触发订阅的函数，同时传入参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncHook1</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 订阅</span></span><br><span class="line">  tap(name, fn) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks.push(fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发布</span></span><br><span class="line">  call() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks.forEach(<span class="function">(<span class="params">hook</span>) =&gt;</span> hook(...arguments));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>SyncBailHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只要监听函数中有一个函数的返回值不为 null，则跳过剩下所有的逻辑</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; SyncBailHook &#125; = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> queue = <span class="keyword">new</span> SyncBailHook([<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'wrong'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">queue.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.call(<span class="string">'webpack'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行结果:</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">webpack 1</span></span><br><span class="line"><span class="comment">webpack 2</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncBailHook1</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 订阅</span></span><br><span class="line">  tap(name, fn) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks.push(fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发布</span></span><br><span class="line">  call() &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = <span class="keyword">this</span>.hooks.length; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">let</span> hook = <span class="keyword">this</span>.hooks[i];</span><br><span class="line">      <span class="keyword">let</span> result = hook(...arguments);</span><br><span class="line">      <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>SyncWaterfallHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上一个监听函数的返回值可以传给下一个监听函数</span></span><br><span class="line"><span class="keyword">const</span> &#123; SyncWaterfallHok &#125; = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue = <span class="keyword">new</span> SyncWaterfallHok([<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data, <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.call(<span class="string">'webpack'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">返回</span></span><br><span class="line"><span class="comment">webpack 1</span></span><br><span class="line"><span class="comment">1 2</span></span><br><span class="line"><span class="comment">2 3</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncWaterfallHook1</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 订阅</span></span><br><span class="line">  tap(name, fn) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks.push(fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发布</span></span><br><span class="line">  call() &#123;</span><br><span class="line">    <span class="keyword">let</span> result = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = <span class="keyword">this</span>.hooks.length; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">let</span> hook = <span class="keyword">this</span>.hooks[i];</span><br><span class="line">      result = i == <span class="number">0</span> ? hook(...arguments) : hook(result);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>SyncLoopHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当监听函数被触发时，如果该监听函数返回true，则这个监听函数会反复执行，如果返回undefined则表示退出循环</span></span><br><span class="line"><span class="keyword">const</span> &#123; SyncLoopHook &#125; = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue = <span class="keyword">new</span> SyncLoopHook([<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> count = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">queue.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'count: '</span>, count--);</span><br><span class="line">  <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue.call(<span class="string">'webpack'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	count: 3</span></span><br><span class="line"><span class="comment">	count: 2</span></span><br><span class="line"><span class="comment">	count: 1</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SyncLoopHook1</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hook = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 订阅</span></span><br><span class="line">  tap(name, fn) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hook = fn;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发布</span></span><br><span class="line">  call() &#123;</span><br><span class="line">    <span class="keyword">let</span> result;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      result = <span class="keyword">this</span>.hook(...arguments);</span><br><span class="line">    &#125; <span class="keyword">while</span> (result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>异步并行</p>
<ol>
<li><p>AsyncParallelHook</p>
<p>不关心监听函数返回值，有三种注册/发布的模式</p>
<table>
<thead>
<tr>
<th>异步订阅</th>
<th>调用方法</th>
</tr>
</thead>
<tbody><tr>
<td>tap</td>
<td>callAsync</td>
</tr>
<tr>
<td>tapAsync</td>
<td>callAsync</td>
</tr>
<tr>
<td>tapPromise</td>
<td>Promise</td>
</tr>
</tbody></table>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tap模式</span></span><br><span class="line"><span class="keyword">const</span> &#123; AsyncParallelHook &#125; = <span class="built_in">require</span>(<span class="string">'tapable'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue1 = <span class="keyword">new</span> AsyncParallelHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue1.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.callAsync(<span class="string">'webpack'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	webpack 3</span></span><br><span class="line"><span class="comment">	cost: 4.520ms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// tapAsync模式 回调形式</span></span><br><span class="line"><span class="keyword">const</span> queue2 = <span class="keyword">new</span> AsyncParallelHook([<span class="string">'name'</span>]);</span><br><span class="line">conole.time(<span class="string">'cost1'</span>);</span><br><span class="line">queue2.tapAsync(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue2.callAsync(<span class="string">'webpack'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost1'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	webpack 3</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	time: 3004.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// promise模式 promsie形式</span></span><br><span class="line"><span class="keyword">const</span> queue3 = <span class="keyword">new</span> AsyncParallelHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost3'</span>);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue3.promise(<span class="string">'webpack'</span>).then(</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'error'</span>);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	webpack 3</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	cost3: 3007.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理？？</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>AsyncParallelBailHook(异步并行熔断)</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只要监函数的返回值不为null，就会忽略后面的监听函数执行，直跳跃到callAsync等触发函数绑定的回调函数，然后执行这个被绑定的回调函数。</span></span><br><span class="line"><span class="keyword">const</span> queue1 = <span class="keyword">new</span> AsyncParallelBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost'</span>);</span><br><span class="line">queue1.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'wrong'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.callAsync(<span class="string">'webpack'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	cost: 4.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue2 = <span class="keyword">new</span> AsyncParallelBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost1'</span>);</span><br><span class="line">queue2.tapAsync(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'wrong'</span>;</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue2.callAsync(<span class="string">'webpack'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost1'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	webpack 3</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue3 = <span class="keyword">new</span> AsyncParallelBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost3'</span>);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">      reject(<span class="string">'wrong'</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="number">3</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">queue3.promise(<span class="string">'webpack'</span>).then(</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'error'</span>);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">返回</span></span><br><span class="line"><span class="comment">webpack1</span></span><br><span class="line"><span class="comment">webpack2</span></span><br><span class="line"><span class="comment">error</span></span><br><span class="line"><span class="comment">cost3: 2008.xxxms</span></span><br><span class="line"><span class="comment">webpack 3</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>异步串行</p>
<ol>
<li>AsyncSeriesHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不关心callback()的参数</span></span><br><span class="line"><span class="keyword">const</span> queue1 = <span class="keyword">new</span> AsyncSeriesHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost1'</span>);</span><br><span class="line">queue1.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'wrong'</span></span><br><span class="line">&#125;)</span><br><span class="line">queue1.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;)</span><br><span class="line">queue1.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">&#125;)</span><br><span class="line">queue1.callAsync(<span class="string">'zfpx'</span>, err =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost1'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	1</span></span><br><span class="line"><span class="comment">	2</span></span><br><span class="line"><span class="comment">	3</span></span><br><span class="line"><span class="comment">	undefined</span></span><br><span class="line"><span class="comment">	cost1: 3.9xxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue2 = <span class="keyword">new</span> AsyncSeriesHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost2'</span>);</span><br><span class="line">queue2.tapAsync(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">queue2.tapAsync(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">queue2.tapAsync(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name, cb</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name,<span class="number">3</span>);</span><br><span class="line">    cb();</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">queue2.callAsync(<span class="string">'webpack'</span>, err =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost2'</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	webpack 3</span></span><br><span class="line"><span class="comment">	undefined</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	cost2: 6xxx.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue3 = AsyncSeriesHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost3'</span>);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">1</span>)</span><br><span class="line">      resolve()</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">queue3.tapPromise(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">2</span>)</span><br><span class="line">      resolve()</span><br><span class="line">    &#125;, <span class="number">2000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">queue3.tapPromise(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">3</span>)</span><br><span class="line">      resolve()</span><br><span class="line">    &#125;, <span class="number">3000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">queue3.promise(<span class="string">'webpack'</span>).then(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err)</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	webpack 3</span></span><br><span class="line"><span class="comment">	undefined</span></span><br><span class="line"><span class="comment">	cost3: 6xxx.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncSeriesHook1</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks = []</span><br><span class="line">  &#125;</span><br><span class="line">  tapAsync(name, fn) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks.push(fn)</span><br><span class="line">  &#125;</span><br><span class="line">  callAsync() &#123;</span><br><span class="line">    <span class="keyword">let</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">let</span> args = [...arguments];</span><br><span class="line">    <span class="keyword">let</span> done = args.pop();</span><br><span class="line">    <span class="keyword">let</span> idx = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 如果next的参数有值，就直接跳跃到执行callAsync的回调函数</span></span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> done(err);</span><br><span class="line">      <span class="keyword">let</span> fn = self.hooks[idx++];</span><br><span class="line">      fn ? fn(..args, next) : done()</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>AsyncSeriesBailHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// callback()的参数不为null，就会直接执行callAsync等触发函数绑定的回调函数</span></span><br><span class="line"><span class="comment">// tap</span></span><br><span class="line"><span class="keyword">const</span> queue1 = <span class="keyword">new</span> AsyncSeriesBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost1'</span>);</span><br><span class="line">queue1.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'wrong'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.callAsync(<span class="string">'webpack'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost1'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	1</span></span><br><span class="line"><span class="comment">	null</span></span><br><span class="line"><span class="comment">	cost1: 3.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// tapAsync</span></span><br><span class="line"><span class="keyword">const</span> queue2 = <span class="keyword">new</span> AsyncSeriesBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost2'</span>);</span><br><span class="line">queue2.tapAsync(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">    callback();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">    callback(<span class="string">'wrong'</span>);</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">    callback();</span><br><span class="line">  &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.callAsync(<span class="string">'webpack'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost2'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	wrong</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	cost2: 3xxx.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// promise</span></span><br><span class="line"><span class="keyword">const</span> queue3 = <span class="keyword">new</span> AsyncSeriesBailHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost3'</span>);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">2</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(name, <span class="number">3</span>);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.promise(<span class="string">'webpack'</span>).then(</span><br><span class="line">  (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	webpack 2</span></span><br><span class="line"><span class="comment">	undefined</span></span><br><span class="line"><span class="comment">	error</span></span><br><span class="line"><span class="comment">	cost3: 3xxx.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>AsyncSeriesWaterfallHook</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上一个监听函数中的callback(err, data)的第二个参数，可以作为下一个监听函数的参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// tap</span></span><br><span class="line"><span class="keyword">const</span> queue1 = <span class="keyword">new</span> AsyncSeriesWaterfallHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost1'</span>);</span><br><span class="line">queue1.tap(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'aa'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>, data);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'bb'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">queue1.tap(<span class="number">3</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>, data);</span><br><span class="line">&#125;);</span><br><span class="line">queue1.callAsync(<span class="string">'webpack'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost1'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	webpack 1</span></span><br><span class="line"><span class="comment">	2 aa</span></span><br><span class="line"><span class="comment">	3 bb</span></span><br><span class="line"><span class="comment">	null ??</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	cost1: 5.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// tapAsync</span></span><br><span class="line"><span class="keyword">const</span> queue2 = <span class="keyword">new</span> AsyncSeriesWaterfallHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost2'</span>);</span><br><span class="line">queue2.tapAsync(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'1: '</span>, name);</span><br><span class="line">    callback(<span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'2: '</span>, data);</span><br><span class="line">    callback(<span class="literal">null</span>, <span class="number">3</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.tapAsync(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data, callback</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'3: '</span>, data);</span><br><span class="line">    callback(<span class="literal">null</span>, <span class="number">3</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">queue2.callAsync(<span class="string">'webpack'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'over'</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'cost2'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	1: webpack</span></span><br><span class="line"><span class="comment">	2: 2</span></span><br><span class="line"><span class="comment">	3: 3</span></span><br><span class="line"><span class="comment">	null</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	cost2: 6xxx.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// promise</span></span><br><span class="line"><span class="keyword">const</span> queue3 = <span class="keyword">new</span> AsyncSeriesWaterfallHook([<span class="string">'name'</span>]);</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'cost3'</span>);</span><br><span class="line">queue3.tapPromise(<span class="string">'1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'1: '</span>, name);</span><br><span class="line">      resolve(<span class="string">'1'</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'2'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'2: '</span>, name);</span><br><span class="line">      resolve(<span class="string">'2'</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.tapPromise(<span class="string">'3'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'3: '</span>, data);</span><br><span class="line">      resolve(<span class="string">'over'</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">queue3.promise(<span class="string">'webpack'</span>).then(</span><br><span class="line">  (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'cost3'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回</span></span><br><span class="line"><span class="comment">	1: webpack</span></span><br><span class="line"><span class="comment">	2: 1</span></span><br><span class="line"><span class="comment">	3: 2</span></span><br><span class="line"><span class="comment">	over</span></span><br><span class="line"><span class="comment">	cost3: 6xxx.xxxms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原理</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncSeriesWaterfallHook1</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks = [];</span><br><span class="line">  &#125;</span><br><span class="line">  tapAsync(name, fn) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hooks.push(fn);</span><br><span class="line">  &#125;</span><br><span class="line">  callAsync() &#123;</span><br><span class="line">    <span class="keyword">let</span> self = <span class="keyword">this</span>,</span><br><span class="line">      args = [...arguments],</span><br><span class="line">      done = args.pop();</span><br><span class="line">    <span class="built_in">console</span>.log(args);</span><br><span class="line">    <span class="keyword">let</span> idx = <span class="number">0</span>,</span><br><span class="line">      result = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (idx &gt;= self.hooks.length) <span class="keyword">return</span> done();</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> done(err);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> fn = self.hooks[idx++];</span><br><span class="line">      <span class="keyword">if</span> (idx === <span class="number">1</span>) &#123;</span><br><span class="line">        fn(...args, next);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fn(data, next);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TODO: 几个 hooks 的发布订阅原理</p>
<p><a href="https://juejin.im/post/6844903573675835400" target="_blank" rel="noopener">详解</a></p>
<h3 id="webpack-compiler"><a href="#webpack-compiler" class="headerlink" title="webpack compiler"></a>webpack compiler</h3><p>webpack 的入口文件其实就实例了 Compiler 并调用了 run 方法进行了编译，webpack 的编译都按照如下钩子调用顺序执行。</p>
<ul>
<li>before-run 清楚缓存</li>
<li>run 注册缓存数据钩子</li>
<li>before-compile</li>
<li>compile 开始编译</li>
<li>make 从入口分析依赖以及间接依赖模块，创建模块对象</li>
<li>build-module 模块构建</li>
<li>seal 构建结果封装，不可再更改</li>
<li>after-compile 完成构建、缓存数据</li>
<li>emit 输出到 dist 目录</li>
</ul>
<h3 id="webpack-compilation"><a href="#webpack-compilation" class="headerlink" title="webpack compilation"></a>webpack compilation</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2019/09/07/webpack相关/" data-id="ckonxgfak000d78yzzw3x2tt0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/webpack/">webpack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-类型与语法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2019/09/03/类型与语法/" class="article-date">
  <time datetime="2019-09-03T15:02:14.000Z" itemprop="datePublished">2019-09-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2019/09/03/类型与语法/">类型与语法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>类型、值</strong></p>
<ol>
<li><p>特别大和特别小的数字默认指数格式显示， 与toExponential() 的输出结果相同。</p>
</li>
<li><p>toPrecision()方法用来指定有效数位的显示位数。</p>
</li>
<li><p>数字的toFixed()可行写法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(42).toFixed(3); // &apos;42.000&apos;</span><br><span class="line">0.42.toFixed(3); // &apos;0.420&apos;</span><br><span class="line">42..toFixed(3); // &apos;42.000&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>不是数字的数字 NaN(typeof NaN === ‘number’)</p>
</li>
<li><p>加法和减法不会得到负零(-0);乘除可以</p>
</li>
<li><p>特殊等式。可用ES6 Object.is(…)来判断两值是否绝对相等。建议能用 == 或 === 就用。</p>
</li>
</ol>
<p><strong>原生函数</strong></p>
<ol>
<li><p>所有typeof返回值为”object”的对象都包含一个内部属性[[Class]], 这个属性无法直接访问, 一般通过Object.prototype.toString()来查看。</p>
</li>
<li><p>拆封对象， 使用valueOf()。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var a = new String(&apos;abc&apos;);</span><br><span class="line">var b = new Number(42);</span><br><span class="line">var c = new Boolean(true);</span><br><span class="line"></span><br><span class="line">a.valueOf(); // &apos;abc&apos;</span><br><span class="line">b.valueOf(); // 42</span><br><span class="line">c.valueOf(); // true</span><br></pre></td></tr></table></figure>
</li>
<li><p>包含至少一个”空单元”的数组称为”稀疏数组”。</p>
</li>
<li><p>~x 大致等同于 ~(x + 1).</p>
</li>
<li><p>-1哨位值， 联想string.indexOf()</p>
</li>
<li><p>抽象渗漏: 代码中暴露了底层的实现细节。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var a = &apos;Hello World&apos;;</span><br><span class="line">~a.indexOf(&apos;lo&apos;); // -4 真值</span><br><span class="line">if(~a.indexOf(&apos;lo&apos;))&#123;&#125; // true</span><br><span class="line">~a.indexOf(&apos;ol&apos;) // 假值</span><br><span class="line">!~a.indexOf(&apos;ol&apos;) // true</span><br><span class="line">if(!~a.indexOf(&apos;ol&apos;)) &#123;&#125; // true</span><br><span class="line">// 如果indexOf(...)返回-1, ~将其转换为假值0, 其他情况一律转化为真值。</span><br></pre></td></tr></table></figure>
</li>
<li><p>字位截除 <del>同Math.floor(), 第一个</del>执行ToInt32并反转字位, 然后第二个再进行一次字位反转, 即将所有字位反转回原值, 最后得到的仍是ToInt32的结果。</p>
</li>
<li><p>[] + {} // “[object Object]”  {} + [] // 0</p>
</li>
<li><p>== 与 === 都会检查操作数类型， 区别在于操作数类型不同时它们的处理方式不同。不用考虑性能。</p>
</li>
<li><p>链式赋值如果未对声明， 就不会对其赋值。</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2019/09/03/类型与语法/" data-id="ckonxgfat000n78yzrznzqbut" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/中卷-类型-值/">中卷 类型 值</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-对象" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2019/07/29/对象/" class="article-date">
  <time datetime="2019-07-29T15:19:24.000Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2019/07/29/对象/">对象</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="1-忽视点"><a href="#1-忽视点" class="headerlink" title="1.忽视点"></a>1.忽视点</h4><h5 id="1-1-原话：-简单基本类型-string-boolean-number-null-undefined-本身并不是对象，-null-有时会被当做一种对象类型，-但是这其实只是语言本身的一个-bug，-即对-null-执行-typeof-会返回字符串’object’。实际上，-null-本身是基本类型。"><a href="#1-1-原话：-简单基本类型-string-boolean-number-null-undefined-本身并不是对象，-null-有时会被当做一种对象类型，-但是这其实只是语言本身的一个-bug，-即对-null-执行-typeof-会返回字符串’object’。实际上，-null-本身是基本类型。" class="headerlink" title="1.1 原话： 简单基本类型(string, boolean, number, null, undefined)本身并不是对象， null 有时会被当做一种对象类型， 但是这其实只是语言本身的一个 bug， 即对 null 执行 typeof 会返回字符串’object’。实际上， null 本身是基本类型。"></a>1.1 原话： 简单基本类型(string, boolean, number, null, undefined)本身并不是对象， null 有时会被当做一种对象类型， 但是这其实只是语言本身的一个 bug， 即对 null 执行 typeof 会返回字符串’object’。实际上， null 本身是基本类型。</h5><h5 id="1-2-1-内置对象"><a href="#1-2-1-内置对象" class="headerlink" title="1.2.1 内置对象"></a>1.2.1 内置对象</h5><h6 id="String-Number-Boolean-Object-Function-Array-Date-RegExp-Error"><a href="#String-Number-Boolean-Object-Function-Array-Date-RegExp-Error" class="headerlink" title="String Number Boolean Object Function Array Date RegExp Error"></a>String Number Boolean Object Function Array Date RegExp Error</h6><p>instanceof typeof Object.prototype.toString.call(xxx) 可以判断类型</p>
<h5 id="1-2-2-对象的属性描述符"><a href="#1-2-2-对象的属性描述符" class="headerlink" title="1.2.2 对象的属性描述符"></a>1.2.2 对象的属性描述符</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var obj = &#123;name: &apos;aaa&apos;&#125;;</span><br><span class="line"></span><br><span class="line">Object.getOwnPropertyDescriptor(obj, &quot;name&quot;);</span><br><span class="line"></span><br><span class="line">// &#123;</span><br><span class="line">//     value: &apos;aaa&apos;,</span><br><span class="line">//     writable: true,</span><br><span class="line">//     enumerable: true,</span><br><span class="line">//     configurable: true</span><br><span class="line">// &#125;</span><br></pre></td></tr></table></figure>

<p>writable 决定是否可以修改属性值<br>configurable 为 true， 可用 Object.defineProperty 来修改属性描述符<br>enumerable 是否可枚举，影响对象 for…in 循环</p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var obj = &#123;</span><br><span class="line">    a: 2,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">console.log(&apos;a&apos; in obj); // true</span><br><span class="line">console.log(&apos;b&apos; in obj); // false</span><br><span class="line"></span><br><span class="line">console.log(obj.hasOwnProperty(a)) // true</span><br><span class="line">console.log(obj.hasOwnProperty(b)) // false</span><br><span class="line"></span><br><span class="line">// in 会检查属性是否在对象或原型链上， hasOwnProperty检查属性是否在当前对象上</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">var myArray = [ 1, 2, 3 ];</span><br><span class="line">var it = myArray[Symbol.iterator]();</span><br><span class="line">it.next(); // &#123; value:1, done:false &#125;</span><br><span class="line">it.next(); // &#123; value:2, done:false &#125;</span><br><span class="line">it.next(); // &#123; value:3, done:false &#125;</span><br><span class="line">it.next(); // &#123; done:true &#125;</span><br><span class="line"></span><br><span class="line">// 数组内部有@@iterator属性， 可以进行es6的for...of遍历</span><br><span class="line"></span><br><span class="line">// 可以给予想遍历的对象添加@@iterator属性</span><br><span class="line"></span><br><span class="line">var obj = &#123;</span><br><span class="line">    a: 2,</span><br><span class="line">    b: 3</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Object.defineProperty(obj, Symbol.iterator, &#123;</span><br><span class="line">    enumerable: false,</span><br><span class="line">    writable: false,</span><br><span class="line">    configurable: true,</span><br><span class="line">    value: function() &#123;</span><br><span class="line">        var o = this;</span><br><span class="line">        var idx = 0;</span><br><span class="line">        var ks = Object.keys(o);</span><br><span class="line">        return &#123;</span><br><span class="line">            next: function() &#123;</span><br><span class="line">                return &#123;</span><br><span class="line">                    value: o[ks[idx]],</span><br><span class="line">                    done: idx &gt; ks.length</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">var it = obj[Symbol.iterator](); </span><br><span class="line">it.next(); // &#123; value:2, done:false &#125; </span><br><span class="line">it.next(); // &#123; value:3, done:false &#125; </span><br><span class="line">it.next(); // &#123; value:undefined, done:true &#125;</span><br><span class="line">// 用 for..of 遍历 obj </span><br><span class="line">for (var v of obj) &#123; </span><br><span class="line">    console.log( v );</span><br><span class="line">&#125;</span><br><span class="line">// 2 // 3</span><br></pre></td></tr></table></figure>

<h5 id="1-2-3-属性设置和屏蔽"><a href="#1-2-3-属性设置和屏蔽" class="headerlink" title="1.2.3 属性设置和屏蔽"></a>1.2.3 属性设置和屏蔽</h5><p>如果 foo 不直接存在于 myObject 中而是存在于原型链上层时 myObject.foo = “bar” 会出现的三种情况。</p>
<ol>
<li>如果在[[Prototype]]链上层存在名为foo的普通数据访问属性(参见第3章)并且没有被标记为只读(writable:false)，那就会直接在 myObject 中添加一个名为 foo 的新 属性，它是屏蔽属性。</li>
<li>如果在[[Prototype]]链上层存在foo，但是它被标记为只读(writable:false)，那么 无法修改已有属性或者在 myObject 上创建屏蔽属性。如果运行在严格模式下，代码会 抛出一个错误。否则，这条赋值语句会被忽略。总之，不会发生屏蔽。</li>
<li>如果在[[Prototype]]链上层存在foo并且它是一个setter(参见第3章)，那就一定会 调用这个 setter。foo 不会被添加到(或者说屏蔽于)myObject，也不会重新定义 foo 这 个 setter。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2019/07/29/对象/" data-id="ckonxgfam000g78yz92nqh1jd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/上卷-对象/">上卷 对象</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-作用域和闭包" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2019/07/14/作用域和闭包/" class="article-date">
  <time datetime="2019-07-14T15:05:28.000Z" itemprop="datePublished">2019-07-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2019/07/14/作用域和闭包/">读读 作用域和闭包</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="1-作用域是啥玩意"><a href="#1-作用域是啥玩意" class="headerlink" title="1.作用域是啥玩意"></a>1.作用域是啥玩意</h4><h5 id="开始你的表演"><a href="#开始你的表演" class="headerlink" title="开始你的表演"></a>开始你的表演</h5><hr>
<h6 id="1）js编译原理-分词-语法分析-gt-解析-语法分析-gt-代码生成"><a href="#1）js编译原理-分词-语法分析-gt-解析-语法分析-gt-代码生成" class="headerlink" title="1）js编译原理 分词/语法分析 =&gt; 解析/语法分析 =&gt; 代码生成"></a>1）js编译原理 分词/语法分析 =&gt; 解析/语法分析 =&gt; 代码生成</h6><h5 id="分词词法分析，就是将语句分解成一块一块的，好好的-var-a-2-变成了-var、-a、-、-2、-做完这一步，-就到了解析-语法分析环节，这就要将词法单元流，转化成抽象语法树（AST），最后一步就是将这个树转换为可执行代码。"><a href="#分词词法分析，就是将语句分解成一块一块的，好好的-var-a-2-变成了-var、-a、-、-2、-做完这一步，-就到了解析-语法分析环节，这就要将词法单元流，转化成抽象语法树（AST），最后一步就是将这个树转换为可执行代码。" class="headerlink" title="分词词法分析，就是将语句分解成一块一块的，好好的 var a = 2;变成了 var、 a、 =、 2、 ;, 做完这一步， 就到了解析/语法分析环节，这就要将词法单元流，转化成抽象语法树（AST），最后一步就是将这个树转换为可执行代码。"></a>分词词法分析，就是将语句分解成一块一块的，好好的 <code>var a = 2;</code>变成了 <code>var、 a、 =、 2、 ;</code>, 做完这一步， 就到了解析/语法分析环节，这就要将<strong>词法单元流</strong>，转化成<strong>抽象语法树（AST）</strong>，最后一步就是将这个树转换为可执行代码。</h5><p>个人BB:<br>1.凡是这种树状结构的，类似vdom， 小程序的richText，都是一种中间层的转换，转换完之后再进行特定编译，这个中间商好像不赚差价。(*￣rǒ￣)<br>2.github有个<a href="https://github.com/benjamn/recast">recast库</a>，就是完成上述操作的，对于了解原理还是很好的，有机会再看 = =。</p>
<h6 id="2）变量赋值操作-当前作用域声明一个变量-gt-运行时在作用域中查找该变量-gt-找到赋值。-很简单，-这时候引入一个LHS-左查-与RHS-右查-的概念。"><a href="#2）变量赋值操作-当前作用域声明一个变量-gt-运行时在作用域中查找该变量-gt-找到赋值。-很简单，-这时候引入一个LHS-左查-与RHS-右查-的概念。" class="headerlink" title="2）变量赋值操作: 当前作用域声明一个变量 =&gt; 运行时在作用域中查找该变量 =&gt; 找到赋值。 很简单， 这时候引入一个LHS(左查)与RHS(右查)的概念。"></a>2）变量赋值操作: 当前作用域声明一个变量 =&gt; 运行时在作用域中查找该变量 =&gt; 找到赋值。 很简单， 这时候引入一个LHS(左查)与RHS(右查)的概念。</h6><p>左查，变量出现在赋值操作左侧；右查反之。<br>直接拿书里的例子来说</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function foo(a) &#123;</span><br><span class="line">    var b = a;</span><br><span class="line">    return a + b;</span><br><span class="line">&#125;</span><br><span class="line">var c = foo(2)</span><br><span class="line">// LHS: c = .. ;、 a = 2、 b = ..</span><br><span class="line">// RHS: foo(2.. 、 = 2 、 a.. 、 b..</span><br></pre></td></tr></table></figure>

<p>非严格模式下<br>左查失败时候，隐式创建全局变量<br>右查失败时候，抛出异常 referenceError, eg. xxx is not undefined</p>
<h6 id="3）-作用域嵌套-一个块或者函数嵌套在另一个块或者函数中。"><a href="#3）-作用域嵌套-一个块或者函数嵌套在另一个块或者函数中。" class="headerlink" title="3） 作用域嵌套: 一个块或者函数嵌套在另一个块或者函数中。"></a>3） 作用域嵌套: 一个块或者函数嵌套在另一个块或者函数中。</h6><p>想象成一个大建筑(全局)立面的n多小房间(局部块级作用域)。</p>
<h4 id="2-词法作用域"><a href="#2-词法作用域" class="headerlink" title="2.词法作用域"></a>2.词法作用域</h4><h5 id="1）上码分析起来"><a href="#1）上码分析起来" class="headerlink" title="1）上码分析起来"></a>1）上码分析起来</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function foo(a) &#123;</span><br><span class="line">    var b = a * 2;</span><br><span class="line">    </span><br><span class="line">    function bar(c) &#123;</span><br><span class="line">        console.log(a, b, c)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bar(b * 3)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo(2); // 2, 4, 12</span><br></pre></td></tr></table></figure>

<p>由最内部函数开始找变量，里面找不到找外面， a找到最外面2， b在bar外部foo内部， 找到赋值4， c为入参， 4*3赋值12.</p>
<p><strong>注意事项： 作用域查找会在找到第一个匹配的标识符停止。 学名”遮蔽效应”。</strong></p>
<h5 id="2）欺骗词法-eval-with-运行时创建新的词法作用域"><a href="#2）欺骗词法-eval-with-运行时创建新的词法作用域" class="headerlink" title="2）欺骗词法 eval with 运行时创建新的词法作用域"></a>2）欺骗词法 eval with 运行时创建新的词法作用域</h5><p>eval内部可执行代码，借此改变已存在的词法作用域。<br>with通过将一个对象的引用当做作用域来处理， 将对象属性当做作用域中的标识符处理，从而创建了一个新的词法作用域。</p>
<p>eg.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function foo(str, a) &#123;</span><br><span class="line">    eval(str);</span><br><span class="line">    console.log(a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var b = 2;</span><br><span class="line"></span><br><span class="line">foo(&quot;var b = 3;&quot;, 1); // 1, 3</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function foo(obj) &#123;</span><br><span class="line">    with(obj) &#123;</span><br><span class="line">        a = 2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var o1 = &#123;</span><br><span class="line">    a: 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var o2 = &#123;</span><br><span class="line">    b: 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo(o1);</span><br><span class="line">console.log(o1.a); // 2</span><br><span class="line"></span><br><span class="line">foo(o2);</span><br><span class="line">console.log(o2.a); // undefined</span><br><span class="line">console.log(a); // 2 a泄露到了全局作用域上</span><br><span class="line"></span><br><span class="line">// 原因： with可以将一个没有或有多个属性的对象处理为一个完全隔离的词法作用域。 没有o2.a，就创建一个a并且赋值2。</span><br></pre></td></tr></table></figure>

<hr>
<h6 id="let块变形"><a href="#let块变形" class="headerlink" title="let块变形"></a>let块变形</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">var foo = true;</span><br><span class="line"></span><br><span class="line">if(foo) &#123;</span><br><span class="line">    let bar = foo * 2;</span><br><span class="line">    bar = something(bar);</span><br><span class="line">    console.log(bar);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">console.log(bar); // ReferenceError</span><br><span class="line"></span><br><span class="line">// if语句同下面</span><br><span class="line"></span><br><span class="line">if(foo) &#123;</span><br><span class="line">    // let的作用</span><br><span class="line">    &#123;</span><br><span class="line">        let bar = foo * 2;</span><br><span class="line">        bar = something(bar);</span><br><span class="line">        console.log(bar)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">console.log(bar); // ReferenceError</span><br></pre></td></tr></table></figure>

<hr>
<h6 id="let-循环"><a href="#let-循环" class="headerlink" title="let 循环"></a>let 循环</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">for(let i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">    console.log(i) // 0-9 每次迭代重新绑定</span><br><span class="line">&#125;</span><br><span class="line">console.log(i) // ReferenceError</span><br><span class="line"></span><br><span class="line">// 等同于</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    let j;</span><br><span class="line">    for(j = 0; j &lt; 10; j++) &#123;</span><br><span class="line">        let i = j;</span><br><span class="line">        console.log(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="提升-先声明，后赋值"><a href="#提升-先声明，后赋值" class="headerlink" title="提升 (先声明，后赋值)"></a>提升 (先声明，后赋值)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">foo(); // 1</span><br><span class="line"></span><br><span class="line">var foo;</span><br><span class="line"></span><br><span class="line">function foo() &#123;</span><br><span class="line">    console.log(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo = function() &#123;</span><br><span class="line">    console.log(2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 加了打印成3了</span><br><span class="line">// function foo() &#123;</span><br><span class="line">//    console.log(3)</span><br><span class="line">// &#125;</span><br><span class="line"></span><br><span class="line">// 变量提升， 函数优先， 后写同名函数声明可以覆盖之前。</span><br></pre></td></tr></table></figure>

<p><strong>总而言之， 无论作用域中的声明出现在什么地方， 都将在代码本身被执行前首先进行处理。 可以将这个过程形象地想象成所有的声明(变量和函数)都会被移动到各自作用域的最顶端， 这个过程叫做提升。</strong></p>
<hr>
<h5 id="作用域闭包"><a href="#作用域闭包" class="headerlink" title="作用域闭包"></a>作用域闭包</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function foo() &#123;</span><br><span class="line">    var a = 2;</span><br><span class="line"></span><br><span class="line">    function bar() &#123;</span><br><span class="line">        console.log(a);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return bar;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var baz = foo();</span><br><span class="line"></span><br><span class="line">baz(); // 2</span><br></pre></td></tr></table></figure>

<p><strong>无论通过何种手段将内部函数传递到所在的词法作用域以外， 它都会持有对原始定义作用域的引用， 无论在何处执行这个函数都会使用闭包。</strong><br><strong>函数嵌套函数， 叫做闭包。官方一点， 内部函数传递到了其所在的词法作用域之外，叫做闭包。</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2019/07/14/作用域和闭包/" data-id="ckonxgfaf000878yz5j9s9k4x" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/上卷-作用域和闭包/">上卷 作用域和闭包</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-this和原型对象" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2019/07/14/this和原型对象/" class="article-date">
  <time datetime="2019-07-14T15:04:14.000Z" itemprop="datePublished">2019-07-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2019/07/14/this和原型对象/">读读 this和原型对象</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="1-this和原型对象"><a href="#1-this和原型对象" class="headerlink" title="1.this和原型对象"></a>1.this和原型对象</h4><h5 id="开始你的表演"><a href="#开始你的表演" class="headerlink" title="开始你的表演"></a>开始你的表演</h5><hr>
<h5 id="1-this-概念一波"><a href="#1-this-概念一波" class="headerlink" title="1) this 概念一波"></a>1) this 概念一波</h5><p>this是在<strong>运行时绑定</strong>， 而非编写时绑定， 它的上下文取决于函数作用时的各种条件。this的绑定和函数声明的位置没有任何关系， 只取决于函数的调用方式。</p>
<p>当一个函数被调用时， 会创建一个活动记录， 包含函数调用栈， 调用方式， 传入的参数等信息。</p>
<h5 id="2）-this-绑定规则"><a href="#2）-this-绑定规则" class="headerlink" title="2） this 绑定规则"></a>2） this 绑定规则</h5><h6 id="2-1-默认绑定-就是一般的绑定规则-非严格模式下，-默认绑定到全局对象。"><a href="#2-1-默认绑定-就是一般的绑定规则-非严格模式下，-默认绑定到全局对象。" class="headerlink" title="2.1 默认绑定 就是一般的绑定规则 非严格模式下， 默认绑定到全局对象。"></a>2.1 默认绑定 就是一般的绑定规则 非严格模式下， 默认绑定到全局对象。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function foo() &#123;</span><br><span class="line">    console.log(this.a);</span><br><span class="line">&#125;</span><br><span class="line">var a = 2;</span><br><span class="line">foo(); // 2</span><br></pre></td></tr></table></figure>

<h5 id="2-2-隐式绑定"><a href="#2-2-隐式绑定" class="headerlink" title="2.2 隐式绑定"></a>2.2 隐式绑定</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function foo() &#123;</span><br><span class="line">    console.log(this.a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var obj = &#123;</span><br><span class="line">    a: 2,</span><br><span class="line">    foo: foo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">obj.foo(); // 2</span><br><span class="line">// 隐式绑定规则会把函数调用中的this绑定到这个上下文对象。</span><br></pre></td></tr></table></figure>

<hr>
<p>隐式丢失， 其实就是this上下文改变了， 随让this是谁调用就指向谁呢= =。<br>eg.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function foo() &#123;</span><br><span class="line">    console.log(this.a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function doFoo(fn) &#123;</span><br><span class="line">    fn()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var obj = &#123;</span><br><span class="line">    a: 2,</span><br><span class="line">    foo: foo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var a = &apos;asdasd&apos;;</span><br><span class="line"></span><br><span class="line">doFoo(obj.foo); // asdasd</span><br></pre></td></tr></table></figure>

<h5 id="2-3-显示绑定-直接指定this的绑定对象，-即call、apply"><a href="#2-3-显示绑定-直接指定this的绑定对象，-即call、apply" class="headerlink" title="2.3 显示绑定  直接指定this的绑定对象， 即call、apply"></a>2.3 显示绑定  直接指定this的绑定对象， 即call、apply</h5><h6 id="2-3-1-硬绑定"><a href="#2-3-1-硬绑定" class="headerlink" title="2.3.1 硬绑定"></a>2.3.1 硬绑定</h6><p>典型应用场景： 创建一个包裹函数， 负责接收参数并返回值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function foo(something) &#123;</span><br><span class="line">    console.log(this.a, something);</span><br><span class="line">    return this.a + something</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var obj = &#123;</span><br><span class="line">    a: 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var bar = function() &#123;</span><br><span class="line">    return foo.apply(obj, arguments)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var b = bar(3); // 2 3</span><br><span class="line">console.log(b); // 5</span><br></pre></td></tr></table></figure>

<p>另 bind</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">function foo(something) &#123;</span><br><span class="line">    console.log(this.a, something);</span><br><span class="line">    return this.a + something</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function bind(fn, obj) &#123;</span><br><span class="line">    return function() &#123;</span><br><span class="line">        return fn.apply(obj, arguments);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var obj = &#123;</span><br><span class="line">    a: 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var bar = bind(foo, obj);</span><br><span class="line"></span><br><span class="line">var b = bar(3); // 2 3</span><br><span class="line">console.log(b); // 5</span><br></pre></td></tr></table></figure>

<h5 id="2-4-new绑定"><a href="#2-4-new绑定" class="headerlink" title="2.4 new绑定"></a>2.4 new绑定</h5><p>回顾一波new干了些啥<br>1.创建一个全新的对象<br>2.这个新对象会被执行[[Prototype]]连接<br>3.这个新对象会绑定到函数调用的this<br>4.如果函数没有返回其他对象， 那么new表达式中的函数调用会自动返回这个新对象。</p>
<h5 id="2-5-软绑定"><a href="#2-5-软绑定" class="headerlink" title="2.5 软绑定"></a>2.5 软绑定</h5><h2 id="硬绑定会降低函数灵活性，-使用硬绑定之后无法使用隐式绑定或显示绑定修改this，如果可以给默认绑定指定一个全局对象和undefined以外的值，-可以实现相同效果，-同时保留隐式绑定或显示绑定修改this的能力。"><a href="#硬绑定会降低函数灵活性，-使用硬绑定之后无法使用隐式绑定或显示绑定修改this，如果可以给默认绑定指定一个全局对象和undefined以外的值，-可以实现相同效果，-同时保留隐式绑定或显示绑定修改this的能力。" class="headerlink" title="硬绑定会降低函数灵活性， 使用硬绑定之后无法使用隐式绑定或显示绑定修改this，如果可以给默认绑定指定一个全局对象和undefined以外的值， 可以实现相同效果， 同时保留隐式绑定或显示绑定修改this的能力。"></a>硬绑定会降低函数灵活性， 使用硬绑定之后无法使用隐式绑定或显示绑定修改this，<strong>如果可以给默认绑定指定一个全局对象和undefined以外的值</strong>， 可以实现相同效果， 同时保留隐式绑定或显示绑定修改this的能力。</h2><p>上代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">if(!Function.prototype.softBind) &#123;</span><br><span class="line">    Function.prototype.softBind = function(obj) &#123;</span><br><span class="line">        var fn = this;</span><br><span class="line">        var curried = [].slice.call(arguments, 1);</span><br><span class="line">        var bound = function() &#123;</span><br><span class="line">            return fn.apply(</span><br><span class="line">                (!this || this === (window || global)) ?</span><br><span class="line">                obj : this,</span><br><span class="line">                curried.concat.apply(curried, arguments)</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        bound.prototype = Object.create(fn.prototype);</span><br><span class="line">        return bound;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 没看懂， 先放着。。。</span><br><span class="line">// 使用</span><br><span class="line"></span><br><span class="line">function foo() &#123;</span><br><span class="line">    console.log(&quot;name&quot; + this.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var obj = &#123;name: &apos;obj&apos;&#125;, obj2 = &#123;name: &apos;obj2&apos;&#125;, obj3 = &#123;name: &apos;obj3&apos;&#125;;</span><br><span class="line"></span><br><span class="line">var fooObj = foo.softBind(obj);</span><br><span class="line"></span><br><span class="line">fooObj(); // obj</span><br><span class="line"></span><br><span class="line">obj2.foo = foo.softBind(obj);</span><br><span class="line">obj2.foo(); // obj2</span><br><span class="line"></span><br><span class="line">fooObj.call(obj3); // obj3</span><br><span class="line"></span><br><span class="line">setTimeout(obj.foo, 10); // obj</span><br></pre></td></tr></table></figure>

<p>晚点消化。。。mark</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2019/07/14/this和原型对象/" data-id="ckonxgfad000578yzsb4vzb0q" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/上卷-this-原型对象/">上卷 this 原型对象</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-读读-我不知道的JavaScript" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2019/07/14/读读-我不知道的JavaScript/" class="article-date">
  <time datetime="2019-07-14T10:41:37.000Z" itemprop="datePublished">2019-07-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2019/07/14/读读-我不知道的JavaScript/">读读 我不知道的JavaScript</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="先拿我不知道js试试水-o-≧▽≦-ツ┏━┓"><a href="#先拿我不知道js试试水-o-≧▽≦-ツ┏━┓" class="headerlink" title="先拿我不知道js试试水 o(*≧▽≦)ツ┏━┓"></a>先拿我不知道js试试水 o(*≧▽≦)ツ┏━┓</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2019/07/14/读读-我不知道的JavaScript/" data-id="ckonxgfav000r78yz6nigthqr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/你不知道的JavaScript/">你不知道的JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-post-title-with-whitespace" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2019/07/14/post-title-with-whitespace/" class="article-date">
  <time datetime="2019-07-14T10:02:46.000Z" itemprop="datePublished">2019-07-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2019/07/14/post-title-with-whitespace/">序</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/wangqinyong1994/blog/2019/07/14/post-title-with-whitespace/" data-id="ckonxgfac000478yzgkxl0tg2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/序/">序</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/blog/">&laquo; Prev</a><a class="page-number" href="/blog/">1</a><span class="page-number current">2</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Chrome/">Chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/React/">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/qiankun-微前端-umi/">qiankun 微前端 umi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/vscode-eslint-prettier/">vscode eslint prettier</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/webpack/">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/上卷-this-原型对象/">上卷 this 原型对象</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/上卷-作用域和闭包/">上卷 作用域和闭包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/上卷-对象/">上卷 对象</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/中卷-异步与性能/">中卷 异步与性能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/中卷-类型-值/">中卷 类型 值</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/你不知道的JavaScript/">你不知道的JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/前端-工程化-npm/">前端 工程化 npm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/前端-设计模式/">前端 设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/单点登录-SSO/">单点登录 SSO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/序/">序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/测试/">测试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/blog/tags/Java/" style="font-size: 20px;">Java</a> <a href="/blog/tags/React/" style="font-size: 10px;">React</a> <a href="/blog/tags/qiankun-微前端-umi/" style="font-size: 10px;">qiankun 微前端 umi</a> <a href="/blog/tags/vscode-eslint-prettier/" style="font-size: 10px;">vscode eslint prettier</a> <a href="/blog/tags/webpack/" style="font-size: 10px;">webpack</a> <a href="/blog/tags/上卷-this-原型对象/" style="font-size: 10px;">上卷 this 原型对象</a> <a href="/blog/tags/上卷-作用域和闭包/" style="font-size: 10px;">上卷 作用域和闭包</a> <a href="/blog/tags/上卷-对象/" style="font-size: 10px;">上卷 对象</a> <a href="/blog/tags/中卷-异步与性能/" style="font-size: 10px;">中卷 异步与性能</a> <a href="/blog/tags/中卷-类型-值/" style="font-size: 10px;">中卷 类型 值</a> <a href="/blog/tags/你不知道的JavaScript/" style="font-size: 10px;">你不知道的JavaScript</a> <a href="/blog/tags/前端-工程化-npm/" style="font-size: 10px;">前端 工程化 npm</a> <a href="/blog/tags/前端-设计模式/" style="font-size: 10px;">前端 设计模式</a> <a href="/blog/tags/单点登录-SSO/" style="font-size: 10px;">单点登录 SSO</a> <a href="/blog/tags/序/" style="font-size: 10px;">序</a> <a href="/blog/tags/测试/" style="font-size: 10px;">测试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/07/">July 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2021/03/26/测试相关/">测试相关</a>
          </li>
        
          <li>
            <a href="/blog/2021/03/24/headless-chrome/">headless chrome</a>
          </li>
        
          <li>
            <a href="/blog/2021/03/24/java高级/">Java高级</a>
          </li>
        
          <li>
            <a href="/blog/2021/02/03/SSO实践/">SSO实践</a>
          </li>
        
          <li>
            <a href="/blog/2021/02/03/微前端实践/">微前端实践</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 WangQinyong<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>



  </div>
</body>
</html>